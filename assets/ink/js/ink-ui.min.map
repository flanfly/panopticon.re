 * @param {Boolean}    [blur]   If false, forces hiding even if the component is shy.\n         */\n        _hide: function(blur) {\n            blur = blur === undefined ? true : blur;\n            if (blur === false || (blur && this._options.shy)) {\n                Css.addClassName(this._containerObject, 'hide-all');\n            }\n        },\n\n        /**\n         * Sets the range of dates allowed to be selected in the Date Picker\n         *\n         * @method _setMinMax\n         * @param {String} dateRange Two dates separated by a ':'. Example: 2013-01-01:2013-12-12\n         * @private\n         */\n        _setMinMax: function( dateRange ) {\n            var self = this;\n\n            var noMinLimit = {\n                _year: -Number.MAX_VALUE,\n                _month: 0,\n                _day: 1\n            };\n\n            var noMaxLimit = {\n                _year: Number.MAX_VALUE,\n                _month: 11,\n                _day: 31\n            };\n\n            function noLimits() {\n                self._min = noMinLimit;\n                self._max = noMaxLimit;\n            }\n\n            if (!dateRange) { return noLimits(); }\n\n            var dates = dateRange.split( ':' );\n            var rDate = /^(\\d{4})((\\-)(\\d{1,2})((\\-)(\\d{1,2}))?)?$/;\n\n            InkArray.each([\n                        {name: '_min', date: dates[0], noLim: noMinLimit},\n                        {name: '_max', date: dates[1], noLim: noMaxLimit}\n                    ], Ink.bind(function (data) {\n\n                var lim = data.noLim;\n\n                if ( data.date.toUpperCase() === 'NOW' ) {\n                    var now = new Date();\n                    lim = dateishFromDate(now);\n                } else if (data.date.toUpperCase() === 'EVER') {\n                    lim = data.noLim;\n                } else if ( rDate.test( data.date ) ) {\n                    lim = dateishFromYMDString(data.date);\n\n                    lim._month = clamp(lim._month, 0, 11);\n                    lim._day = clamp(lim._day, 1, this._daysInMonth( lim._year, lim._month + 1 ));\n                }\n\n                this[data.name] = lim;\n            }, this));\n\n            // Should be equal, or min should be smaller\n            var valid = this._dateCmp(this._max, this._min) !== -1;\n\n            if (!valid) {\n                noLimits();\n            }\n        },\n\n        /**\n         * Checks if a date is between the valid range.\n         * Starts by checking if the date passed is valid. If not, will fallback to the 'today' date.\n         * Then checks if the all params are inside of the date range specified. If not, it will fallback to the nearest valid date (either Min or Max).\n         *\n         * @method _fitDateToRange\n         * @param  {Number} year  Year with 4 digits (yyyy)\n         * @param  {Number} month Month\n         * @param  {Number} day   Day\n         * @return {Array}       Array with the final processed date.\n         * @private\n         */\n        _fitDateToRange: function( date ) {\n            if ( !this._isValidDate( date ) ) {\n                date = dateishFromDate(new Date());\n            }\n\n            if (this._dateCmp(date, this._min) === -1) {\n                return Ink.extendObj({}, this._min);\n            } else if (this._dateCmp(date, this._max) === 1) {\n                return Ink.extendObj({}, this._max);\n            }\n\n            return Ink.extendObj({}, date);  // date is okay already, just copy it.\n        },\n\n        /**\n         * Checks whether a date is within the valid date range\n         * @method _dateWithinRange\n         * @param year\n         * @param month\n         * @param day\n         * @return {Boolean}\n         * @private\n         */\n        _dateWithinRange: function (date) {\n            if (!arguments.length) {\n                date = this;\n            }\n\n            return  (!this._dateAboveMax(date) &&\n                    (!this._dateBelowMin(date)));\n        },\n\n        _dateAboveMax: function (date) {\n            return this._dateCmp(date, this._max) === 1;\n        },\n\n        _dateBelowMin: function (date) {\n            return this._dateCmp(date, this._min) === -1;\n        },\n\n        _dateCmp: function (self, oth) {\n            return this._dateCmpUntil(self, oth, '_day');\n        },\n\n        /**\n         * _dateCmp with varied precision. You can compare down to the day field, or, just to the month.\n         * // the following two dates are considered equal because we asked\n         * // _dateCmpUntil to just check up to the years.\n         *\n         * _dateCmpUntil({_year: 2000, _month: 10}, {_year: 2000, _month: 11}, '_year') === 0\n         */\n        _dateCmpUntil: function (self, oth, depth) {\n            var props = ['_year', '_month', '_day'];\n            var i = -1;\n\n            do {\n                i++;\n                if      (self[props[i]] > oth[props[i]]) { return 1; }\n                else if (self[props[i]] < oth[props[i]]) { return -1; }\n            } while (props[i] !== depth &&\n                    self[props[i + 1]] !== undefined && oth[props[i + 1]] !== undefined);\n\n            return 0;\n        },\n\n        /**\n         * Sets the markup in the default view mode (showing the days).\n         * Also disables the previous and next buttons in case they don't meet the range requirements.\n         *\n         * @method _showDefaultView\n         * @private\n         */\n        _showDefaultView: function(){\n            this._yearSelector.style.display = 'none';\n            this._monthSelector.style.display = 'none';\n            this._monthPrev.childNodes[0].className = 'change_month_prev';\n            this._monthNext.childNodes[0].className = 'change_month_next';\n\n            if ( !this._getPrevMonth() ) {\n                this._monthPrev.childNodes[0].className = 'action_inactive';\n            }\n\n            if ( !this._getNextMonth() ) {\n                this._monthNext.childNodes[0].className = 'action_inactive';\n            }\n\n            this._monthContainer.style.display = 'block';\n        },\n\n        /**\n         * Updates the date shown on the datepicker\n         *\n         * @method _updateDate\n         * @private\n         */\n        _updateDate: function(){\n            var dataParsed;\n            if(!this._options.displayInSelect && this._element.value){\n                dataParsed = this._parseDate(this._element.value);\n            } else if (this._options.displayInSelect) {\n                dataParsed = {\n                    _year: this._options.yearField[this._options.yearField.selectedIndex].value,\n                    _month: this._options.monthField[this._options.monthField.selectedIndex].value - 1,\n                    _day: this._options.dayField[this._options.dayField.selectedIndex].value\n                };\n            }\n\n            if (dataParsed) {\n                dataParsed = this._fitDateToRange(dataParsed);\n                this._year = dataParsed._year;\n                this._month = dataParsed._month;\n                this._day = dataParsed._day;\n            }\n            this._setDate();\n            this._updateDescription();\n            this._renderMonth();\n        },\n\n        /**\n         * Updates the date description shown at the top of the datepicker\n         *\n         * EG \"12 de November\"\n         *\n         * @method  _updateDescription\n         * @private\n         */\n        _updateDescription: function(){\n            InkElement.setTextContent(this._monthChanger, this._options.month[this._month + 1]);\n            InkElement.setTextContent(this._ofText, this._options.ofText);\n            InkElement.setTextContent(this._yearChanger, this._year);\n        },\n\n        /**\n         * Renders the year selector view of the datepicker\n         *\n         * @method _showYearSelector\n         * @private\n         */\n        _showYearSelector: function(inc){\n            this._incrementViewingYear(inc);\n\n            var firstYear = this._year - (this._year % 10);\n            var thisYear = firstYear - 1;\n\n            InkElement.setHTML(this._yearSelector, '');\n            var yearUl = InkElement.create('ul');\n            this._yearSelector.appendChild(yearUl);\n\n            if (thisYear > this._min._year) {\n                var prevYearLi = InkElement.create('li');\n\n                prevYearLi.appendChild(InkElement.create('a', {\n                    href: '#year_prev',\n                    className: 'change_year_prev',\n                    setHTML: this._options.prevLinkText\n                }));\n\n                yearUl.appendChild(prevYearLi);\n            } else {\n                yearUl.appendChild(InkElement.create('li', { setHTML: '&nbsp;' }));\n            }\n\n            for (var i=1; i < 11; i++){\n                if (i % 4 === 0){\n                    yearUl = InkElement.create('ul');\n                    this._yearSelector.appendChild(yearUl);\n                }\n\n                thisYear = firstYear + i - 1;\n\n                yearUl.appendChild(this._getYearButton(thisYear));\n            }\n\n            if (thisYear < this._max._year) {\n                var nextYearLi = InkElement.create('li');\n\n                nextYearLi.appendChild(InkElement.create('a', {\n                    href: '#year_next',\n                    className: 'change_year_next',\n                    setHTML: this._options.nextLinkText\n                }));\n\n                yearUl.appendChild(nextYearLi);\n            } else {\n                yearUl.appendChild(InkElement.create('li', { setHTML: '&nbsp;' }));\n            }\n\n            this._monthPrev.childNodes[0].className = 'action_inactive';\n            this._monthNext.childNodes[0].className = 'action_inactive';\n            this._monthSelector.style.display = 'none';\n            this._monthContainer.style.display = 'none';\n            this._yearSelector.style.display = 'block';\n        },\n\n        /**\n         * For the year selector.\n         *\n         * Update this._year, to find the next decade or use nextValidDateFn to find it.\n         */\n        _incrementViewingYear: function (inc) {\n            if (!inc) { return; }\n\n            var year = +this._year + inc*10;\n            year = year - year % 10;\n            if ( year > this._max._year || year + 9 < this._min._year){\n                return;\n            }\n            this._year = +this._year + inc*10;\n        },\n\n        _getYearButton: function (thisYear) {\n            var className = '';\n\n            if (!this._acceptableYear({ _year: thisYear })) {\n                className = 'ink-calendar-off';\n            } else if (thisYear === this._year) {\n                className = 'ink-calendar-on';\n            }\n\n            var li = InkElement.create('li');\n\n            li.appendChild(InkElement.create('a', {\n                href: '#',\n                'data-cal-year': thisYear,\n                className: className,\n                setTextContent: thisYear\n            }));\n\n            return li;\n        },\n\n        /**\n         * Show the month selector (happens when you click a year, or the \"month\" link.\n         * @method _showMonthSelector\n         * @private\n         */\n        _showMonthSelector: function () {\n            this._yearSelector.style.display = 'none';\n            this._monthContainer.style.display = 'none';\n            this._monthPrev.childNodes[0].className = 'action_inactive';\n            this._monthNext.childNodes[0].className = 'action_inactive';\n            this._addMonthClassNames();\n            this._monthSelector.style.display = 'block';\n        },\n\n        /**\n         * This function returns the given date in the dateish format\n         *\n         * @method _parseDate\n         * @param {String} dateStr A date on a string.\n         * @private\n         */\n        _parseDate: function(dateStr){\n            var date = InkDate.set( this._options.format , dateStr );\n            if (date) {\n                return dateishFromDate(date);\n            }\n            return null;\n        },\n\n        /**\n         * Checks if a date is valid\n         *\n         * @method _isValidDate\n         * @param {Dateish} date\n         * @private\n         * @return {Boolean} True if the date is valid, false otherwise\n         */\n        _isValidDate: function(date){\n            var yearRegExp = /^\\d{4}$/;\n            var validOneOrTwo = /^\\d{1,2}$/;\n            return (\n                yearRegExp.test(date._year)     &&\n                validOneOrTwo.test(date._month) &&\n                validOneOrTwo.test(date._day)   &&\n                +date._month + 1 >= 1  &&\n                +date._month + 1 <= 12 &&\n                +date._day       >= 1  &&\n                +date._day       <= this._daysInMonth(date._year, date._month + 1)\n            );\n        },\n\n        /**\n         * Checks if a given date is an valid format.\n         *\n         * @method _isDate\n         * @param {String} format A date format.\n         * @param {String} dateStr A date on a string.\n         * @private\n         * @return {Boolean} True if the given date is valid according to the given format\n         */\n        _isDate: function(format, dateStr){\n            try {\n                if (typeof format === 'undefined'){\n                    return false;\n                }\n                var date = InkDate.set( format , dateStr );\n                if( date && this._isValidDate( dateishFromDate(date) )) {\n                    return true;\n                }\n            } catch (ex) {}\n\n            return false;\n        },\n\n        _acceptableDay: function (date) {\n            return this._acceptableDateComponent(date, 'validDayFn');\n        },\n\n        _acceptableMonth: function (date) {\n            return this._acceptableDateComponent(date, 'validMonthFn');\n        },\n\n        _acceptableYear: function (date) {\n            return this._acceptableDateComponent(date, 'validYearFn');\n        },\n\n        /** DRY base for the above 2 functions */\n        _acceptableDateComponent: function (date, userCb) {\n            if (this._options[userCb]) {\n                return this._callUserCallbackBool(this._options[userCb], date);\n            } else {\n                return this._dateWithinRange(date);\n            }\n        },\n\n        /**\n         * This method returns the date written with the format specified on the options\n         *\n         * @method _writeDateInFormat\n         * @private\n         * @return {String} Returns the current date of the object in the specified format\n         */\n        _writeDateInFormat:function(){\n            return InkDate.get( this._options.format , this.getDate());\n        },\n\n        /**\n         * This method allows the user to set the DatePicker's date on run-time.\n         *\n         * @method setDate\n         * @param {Date|String} dateString A Date object, or date string in yyyy-mm-dd format.\n         * @public\n         */\n        setDate: function( dateString ) {\n            if (dateString && typeof dateString.getDate === 'function') {\n                dateString = [ dateString.getFullYear(),\n                    dateString.getMonth() + 1, dateString.getDate() ].join('-');\n            }\n\n            if ( /\\d{4}-\\d{1,2}-\\d{1,2}/.test( dateString ) ) {\n                var auxDate = dateString.split( '-' );\n                this._year  = +auxDate[ 0 ];\n                this._month = +auxDate[ 1 ] - 1;\n                this._day   = +auxDate[ 2 ];\n            }\n\n            this._setDate( );\n        },\n\n        /**\n         * Gets the currently selected date as a JavaScript date.\n         *\n         * @method getDate\n         */\n        getDate: function () {\n            if (!this._day) {\n                throw 'Ink.UI.DatePicker: Still picking a date. Cannot getDate now!';\n            }\n            return new Date(this._year, this._month, this._day);\n        },\n\n        /**\n         * Sets the chosen date on the target input field\n         *\n         * @method _setDate\n         * @param {DOMElement} objClicked Clicked object inside the DatePicker's calendar.\n         * @private\n         */\n        _setDate : function( objClicked ) {\n            if (objClicked) {\n                var data = InkElement.data(objClicked);\n                this._day = (+data.calDay) || this._day;\n            }\n\n            var dt = this._fitDateToRange(this);\n\n            this._year = dt._year;\n            this._month = dt._month;\n            this._day = dt._day;\n\n            if(!this._options.displayInSelect){\n                this._element.value = this._writeDateInFormat();\n            } else {\n                this._options.dayField.value   = this._day;\n                this._options.monthField.value = this._month + 1;\n                this._options.yearField.value  = this._year;\n            }\n\n            if(this._options.onSetDate) {\n                this._options.onSetDate( this , { date : this.getDate() } );\n            }\n        },\n\n        /**\n         * Makes the necessary work to update the calendar\n         * when choosing a different month\n         *\n         * @method _updateCal\n         * @param {Number} inc Indicates previous or next month\n         * @private\n         */\n        _updateCal: function(inc){\n            if( typeof this._options.onMonthSelected === 'function' ){\n                this._options.onMonthSelected(this, {\n                    'year': this._year,\n                    'month' : this._month\n                });\n            }\n            if (inc && this._updateMonth(inc) === null) {\n                return;\n            }\n            this._renderMonth();\n        },\n\n        /**\n         * Function that returns the number of days on a given month on a given year\n         *\n         * @method _daysInMonth\n         * @param {Number} _y - year\n         * @param {Number} _m - month\n         * @private\n         * @return {Number} The number of days on a given month on a given year\n         */\n        _daysInMonth: function(_y,_m){\n            var exceptions = {\n                2: ((_y % 400 === 0) || (_y % 4 === 0 && _y % 100 !== 0)) ? 29 : 28,\n                4: 30,\n                6: 30,\n                9: 30,\n                11: 30\n            };\n\n            return exceptions[_m] || 31;\n        },\n\n\n        /**\n         * Updates the calendar when a different month is chosen\n         *\n         * @method _updateMonth\n         * @param {Number} incValue - indicates previous or next month\n         * @private\n         */\n        _updateMonth: function(incValue){\n            var date;\n            if (incValue > 0) {\n                date = this._getNextMonth();\n            } else if (incValue < 0) {\n                date = this._getPrevMonth();\n            }\n            if (!date) { return null; }\n            this._year = date._year;\n            this._month = date._month;\n            this._day = date._day;\n        },\n\n        /**\n         * Get the next month we can show.\n         */\n        _getNextMonth: function (date) {\n            return this._tryLeap( date, 'Month', 'next', function (d) {\n                    d._month += 1;\n                    if (d._month > 11) {\n                        d._month = 0;\n                        d._year += 1;\n                    }\n                    return d;\n                });\n        },\n\n        /**\n         * Get the previous month we can show.\n         */\n        _getPrevMonth: function (date) {\n            return this._tryLeap( date, 'Month', 'prev', function (d) {\n                    d._month -= 1;\n                    if (d._month < 0) {\n                        d._month = 11;\n                        d._year -= 1;\n                    }\n                    return d;\n                });\n        },\n\n        /**\n         * Get the next year we can show.\n         */\n        _getPrevYear: function (date) {\n            return this._tryLeap( date, 'Year', 'prev', function (d) {\n                    d._year -= 1;\n                    return d;\n                });\n        },\n\n        /**\n         * Get the next year we can show.\n         */\n        _getNextYear: function (date) {\n            return this._tryLeap( date, 'Year', 'next', function (d) {\n                    d._year += 1;\n                    return d;\n                });\n        },\n\n        /**\n         * DRY base for a function which tries to get the next or previous valid year or month.\n         *\n         * It checks if we can go forward by using _dateCmp with atomic\n         * precision (this means, {_year} for leaping years, and\n         * {_year, month} for leaping months), then it tries to get the\n         * result from the user-supplied callback (nextDateFn or prevDateFn),\n         * and when this is not present, advance the date forward using the\n         * `advancer` callback.\n         */\n        _tryLeap: function (date, atomName, directionName, advancer) {\n            date = date || { _year: this._year, _month: this._month, _day: this._day };\n\n            var maxOrMin = directionName === 'prev' ? '_min' : '_max';\n            var boundary = this[maxOrMin];\n\n            // Check if we're by the boundary of min/max year/month\n            if (this._dateCmpUntil(date, boundary, atomName) === 0) {\n                return null;  // We're already at the boundary. Bail.\n            }\n\n            var leapUserCb = this._options[directionName + 'ValidDateFn'];\n            if (leapUserCb) {\n                return this._callUserCallbackDate(leapUserCb, date);\n            } else {\n                date = advancer(date);\n            }\n\n            date = this._fitDateToRange(date);\n\n            return this['_acceptable' + atomName](date) ? date : null;\n        },\n\n        _getNextDecade: function (date) {\n            date = date || { _year: this._year, _month: this._month, _day: this._day };\n            var decade = this._getCurrentDecade(date);\n            if (decade + 10 > this._max._year) { return null; }\n            return decade + 10;\n        },\n\n        _getPrevDecade: function (date) {\n            date = date || { _year: this._year, _month: this._month, _day: this._day };\n            var decade = this._getCurrentDecade(date);\n            if (decade - 10 < this._min._year) { return null; }\n            return decade - 10;\n        },\n\n        /** Returns the decade given a date or year*/\n        _getCurrentDecade: function (year) {\n            year = year ? (year._year || year) : this._year;\n            return Math.floor(year / 10) * 10;  // Round to first place\n        },\n\n        _callUserCallbackBase: function (cb, date) {\n            return cb.call(this, date._year, date._month + 1, date._day);\n        },\n\n        _callUserCallbackBool: function (cb, date) {\n            return !!this._callUserCallbackBase(cb, date);\n        },\n\n        _callUserCallbackDate: function (cb, date) {\n            var ret = this._callUserCallbackBase(cb, date);\n            return ret ? dateishFromDate(ret) : null;\n        },\n\n        /**\n         * Key-value object that (for a given key) points to the correct parsing format for the DatePicker\n         * @property _dateParsers\n         * @type {Object}\n         * @readOnly\n         */\n        _dateParsers: {\n            'yyyy-mm-dd' : 'Y-m-d' ,\n            'yyyy/mm/dd' : 'Y/m/d' ,\n            'yy-mm-dd'   : 'y-m-d' ,\n            'yy/mm/dd'   : 'y/m/d' ,\n            'dd-mm-yyyy' : 'd-m-Y' ,\n            'dd/mm/yyyy' : 'd/m/Y' ,\n            'dd-mm-yy'   : 'd-m-y' ,\n            'dd/mm/yy'   : 'd/m/y' ,\n            'mm/dd/yyyy' : 'm/d/Y' ,\n            'mm-dd-yyyy' : 'm-d-Y'\n        },\n\n        /**\n         * Renders the current month\n         *\n         * @method _renderMonth\n         * @private\n         */\n        _renderMonth: function(){\n            var month = this._month;\n            var year = this._year;\n\n            this._showDefaultView();\n\n            InkElement.setHTML(this._monthContainer, '');\n\n            this._monthContainer.appendChild(\n                    this._getMonthCalendarHeader(this._options.startWeekDay));\n\n            this._monthContainer.appendChild(\n                    this._getDayButtons(year, month));\n        },\n\n        /**\n         * Figure out where the first day of a month lies\n         * in the first row of the calendar.\n         *\n         *      having options.startWeekDay === 0\n         *\n         *      Su Mo Tu We Th Fr Sa  \n         *                         1  <- The \"1\" is in the 7th day. return 6.\n         *       2  3  4  5  6  7  8  \n         *       9 10 11 12 13 14 15  \n         *      16 17 18 19 20 21 22  \n         *      23 24 25 26 27 28 29  \n         *      30 31\n         *\n         * This obviously changes according to the user option \"startWeekDay\"\n         **/\n        _getFirstDayIndex: function (year, month) {\n            var wDayFirst = (new Date( year , month , 1 )).getDay();  // Sunday=0\n            var startWeekDay = this._options.startWeekDay || 0;  // Sunday=0\n\n            var result = wDayFirst - startWeekDay;\n\n            result %= 7;\n\n            if (result < 0) {\n                result += 6;\n            }\n\n            return result;\n        },\n\n        _getDayButtons: function (year, month) {\n            var daysInMonth = this._daysInMonth(year, month + 1);\n\n            var ret = document.createDocumentFragment();\n\n            var ul = InkElement.create('ul');\n            ret.appendChild(ul);\n\n            var firstDayIndex = this._getFirstDayIndex(year, month);\n\n            // Add padding if the first day of the month is not monday.\n            for (var i = 0; i < firstDayIndex; i ++) {\n                ul.appendChild(InkElement.create('li', {\n                    className: 'ink-calendar-empty',\n                    setHTML: '&nbsp;'\n                }));\n            }\n\n            for (var day = 1; day <= daysInMonth; day++) {\n                if ((day - 1 + firstDayIndex) % 7 === 0){ // new week, new UL\n                    ul = InkElement.create('ul');\n                    ret.appendChild(ul);\n                }\n\n                ul.appendChild(this._getDayButton(year, month, day));\n            }\n            return ret;\n        },\n\n        /**\n         * Get the HTML markup for a single day in month view, given year, month, day.\n         *\n         * @method _getDayButtonHtml\n         * @private\n         */\n        _getDayButton: function (year, month, day) {\n            var attrs = {};\n            var date = dateishFromYMD(year, month, day);\n\n            if (!this._acceptableDay(date)) {\n                attrs.className = 'ink-calendar-off';\n            } else {\n                attrs['data-cal-day'] = day;\n\n                if (this._day && this._dateCmp(date, this) === 0) {\n                    attrs.className = 'ink-calendar-on';\n                }\n            }\n\n            attrs.setTextContent = day;\n\n            var dayButton = InkElement.create('li');\n            dayButton.appendChild(InkElement.create('a', attrs));\n            return dayButton;\n        },\n\n        /** Write the top bar of the calendar (M T W T F S S) */\n        _getMonthCalendarHeader: function (startWeekDay) {\n            var header = InkElement.create('ul', {\n                className: 'ink-calendar-header'\n            });\n\n            var wDay;\n            for(var i=0; i<7; i++){\n                wDay = (startWeekDay + i) % 7;\n                header.appendChild(InkElement.create('li', {\n                    setTextContent: this._options.wDay[wDay].substring(0, 1)\n                }));\n            }\n\n            return header;\n        },\n\n        /**\n         * This method adds class names to month buttons, to visually distinguish.\n         *\n         * @method _addMonthClassNames\n         * @param {DOMElement} parent DOMElement where all the months are.\n         * @private\n         */\n        _addMonthClassNames: function(parent){\n            InkArray.forEach(\n                (parent || this._monthSelector).getElementsByTagName('a'),\n                Ink.bindMethod(this, '_addMonthButtonClassNames'));\n        },\n\n        /**\n         * Add the ink-calendar-on className if the given button is the current month,\n         * otherwise add the ink-calendar-off className if the given button refers to\n         * an unacceptable month (given dateRange and validMonthFn)\n         */\n        _addMonthButtonClassNames: function (btn) {\n            var data = InkElement.data(btn);\n            if (!data.calMonth) { throw 'not a calendar month button!'; }\n\n            var month = +data.calMonth - 1;\n\n            if ( month === this._month ) {\n                Css.addClassName( btn, 'ink-calendar-on' );  // This month\n                Css.removeClassName( btn, 'ink-calendar-off' );\n            } else {\n                Css.removeClassName( btn, 'ink-calendar-on' );  // Not this month\n\n                var toDisable = !this._acceptableMonth({_year: this._year, _month: month});\n                Css.addRemoveClassName( btn, 'ink-calendar-off', toDisable);\n            }\n        },\n\n        /*\n         * // TODO implement this\n         * Prototype's method to allow the 'i18n files' to change all objects' language at once.\n         * @param {Object} options                  Object with the texts' configuration.\n         * @param {String} options.closeText        Text of the close anchor\n         * @param {String} options.cleanText        Text of the clean text anchor\n         * @param {String} options.prevLinkText     \"Previous\" link's text\n         * @param {String} options.nextLinkText     \"Next\" link's text\n         * @param {String} options.ofText           The text \"of\", present in 'May of 2013'\n         * @param {Object} options.month            An object with keys from 1 to 12 for the full months' names\n         * @param {Object} options.wDay             An object with keys from 0 to 6 for the full weekdays' names\n         * @public\n         */\n        lang: function( options ){\n            this._lang = options;\n        },\n\n        /**\n         * This calls the rendering of the selected month. (Deprecated: use show() instead)\n         *\n         */\n        showMonth: function(){\n            this._renderMonth();\n        },\n\n        /**\n         * Checks if the calendar screen is in 'select day' mode\n         * \n         * @method isMonthRendered\n         * @return {Boolean} True if the calendar screen is in 'select day' mode\n         * @public\n         */\n        isMonthRendered: function(){\n            var header = Selector.select('.ink-calendar-header', this._containerObject)[0];\n\n            return ((Css.getStyle(header.parentNode,'display') !== 'none') &&\n                    (Css.getStyle(header.parentNode.parentNode,'display') !== 'none') );\n        },\n\n        /**\n         * Destroys this datepicker, removing it from the page.\n         *\n         * @method destroy\n         * @public\n         **/\n        destroy: function () {\n            InkElement.unwrap(this._element);\n            InkElement.remove(this._wrapper);\n            InkElement.remove(this._containerObject);\n            Common.unregisterInstance.call(this);\n        }\n    };\n\n    Common.createUIComponent(DatePicker);\n\n    return DatePicker;\n});","/**\n * Dragging elements around\n * @module Ink.UI.Draggable_1\n * @version 1\n */\n \nInk.createModule(\"Ink.UI.Draggable\",\"1\",[\"Ink.Dom.Element_1\", \"Ink.Dom.Event_1\", \"Ink.Dom.Css_1\", \"Ink.Dom.Browser_1\", \"Ink.Dom.Selector_1\", \"Ink.UI.Common_1\"],function( InkElement, InkEvent, Css, Browser, Selector, Common) {\n    'use strict';\n\n    var x = 0,\n        y = 1;  // For accessing coords in [x, y] arrays\n    \n    // Get a value between two boundaries\n    function between (val, min, max) {\n        val = Math.min(val, max);\n        val = Math.max(val, min);\n        return val;\n    }\n\n    /**\n     * @class Ink.UI.Draggable\n     * @version 1\n     * @constructor\n     * @param {String|DOMElement}   target                      Target element.\n     * @param {Object}              [options]                   Optional object to configure the component.\n     * @param {String}              [options.constraint]        Movement constraint. None by default. Can be `vertical`, `horizontal`, or `both`.\n     * @param {String|DOMElement}   [options.constraintElm]     Constrain dragging to be within this element. None by default.\n     * @param {Number}              [options.top]               Limits to constrain draggable movement.\n     * @param {Number}              [options.right]             Limits to constrain draggable movement.\n     * @param {Number}              [options.bottom]            Limits to constrain draggable movement.\n     * @param {Number}              [options.left]              Limits to constrain draggable movement.\n     * @param {String|DOMElement}   [options.handle]            If specified, this element or CSS ID will be used as a handle for dragging.\n     * @param {Boolean}             [options.revert]            Flag to revert the draggable to the original position when dragging stops.\n     * @param {String}              [options.cursor]            Cursor type (CSS `cursor` value) used when the mouse is over the draggable object.\n     * @param {Number}              [options.zIndex]            Z-index applied to the draggable element while dragged.\n     * @param {Number}              [options.fps]               If set, throttles the drag effect to this number of frames per second.\n     * @param {DOMElement}          [options.droppableProxy]    If set, a shallow copy of this element will be moved around with transparent background.\n     * @param {String}              [options.mouseAnchor]       Anchor for the drag. Can be one of: 'left','center','right','top','center','bottom'.\n     * @param {String}              [options.dragClass]         Class to add when the draggable is being dragged. Defaults to drag.\n     * @param {Boolean}             [options.skipChildren=true] Whether you have to drag the actual element, or dragging one of the children is okay too.\n     * @param {Function}            [options.onStart]           Callback called when dragging starts.\n     * @param {Function}            [options.onEnd]             Callback called when dragging stops.\n     * @param {Function}            [options.onDrag]            Callback called while dragging, prior to position updates.\n     * @param {Function}            [options.onChange]          Callback called while dragging, after position updates.\n     *\n     * @sample Ink_UI_Draggable_1.html\n     */\n    function Draggable() {\n        Common.BaseUIComponent.apply(this, arguments);\n    }\n\n    Draggable._name = 'Draggable_1';\n\n    Draggable._optionDefinition = {\n        constraint:         ['String', false],\n        constraintElm:      ['Element', false],\n        top:                ['Number', false],\n        right:              ['Number', false],\n        bottom:             ['Number', false],\n        left:               ['Number', false],\n        handle:             ['Element', false],\n        revert:             ['Boolean', false],\n        cursor:             ['String', 'move'],\n        zIndex:             ['Number', 9999],\n        fps:                ['Number', 0],\n        droppableProxy:     ['Element', false],\n        mouseAnchor:        ['String', undefined],\n        dragClass:          ['String', 'drag'],\n        skipChildren:       ['Boolean', true],  // Magic/More Magic\n        onStart:            ['Function', false],\n        onEnd:              ['Function', false],\n        onDrag:             ['Function', false],\n        onChange:           ['Function', false]\n    };\n\n    Draggable.prototype = {\n        /**\n         * Init function called by the constructor\n         * \n         * @method _init\n         * @param {String|DOMElement}   element     Element ID of the element or DOM Element.\n         * @param {Object}              [options]   Options object for configuration of the module.\n         * @private\n         */\n        _init: function() {\n            var o = this._options;\n            this.constraintElm = o.constraintElm && Common.elOrSelector(o.constraintElm);\n\n            this.handle             = false;\n            this.elmStartPosition   = false;\n            this.active             = false;\n            this.dragged            = false;\n            this.prevCoords         = false;\n            this.placeholder        = false;\n\n            this.position           = false;\n            this.zindex             = false;\n            this.firstDrag          = true;\n\n            if (o.fps) {\n                this.deltaMs = 1000 / o.fps;\n                this.lastRunAt = 0;\n            }\n\n            this.handlers = {};\n            this.handlers.start         = Ink.bindEvent(this._onStart,this);\n            this.handlers.dragFacade    = Ink.bindEvent(this._onDragFacade,this);\n            this.handlers.drag          = Ink.bindEvent(this._onDrag,this);\n            this.handlers.end           = Ink.bindEvent(this._onEnd,this);\n            this.handlers.selectStart   = function(event) {    InkEvent.stop(event);    return false;    };\n\n            // set handle\n            this.handle = (this._options.handle) ?\n                Common.elOrSelector(this._options.handle) :\n                this._element;\n\n            this.handle.style.cursor = o.cursor;\n\n            InkEvent.observe(this.handle, 'touchstart', this.handlers.start);\n            InkEvent.observe(this.handle, 'mousedown', this.handlers.start);\n\n            if (Browser.IE) {\n                InkEvent.observe(this._element, 'selectstart', this.handlers.selectStart);\n            }\n        },\n\n        /**\n         * Removes the ability of the element of being dragged\n         * \n         * @method destroy\n         * @public\n         */\n        destroy: function() {\n            InkEvent.stopObserving(this.handle, 'touchstart', this.handlers.start);\n            InkEvent.stopObserving(this.handle, 'mousedown', this.handlers.start);\n\n            if (Browser.IE) {\n                InkEvent.stopObserving(this._element, 'selectstart', this.handlers.selectStart);\n            }\n        },\n\n        /**\n         * Gets coordinates for a given event (with added page scroll)\n         * \n         * @method _getCoords\n         * @param {Object} e window.event object.\n         * @return {Array} Array where the first position is the x coordinate, the second is the y coordinate\n         * @private\n         */\n        _getCoords: function(e) {\n            var ps = [InkElement.scrollWidth(), InkElement.scrollHeight()];\n            return {\n                x: (e.touches ? e.touches[0].clientX : e.clientX) + ps[x],\n                y: (e.touches ? e.touches[0].clientY : e.clientY) + ps[y]\n            };\n        },\n\n        /**\n         * Clones src element's relevant properties to dst\n         * \n         * @method _cloneStyle\n         * @param {DOMElement} src Element from where we're getting the styles\n         * @param {DOMElement} dst Element where we're placing the styles.\n         * @private\n         */\n        _cloneStyle: function(src, dst) {\n            dst.className = src.className;\n            dst.style.borderWidth   = '0';\n            dst.style.padding       = '0';\n            dst.style.position      = 'absolute';\n            dst.style.width         = InkElement.elementWidth(src)        + 'px';\n            dst.style.height        = InkElement.elementHeight(src)    + 'px';\n            dst.style.left          = InkElement.elementLeft(src)        + 'px';\n            dst.style.top           = InkElement.elementTop(src)        + 'px';\n            dst.style.cssFloat      = Css.getStyle(src, 'float');\n            dst.style.display       = Css.getStyle(src, 'display');\n        },\n\n        /**\n         * onStart event handler\n         * \n         * @method _onStart\n         * @param {Object} e window.event object\n         * @return {Boolean|void} In some cases return false. Otherwise is void\n         * @private\n         */\n        _onStart: function(e) {\n            if (!this.active && InkEvent.isLeftClick(e) || typeof e.button === 'undefined') {\n\n                var tgtEl = InkEvent.element(e);\n                if (this._options.skipChildren && tgtEl !== this.handle) {    return;    }\n\n                InkEvent.stop(e);\n\n                Css.addClassName(this._element, this._options.dragClass);\n\n                this.elmStartPosition = [\n                    InkElement.elementLeft(this._element),\n                    InkElement.elementTop( this._element)\n                ];\n\n                var pos = [\n                    parseInt(Css.getStyle(this._element, 'left'), 10),\n                    parseInt(Css.getStyle(this._element, 'top'),  10)\n                ];\n\n                var dims = InkElement.elementDimensions(this._element);\n\n                this.originalPosition = [ pos[x] ? pos[x]: null, pos[y] ? pos[y] : null ];\n                this.delta = this._getCoords(e); // mouse coords at beginning of drag\n\n                this.active = true;\n                this.position = Css.getStyle(this._element, 'position');\n                this.zindex = Css.getStyle(this._element, 'zIndex');\n\n                var div = document.createElement('div');\n                div.style.position      = this.position;\n                div.style.width         = dims[x] + 'px';\n                div.style.height        = dims[y] + 'px';\n                div.style.marginTop     = Css.getStyle(this._element, 'margin-top');\n                div.style.marginBottom  = Css.getStyle(this._element, 'margin-bottom');\n                div.style.marginLeft    = Css.getStyle(this._element, 'margin-left');\n                div.style.marginRight   = Css.getStyle(this._element, 'margin-right');\n                div.style.borderWidth   = '0';\n                div.style.padding       = '0';\n                div.style.cssFloat      = Css.getStyle(this._element, 'float');\n                div.style.display       = Css.getStyle(this._element, 'display');\n                div.style.visibility    = 'hidden';\n\n                this.delta2 = [ this.delta.x - this.elmStartPosition[x], this.delta.y - this.elmStartPosition[y] ]; // diff between top-left corner of obj and mouse\n                if (this._options.mouseAnchor) {\n                    var parts = this._options.mouseAnchor.split(' ');\n                    var ad = [dims[x], dims[y]];    // starts with 'right bottom'\n                    if (parts[0] === 'left') {    ad[x] = 0;    } else if(parts[0] === 'center') {    ad[x] = parseInt(ad[x]/2, 10);    }\n                    if (parts[1] === 'top') {     ad[y] = 0;    } else if(parts[1] === 'center') {    ad[y] = parseInt(ad[y]/2, 10);    }\n                    this.applyDelta = [this.delta2[x] - ad[x], this.delta2[y] - ad[y]];\n                }\n\n                var dragHandlerName = this._options.fps ? 'dragFacade' : 'drag';\n\n                this.placeholder = div;\n\n                if (this._options.onStart) {        this._options.onStart(this._element, e);        }\n\n                if (this._options.droppableProxy) {    // create new transparent div to optimize DOM traversal during drag\n                    this.proxy = document.createElement('div');\n                    dims = [\n                        window.innerWidth     || document.documentElement.clientWidth   || document.body.clientWidth,\n                        window.innerHeight    || document.documentElement.clientHeight  || document.body.clientHeight\n                    ];\n                    var fs = this.proxy.style;\n                    fs.width            = dims[x] + 'px';\n                    fs.height           = dims[y] + 'px';\n                    fs.position         = 'fixed';\n                    fs.left             = '0';\n                    fs.top              = '0';\n                    fs.zIndex           = this._options.zindex + 1;\n                    fs.backgroundColor  = '#FF0000';\n                    Css.setOpacity(this.proxy, 0);\n\n                    var firstEl = document.body.firstChild;\n                    while (firstEl && firstEl.nodeType !== 1) {    firstEl = firstEl.nextSibling;    }\n                    document.body.insertBefore(this.proxy, firstEl);\n\n                    \n                    InkEvent.observe(this.proxy, 'mousemove', this.handlers[dragHandlerName]);\n                    InkEvent.observe(this.proxy, 'touchmove', this.handlers[dragHandlerName]);\n                }\n                else {\n                    InkEvent.observe(document, 'mousemove', this.handlers[dragHandlerName]);\n                }\n\n                this._element.style.position = 'absolute';\n                this._element.style.zIndex = this._options.zindex;\n                this._element.parentNode.insertBefore(this.placeholder, this._element);\n\n                this._onDrag(e);\n\n                InkEvent.observe(document, 'mouseup',      this.handlers.end);\n                InkEvent.observe(document, 'touchend',     this.handlers.end);\n\n                return false;\n            }\n        },\n\n        /**\n         * Function that gets the timestamp of the current run from time to time. (FPS)\n         * \n         * @method _onDragFacade\n         * @param {Object} window.event object.\n         * @private\n         */\n        _onDragFacade: function(e) {\n            var now = +new Date();\n            if (!this.lastRunAt || now > this.lastRunAt + this.deltaMs) {\n                this.lastRunAt = now;\n                this._onDrag(e);\n            }\n        },\n\n        /**\n         * Function that handles the dragging movement\n         * \n         * @method _onDrag\n         * @param {Object} window.event object.\n         * @private\n         */\n        _onDrag: function(e) {\n            if (this.active) {\n                InkEvent.stop(e);\n                this.dragged = true;\n                var mouseCoords = this._getCoords(e),\n                    mPosX       = mouseCoords.x,\n                    mPosY       = mouseCoords.y,\n                    o           = this._options,\n                    newX        = false,\n                    newY        = false;\n\n                if (this.prevCoords && mPosX !== this.prevCoords.x || mPosY !== this.prevCoords.y) {\n                    if (o.onDrag) {        o.onDrag(this._element, e);        }\n                    this.prevCoords = mouseCoords;\n\n                    newX = this.elmStartPosition[x] + mPosX - this.delta.x;\n                    newY = this.elmStartPosition[y] + mPosY - this.delta.y;\n\n                    var draggableSize = InkElement.elementDimensions(this._element);\n\n                    if (this.constraintElm) {\n                        var offset = InkElement.offset(this.constraintElm);\n                        var size = InkElement.elementDimensions(this.constraintElm);\n                        var constTop = offset[y] + (o.top || 0),\n                            constBottom = offset[y] + size[y] - (o.bottom || 0),\n                            constLeft = offset[x] + (o.left || 0),\n                            constRight = offset[x] + size[x] - (o.right || 0);\n\n                        newY = between(newY, constTop, constBottom - draggableSize[y]);\n                        newX = between(newX, constLeft, constRight - draggableSize[x]);\n                    } else if (o.constraint) {\n                        var right = o.right === false ? InkElement.pageWidth() - draggableSize[x] : o.right,\n                            left = o.left === false ? 0 : o.left,\n                            top = o.top === false ? 0 : o.top,\n                            bottom = o.bottom === false ? InkElement.pageHeight() - draggableSize[y] : o.bottom;\n                        if (o.constraint === 'horizontal' || o.constraint === 'both') {\n                            newX = between(newX, left, right);\n                        }\n                        if (o.constraint === 'vertical' || o.constraint === 'both') {\n                            newY = between(newY, top, bottom);\n                        }\n                    }\n\n                    var Droppable = Ink.getModule('Ink.UI.Droppable_1');\n                    if (this.firstDrag) {\n                        if (Droppable) {    Droppable.updateAll();    }\n                        /*this._element.style.position = 'absolute';\n                        this._element.style.zIndex = this._options.zindex;\n                        this._element.parentNode.insertBefore(this.placeholder, this._element);*/\n                        this.firstDrag = false;\n                    }\n\n                    if (newX) {        this._element.style.left = newX + 'px';        }\n                    if (newY) {        this._element.style.top  = newY + 'px';        }\n\n                    if (Droppable) {\n                        // apply applyDelta defined on drag init\n                        var mouseCoords2 = this._options.mouseAnchor ?\n                            {x: mPosX - this.applyDelta[x], y: mPosY - this.applyDelta[y]} :\n                            mouseCoords;\n                        Droppable.action(mouseCoords2, 'drag', e, this._element);\n                    }\n                    if (o.onChange) {    o.onChange(this);    }\n                }\n            }\n        },\n\n        /**\n         * Function that handles the end of the dragging process\n         * \n         * @method _onEnd\n         * @param {Object} window.event object.\n         * @private\n         */\n        _onEnd: function(e) {\n            InkEvent.stopObserving(document, 'mousemove', this.handlers.drag);\n            InkEvent.stopObserving(document, 'touchmove', this.handlers.drag);\n\n            if (this._options.fps) {\n                this._onDrag(e);\n            }\n\n            Css.removeClassName(this._element, this._options.dragClass);\n\n            if (this.active && this.dragged) {\n\n                if (this._options.droppableProxy) {    // remove transparent div...\n                    document.body.removeChild(this.proxy);\n                }\n\n                if (this.pt) {    // remove debugging element...\n                    InkElement.remove(this.pt);\n                    this.pt = undefined;\n                }\n\n                /*if (this._options.revert) {\n                    this.placeholder.parentNode.removeChild(this.placeholder);\n                }*/\n\n                if(this.placeholder) {\n                    InkElement.remove(this.placeholder);\n                }\n\n                if (this._options.revert) {\n                    this._element.style.position = this.position;\n                    if (this.zindex !== null) {\n                        this._element.style.zIndex = this.zindex;\n                    }\n                    else {\n                        this._element.style.zIndex = 'auto';\n                    } // restore default zindex of it had none\n\n                    this._element.style.left = (this.originalPosition[x]) ? this.originalPosition[x] + 'px' : '';\n                    this._element.style.top  = (this.originalPosition[y]) ? this.originalPosition[y] + 'px' : '';\n                }\n\n                if (this._options.onEnd) {\n                    this._options.onEnd(this._element, e);\n                }\n                \n                var Droppable = Ink.getModule('Ink.UI.Droppable_1');\n                if (Droppable) {\n                    Droppable.action(this._getCoords(e), 'drop', e, this._element);\n                }\n\n                this.position   = false;\n                this.zindex     = false;\n                this.firstDrag  = true;\n            }\n\n            this.active         = false;\n            this.dragged        = false;\n        }\n    };\n\n    Common.createUIComponent(Draggable);\n\n    return Draggable;\n\n});\n","/**\n * Off-canvas menu\n * @module Ink.UI.Drawer_1\n * @version 1\n */\n \nInk.createModule('Ink.UI.Drawer', '1', ['Ink.UI.Common_1', 'Ink.Dom.Loaded_1', 'Ink.Dom.Selector_1', 'Ink.Dom.Element_1', 'Ink.Dom.Event_1', 'Ink.Dom.Css_1'], function(Common, Loaded, Selector, Element, Event, Css) {\n    'use strict';\n\n    function elNotFound(el) {\n        Ink.warn( 'Ink.UI.Drawer_1: Could not find the \"' +\n            el + '\" element on this page. Please make sure it exists.' );\n    }\n\n    function Drawer(options) {\n        Common.BaseUIComponent.apply(this, [document.body, options]);\n    }\n\n    Drawer._name = 'Drawer_1';\n\n    Drawer._optionDefinition = {\n        parentSelector:     ['String', '.ink-drawer'],\n        leftDrawer:         ['String', '.left-drawer'],\n        leftTrigger:        ['String', '.left-drawer-trigger'],\n        rightDrawer:        ['String', '.right-drawer'],\n        rightTrigger:       ['String', '.right-drawer-trigger'],\n        contentDrawer:      ['String', '.content-drawer'],\n        closeOnContentClick: ['Boolean', true],\n        closeOnLinkClick:    ['Boolean', true],\n        mode:               ['String', 'push'],\n        sides:              ['String', 'both']\n    };\n\n    Drawer.prototype = {\n        /**\n         * Displays off-canvas content which can be triggered by clicking elements with the 'left-drawer-trigger' and 'right-drawer-trigger', respectively.\n         * The left drawer has the 'left-drawer' class, and the right drawer has the 'right-drawer' class. The content drawer (EG your `<div id=\"main\">`) must have the 'content-drawer' class. For more, see the example below, or try the sample.\n         * @class Ink.UI.Drawer_1\n         * @constructor\n         *\n         * @param {Object}      [options]                       Configuration options.\n         * @xparam {String}     [options.parentSelector]        The class you are using in your wrapper (in the example below, it's the `body` tag.)\n         * @xparam {String}     [options.leftDrawer]            Selector for the left drawer element. This element is placed outside the screen and shown when you click the `leftTrigger` element.\n         * @xparam {String}     [options.leftTrigger]           Selector for the left drawer trigger(s). When you click this trigger, the `leftDrawer` is shown.\n         * @xparam {String}     [options.rightDrawer]           Right drawer selector. (see `options.leftDrawer`)\n         * @xparam {String}     [options.rightTrigger]          Right trigger selector (see `options.leftTrigger`)\n         * @xparam {String}     [options.contentDrawer]         Selector for the content drawer.\n         * @param {Boolean}     [options.closeOnContentClick]   Flag to close the drawer when someone clicks on the `.contentDrawer`\n         * @param {String}      [options.mode]                  This can be 'push' or 'over'.\n         * @param {String}      [options.sides]                 Can be 'left', 'right', or 'both'. Controls what sides have a drawer.\n         *\n         * @example\n         * <body class=\"ink-drawer\">\n         *     <div class=\"left-drawer\">\n         *         Right drawer content...\n         *     </div>\n         *     <div class=\"right-drawer\">\n         *         Left drawer content...\n         *     </div>\n         *     <div id=\"main-content\" class=\"content-drawer ink-grid\">\n         *         <a class=\"left-drawer-trigger\" href=\"\">Open left drawer</a>\n         *         <a class=\"right-drawer-trigger\" href=\"\">Open right drawer</a>\n         *         Content...\n         *     </div>\n         * </body>\n         *\n         * <script>\n         *     Ink.requireModules(['Ink.UI.Drawer_1'], function (Drawer) {\n         *         new Drawer();\n         *     });\n         * </script>\n         */\n        _init: function () {\n            // make sure we have the required elements acording to the config options\n\n            this._contentDrawers = Ink.ss(this._options.contentDrawer);\n\n            this._leftDrawer = Ink.s(this._options.leftDrawer);\n            this._leftTriggers = Ink.ss(this._options.leftTrigger);\n\n            this._rightDrawer = Ink.s(this._options.rightDrawer);\n            this._rightTriggers = Ink.ss(this._options.rightTrigger);\n\n            // The body might not have it\n            Css.addClassName(document.body, 'ink-drawer');\n\n            if(this._contentDrawers.length === 0) {\n                throw new Error('Ink.UI.Drawer_1: Could not find any \"' +\n                    this._options.contentDrawer + '\" elements on this page. ' +\n                    'Please make sure you have at least one.' );\n            }\n\n            switch (this._options.sides) {\n                case 'both':\n                    this._triggers =\n                        this._options.leftTrigger + ', ' +\n                        this._options.rightTrigger + ', ' +\n                        this._options.contentDrawer;\n                break;\n\n                case 'left':\n                    this._triggers =\n                        this._options.leftTrigger + ', ' +\n                        this._options.contentDrawer;\n                break;\n\n                case 'right':\n                    this._triggers =\n                        this._options.rightTrigger + ', ' +\n                        this._options.contentDrawer;\n                break;\n            }\n\n            if (this._options.sides === 'left' || this._options.sides === 'both') {\n                if( !this._leftDrawer ){\n                    elNotFound(this._options.leftDrawer);\n                }\n\n                if(this._leftTriggers.length === 0){\n                    elNotFound(this._options.leftTrigger);\n                }\n            } else {\n                if( !this._rightDrawer ){\n                    elNotFound(this._options.rightDrawer);\n                }\n\n                if( this._rightTriggers.length === 0 ){\n                    elNotFound(this._options.rightTrigger);\n                }\n            }\n\n            this._isOpen = false;\n            this._direction = undefined;\n\n            this._handlers = {\n                click:     Ink.bindEvent(this._onClick, this),\n                afterTransition: Ink.bindEvent(this._afterTransition, this)\n            };\n            this._delay = 10;\n            this._addEvents();\n        },\n\n        /**\n         * Click event handler.\n         * Listens to the body's click event\n         *\n         * @method _onClick\n         * @private\n         **/\n        _onClick: function(ev){\n            var triggerClicked = Ink.bind(function (side) {\n                // When clicking on the trigger, the corresponding side is toggled.\n                if (this._isOpen) {\n                    this.close();\n                } else {\n                    this.open(side);\n                }\n                ev.preventDefault();\n            }, this);\n\n            if(Element.findUpwardsBySelector(ev.currentTarget,this._options.leftTrigger)){\n                // Clicked on the left trigger\n                triggerClicked('left');\n            } else if(Element.findUpwardsBySelector(ev.currentTarget,this._options.rightTrigger)){\n                triggerClicked('right');\n            } else if(Element.findUpwardsBySelector(ev.currentTarget,this._options.contentDrawer)){\n                // Clicked on the rest of the body\n                if(this._options.closeOnContentClick) {\n                    this.close();\n                }\n            } else if (this._options.closeOnLinkClick && Element.isLink(ev.target)) {\n                this.close();\n                // No preventDefault() here\n            }\n        },\n\n        _afterTransition: function(){\n            if(!this._isOpen){\n                if(this._direction === 'left') {\n                    Css.removeClassName(this._leftDrawer, 'show');\n                } else {\n                    Css.removeClassName(this._rightDrawer, 'show');\n                }\n            }\n        },\n\n        _addEvents: function(){\n            Event.on(document.body, 'click', this._triggers + ', a[href*=\"#\"]', this._handlers.click);\n        },\n\n        open: function(direction) {\n            this._isOpen = true;\n            this._direction = direction;\n\n            var open = direction === 'left' ?\n                this._leftDrawer :\n                this._rightDrawer;\n\n            Css.addClassName(open,'show');\n            setTimeout(Ink.bind(function(){\n                Css.addClassName(document.body, [this._options.mode, direction]);\n            },this), this._delay);\n        },\n\n        close: function() {\n            if (this._isOpen === false) { return; }\n            this._isOpen = false;\n            // TODO detect transitionEnd exists, otherwise don't rely on it\n            Event.one(document.body, 'transitionend oTransitionEnd webkitTransitionEnd', this._handlers.afterTransition);\n            Css.removeClassName(document.body, [this._options.mode, this._direction]);\n        }\n\n    };\n\n    Common.createUIComponent(Drawer);\n\n    return Drawer;\n});\n","/**\n * Dropdown menus\n *\n * @module Ink.UI.Dropdown_1\n * Use this UI module to achieve a dropdown menu.\n *\n * @version 1\n */\n\nInk.createModule('Ink.UI.Dropdown', '1', ['Ink.UI.Common_1', 'Ink.UI.Toggle_1', 'Ink.Dom.Event_1', 'Ink.Dom.Element_1'], function(Common, Toggle, InkEvent, InkElement) {\n    'use strict';\n\n    function Dropdown() {\n        Common.BaseUIComponent.apply(this, arguments);\n    }\n\n    Dropdown._name = 'Dropdown_1';\n\n    Dropdown._optionDefinition = {\n        'target':           ['Element'],\n        'hoverOpen':        ['Number', null],\n        'dismissOnInsideClick': ['Boolean', false],\n        'dismissOnOutsideClick': ['Boolean', true],\n        'dismissAfter':     ['Number', null],\n        'onInsideClick':    ['Function', null],\n        'onOutsideClick':   ['Function', null],\n        'onOpen':           ['Function', null],\n        'onDismiss':        ['Function', null]\n    };\n\n    Dropdown.prototype = {\n        /**\n         * @class Ink.UI.Dropdown\n         *\n         * @constructor\n         * @param {DOMElement|String}   trigger         Trigger Element\n         * @param {Object}              options         Options Object\n         * @param {DOMElement|String}   options.target Target of the dropdown action.\n         *\n         * @sample Ink_UI_Dropdown_1.html\n         */\n        _init: function() {\n            this._toggle = new Toggle(this._element, {\n                target: this._options.target,\n                closeOnInsideClick: null,\n                closeOnClick: false,\n                onChangeState: Ink.bind(function (newState) {\n                    return this._openOrDismiss(newState, true, true);\n                }, this)\n            });\n\n            // Event where we set this._dismissTimeout and clear this._openTimeout\n            InkEvent.observeMulti([this._options.target, this._element],\n                'mouseout', Ink.bindMethod(this, '_onMouseOut'));\n\n            // Events to keep clearing this._dismissTimeout and set this._openTimeout\n            InkEvent.observeMulti([this._options.target, this._element],\n                'mouseover', Ink.bindMethod(this, '_onMouseOver'));\n\n            // to call dismissOnInsideClick and onInsideClick\n            InkEvent.observe(this._options.target, 'click', Ink.bindMethod(this, '_onInsideClick'));\n            // to call dismissOnOutsideClick and onOutsideClick\n            InkEvent.observe(document, 'click', Ink.bindMethod(this, '_onOutsideClick'));\n        },\n\n        /**\n         * Called when the mouse is over the toggler, or the dropdown.\n         *\n         * Deals with \"hoverOpen\" by setting the dropdown to open later. Also cancels \"dismissAfter\".\n         * @method _onMouseOver\n         * @private\n         **/\n        _onMouseOver: function () {\n            if (typeof this._options.hoverOpen === 'number' && this._toggle.getState() === false) {\n                clearTimeout(this._openTimeout);\n                this._openTimeout = setTimeout(\n                    Ink.bindMethod(this, 'open', true),\n                    this._options.hoverOpen * 1000);\n            }\n            if (typeof this._options.dismissAfter === 'number') {\n                clearTimeout(this._dismissTimeout);\n            }\n        },\n\n        /**\n         * Called when the mouse leaves either the toggler, or the dropdown.\n         *\n         * Deals with \"dismissAfter\" by setting the dropdown to be dismissed later. Also cancels \"hoverOpen\".\n         * @method _onMouseOut\n         * @private\n         **/\n        _onMouseOut: function () {\n            if (typeof this._options.dismissAfter === 'number' && this._toggle.getState() === true) {\n                clearTimeout(this._dismissTimeout);\n                this._dismissTimeout = setTimeout(\n                    Ink.bindMethod(this, 'dismiss', true),\n                    this._options.dismissAfter * 1000);\n            }\n            if (typeof this._options.hoverOpen === 'number') {\n                clearTimeout(this._openTimeout);\n            }\n        },\n\n        /**\n         * Handle clicks on the dropdown.\n         * @method _onInsideClick\n         * @private\n         */\n        _onInsideClick: function (event) {\n            var ret = this._handlerCall('onInsideClick', InkEvent.element(event));\n            if (ret === false) { return; }\n            if (this._options.dismissOnInsideClick) {\n                this.dismiss(true);\n            }\n        },\n\n        /**\n         * Handle clicks outside the dropdown.\n         * @method _onOutsideClick\n         * @private\n         */\n        _onOutsideClick: function (event) {\n            var target = InkEvent.element(event);\n            var foundElem = InkElement.findUpwardsHaving(target, Ink.bind(function (needle) {\n                return needle === this._element;\n            }, this));\n            var foundTarget = InkElement.findUpwardsHaving(target, Ink.bind(function (needle) {\n                return needle === this._options.target;\n            }, this));\n\n            if (!foundElem && !foundTarget) {\n                var ret = this._handlerCall('onOutsideClick', target);\n                if (ret === false) { return; }\n                if (this._options.dismissOnOutsideClick) {\n                    this.dismiss(true);\n                }\n            }\n        },\n\n        /**\n         * Closes the dropdown.\n         *\n         * @method dismiss\n         * @param [callHandler=false] call onDismiss handler\n         */\n        dismiss: function (callHandler, doNotInformToggle) {\n            this._openOrDismiss(false, callHandler, doNotInformToggle);\n        },\n\n        /**\n         * Opens the dropdown\n         *\n         * @method open\n         * @param [callHandler=false] call onOpen handler\n         */\n        open: function (callHandler, _doNotInformToggle) {\n            this._openOrDismiss(true, callHandler, _doNotInformToggle);\n        },\n\n        /**\n         * DRY'ing up open() and dismiss()\n         *\n         * @method _openOrDismiss\n         * @param [newState=false]\n         * @param [callHandler=false]\n         * @private\n         */\n        _openOrDismiss: function (newState, callHandler, _doNotInformToggle) {\n            if (this._toggle && this._toggle.getState() === newState) { return; }\n            if (callHandler) {\n                if (this._handlerCall(newState ? 'onOpen' : 'onDismiss') === false) {\n                    return false;  // canceled by event handler\n                }\n            }\n            if (!_doNotInformToggle) {\n                this._toggle.setState(newState);\n            }\n            clearTimeout(this._dismissTimeout);\n            clearTimeout(this._openTimeout);\n        },\n\n        /**\n         * call a method given by the user through the options\n         *\n         * @method _handlerCall\n         * @param handler {String} The handler name in this._options\n         * @param [args*] Arguments to pass to function\n         */\n        _handlerCall: function (handler/*, ... */) {\n            if (this._options[handler]) {\n                return this._options[handler].call(this, [].slice.call(arguments, 1));\n            }\n        }\n    };\n\n    Common.createUIComponent(Dropdown);\n\n    return Dropdown;\n});\n","/**\n * Drop elements around\n * @module Ink.UI.Droppable_1\n * @version 1\n */\n\nInk.createModule(\"Ink.UI.Droppable\",\"1\",[\"Ink.Dom.Element_1\", \"Ink.Dom.Event_1\", \"Ink.Dom.Css_1\", \"Ink.UI.Common_1\", \"Ink.Util.Array_1\", \"Ink.Dom.Selector_1\"], function( InkElement, InkEvent, Css, Common, InkArray, Selector) {\n    'use strict';\n\n    // Higher order functions\n    var hAddClassName = function (element) {\n        return function (className) {return Css.addClassName(element, className);};\n    };\n    var hRemoveClassName = function (element) {\n        return function (className) {return Css.removeClassName(element, className);};\n    };\n\n    /**\n     * @namespace Ink.UI.Droppable\n     * @version 1\n     * @static\n     */\n    var Droppable = {\n        /**\n         * Flag to activate debug mode\n         *\n         * @property debug\n         * @type {Boolean}\n         * @private\n         */\n        debug: false,\n\n        /**\n         * Array with the data of each element (`{element: ..., data: ..., options: ...}`)\n         * \n         * @property _droppables\n         * @type {Array}\n         * @private\n         */\n        _droppables: [],\n\n        /**\n         * Array of data for each draggable. (`{element: ..., data: ...}`)\n         *\n         * @property _draggables\n         * @type {Array}\n         * @private\n         */\n        _draggables: [],\n\n        /**\n         * Makes an element droppable.\n         * This method adds it to the stack of droppable elements.\n         * Can consider it a constructor of droppable elements, but where no Droppable object is returned.\n         *\n         * The onHover, onDrop, and onDropOut options below can be:\n         *\n         * - 'move', 'copy': Move or copy the draggable element into this droppable.\n         * - 'revert': Make the draggable go back to where it came from.\n         * - A function (draggableElement, droppableElement), defining what you want to do in this case.\n         *\n         * @method add\n         * @param {String|DOMElement}   element                 Target element\n         * @param {Object}              [options]               Options object\n         * @param {String}              [options.hoverClass]    Classname(s) applied when an acceptable draggable element is hovering the element\n         * @param {String}              [options.accept]        Selector for choosing draggables which can be dropped in this droppable.\n         * @param {Function}            [options.onHover]       Called when an acceptable element is hovering the droppable (see above for string options).\n         * @param {Function|String}     [options.onDrop]        Called when an acceptable element is dropped (see above for string options). \n         * @param {Function|String}     [options.onDropOut]     Called when a droppable is dropped outside this droppable (see above for string options).\n         * @public\n         *\n         * @sample Ink_UI_Droppable_1.html\n         *\n         */\n        add: function(element, options) {\n            element = Common.elOrSelector(element, 'Droppable.add target element');\n\n            var opt = Ink.extendObj({\n                hoverClass:     options.hoverclass /* old name */ || false,\n                accept:         false,\n                onHover:        false,\n                onDrop:         false,\n                onDropOut:      false\n            }, options || {}, InkElement.data(element));\n            \n            if (typeof opt.hoverClass === 'string') {\n                opt.hoverClass = opt.hoverClass.split(/\\s+/);\n            }\n            \n            function cleanStyle(draggable) {\n                draggable.style.position = 'inherit';\n            }\n            var that = this;\n            var namedEventHandlers = {\n                move: function (draggable, droppable/*, event*/) {\n                    cleanStyle(draggable);\n                    droppable.appendChild(draggable);\n                },\n                copy: function (draggable, droppable/*, event*/) {\n                    cleanStyle(draggable);\n                    droppable.appendChild(draggable.cloneNode(true));\n                },\n                revert: function (draggable/*, droppable, event*/) {\n                    that._findDraggable(draggable).originalParent.appendChild(draggable);\n                    cleanStyle(draggable);\n                }\n            };\n            var name;\n\n            if (typeof opt.onHover === 'string') {\n                name = opt.onHover;\n                opt.onHover = namedEventHandlers[name];\n                if (opt.onHover === undefined) {\n                    throw new Error('Unknown hover event handler: ' + name);\n                }\n            }\n            if (typeof opt.onDrop === 'string') {\n                name = opt.onDrop;\n                opt.onDrop = namedEventHandlers[name];\n                if (opt.onDrop === undefined) {\n                    throw new Error('Unknown drop event handler: ' + name);\n                }\n            }\n            if (typeof opt.onDropOut === 'string') {\n                name = opt.onDropOut;\n                opt.onDropOut = namedEventHandlers[name];\n                if (opt.onDropOut === undefined) {\n                    throw new Error('Unknown dropOut event handler: ' + name);\n                }\n            }\n\n            var elementData = {\n                element: element,\n                data: {},\n                options: opt\n            };\n            this._droppables.push(elementData);\n            this._update(elementData);\n        },\n        \n        /**\n         * Finds droppable data about `element`. this data is added in `.add`\n         *\n         * @method _findData\n         * @param {DOMElement} element  Needle\n         * @return {object}             Droppable data of the element\n         * @private\n         */\n        _findData: function (element) {\n            var elms = this._droppables;\n            for (var i = 0, len = elms.length; i < len; i++) {\n                if (elms[i].element === element) {\n                    return elms[i];\n                }\n            }\n        },\n        /**\n         * Finds draggable data about `element`\n         *\n         * @method _findDraggable\n         * @param {DOMElement} element  Needle\n         * @return {Object}             Draggable data queried\n         * @private\n         */\n        _findDraggable: function (element) {\n            var elms = this._draggables;\n            for (var i = 0, len = elms.length; i < len; i++) {\n                if (elms[i].element === element) {\n                    return elms[i];\n                }\n            }\n        },\n\n        /**\n         * Invoke every time a drag starts\n         * \n         * @method updateAll\n         * @private\n         */\n        updateAll: function() {\n            InkArray.each(this._droppables, Droppable._update);\n        },\n\n        /**\n         * Updates location and size of droppable element\n         * \n         * @method update\n         * @param {String|DOMElement} element Target element\n         * @public\n         */\n        update: function(element) {\n            this._update(this._findData(element));\n        },\n\n        _update: function(elementData) {\n            var data = elementData.data;\n            var element = elementData.element;\n            data.left   = InkElement.offsetLeft(element);\n            data.top    = InkElement.offsetTop( element);\n            data.right  = data.left + InkElement.elementWidth( element);\n            data.bottom = data.top  + InkElement.elementHeight(element);\n        },\n\n        /**\n         * Removes an element from the droppable stack and removes the droppable behavior\n         * \n         * @method remove\n         * @param {String|DOMElement} elOrSelector  Droppable element to disable.\n         * @return {Boolean} Whether the object was found and deleted\n         * @public\n         */\n        remove: function(el) {\n            el = Common.elOrSelector(el);\n            var len = this._droppables.length;\n            for (var i = 0; i < len; i++) {\n                if (this._droppables[i].element === el) {\n                    this._droppables.splice(i, 1);\n                    break;\n                }\n            }\n            return len !== this._droppables.length;\n        },\n\n        /**\n         * Executes an action on a droppable\n         * \n         * @method action\n         * @param {Object} coords       Coordinates where the action happened\n         * @param {String} type         Type of action. 'drag' or 'drop'.\n         * @param {Object} ev           Event object\n         * @param {Object} draggable    Draggable element\n         * @private\n         */\n        action: function(coords, type, ev, draggable) {\n            // check all droppable elements\n            InkArray.each(this._droppables, Ink.bind(function(elementData) {\n                var data = elementData.data;\n                var opt = elementData.options;\n                var element = elementData.element;\n\n                if (opt.accept && !Selector.matches(opt.accept, [draggable]).length) {\n                    return;\n                }\n\n                if (type === 'drag' && !this._findDraggable(draggable)) {\n                    this._draggables.push({\n                        element: draggable,\n                        originalParent: draggable.parentNode\n                    });\n                }\n\n                // check if our draggable is over our droppable\n                if (coords.x >= data.left && coords.x <= data.right &&\n                        coords.y >= data.top && coords.y <= data.bottom) {\n                    // INSIDE\n                    if (type === 'drag') {\n                        if (opt.hoverClass) {\n                            InkArray.each(opt.hoverClass,\n                                hAddClassName(element));\n                        }\n                        if (opt.onHover) {\n                            opt.onHover(draggable, element);\n                        }\n                    } else if (type === 'drop') {\n                        if (opt.hoverClass) {\n                            InkArray.each(opt.hoverClass,\n                                hRemoveClassName(element));\n                        }\n                        if (opt.onDrop) {\n                            opt.onDrop(draggable, element, ev);\n                        }\n                    }\n                } else {\n                    // OUTSIDE\n\n                    if (type === 'drag' && opt.hoverClass) {\n                        InkArray.each(opt.hoverClass, hRemoveClassName(element));\n                    } else if (type === 'drop') {\n                        if(opt.onDropOut){\n                            opt.onDropOut(draggable, element, ev);\n                        }\n                    }\n                }\n            }, this));\n        }\n    };\n\n    return Droppable;\n});\n","/**\n * Form Validation\n * @module Ink.UI.FormValidator_1\n * @version 1\n **/\n\nInk.createModule('Ink.UI.FormValidator', '1', ['Ink.Dom.Element_1', 'Ink.Dom.Css_1','Ink.Util.Validator_1','Ink.Dom.Selector_1'], function( InkElement, Css, InkValidator , Selector) {\n    'use strict';\n\n    function elementsWithSameName(elm) {\n        if (!elm.name) { return []; }\n        if (!elm.form) {\n            return Selector.select('name=\"' + elm.name + '\"');\n        }\n        var ret = elm.form[elm.name];\n        if(typeof(ret.length) === 'undefined') {\n            ret = [ret];\n        }\n        return ret;\n    }\n    /**\n     * @namespace Ink.UI.FormValidator\n     * @version 1\n     */\n    var FormValidator = {\n\n        /**\n         * Specifies the version of the component\n         *\n         * @property version\n         * @type {String}\n         * @readOnly\n         * @public\n         */\n        version: '1',\n\n        /**\n         * Available flags to use in the validation process.\n         * The keys are the 'rules', and their values are objects with the key 'msg', determining\n         * what is the error message.\n         *\n         * @property _flagMap\n         * @type {Object}\n         * @readOnly\n         * @private\n         */\n        _flagMap: {\n            //'ink-fv-required': {msg: 'Campo obrigat&oacute;rio'},\n            'ink-fv-required': {msg: 'Required field'},\n            //'ink-fv-email': {msg: 'E-mail inv&aacute;lido'},\n            'ink-fv-email': {msg: 'Invalid e-mail address'},\n            //'ink-fv-url': {msg: 'URL inv&aacute;lido'},\n            'ink-fv-url': {msg: 'Invalid URL'},\n            //'ink-fv-number': {msg: 'N&uacute;mero inv&aacute;lido'},\n            'ink-fv-number': {msg: 'Invalid number'},\n            //'ink-fv-phone_pt': {msg: 'N&uacute;mero de telefone inv&aacute;lido'},\n            'ink-fv-phone_pt': {msg: 'Invalid phone number'},\n            //'ink-fv-phone_cv': {msg: 'N&uacute;mero de telefone inv&aacute;lido'},\n            'ink-fv-phone_cv': {msg: 'Invalid phone number'},\n            //'ink-fv-phone_mz': {msg: 'N&uacute;mero de telefone inv&aacute;lido'},\n            'ink-fv-phone_mz': {msg: 'Invalid phone number'},\n            //'ink-fv-phone_ao': {msg: 'N&uacute;mero de telefone inv&aacute;lido'},\n            'ink-fv-phone_ao': {msg: 'Invalid phone number'},\n            //'ink-fv-date': {msg: 'Data inv&aacute;lida'},\n            'ink-fv-date': {msg: 'Invalid date'},\n            //'ink-fv-confirm': {msg: 'Confirma&ccedil;&atilde;o inv&aacute;lida'},\n            'ink-fv-confirm': {msg: 'Confirmation does not match'},\n            'ink-fv-custom': {msg: ''}\n        },\n\n        /**\n         * This property holds all form elements for later validation\n         *\n         * @property elements\n         * @type {Object}\n         * @public\n         */\n        elements: {},\n\n        /**\n         * This property holds the objects needed to cross-check for the 'confirm' rule\n         *\n         * @property confirmElms\n         * @type {Object}\n         * @public\n         */\n        confirmElms: {},\n\n        /**\n         * This property holds the previous elements in the confirmElms property, but with a\n         * true/false specifying if it has the class ink-fv-confirm.\n         *\n         * @property hasConfirm\n         * @type {Object}\n         */\n        hasConfirm: {},\n\n        /**\n         * Defined class name to use in error messages label\n         *\n         * @property _errorClassName\n         * @type {String}\n         * @readOnly\n         * @private\n         */\n        _errorClassName: 'tip error',\n\n        /**\n         * @property _errorValidationClassName\n         * @type {String}\n         * @readOnly\n         * @private\n         */\n        _errorValidationClassName: 'validaton',\n\n        /**\n         * @property _errorTypeWarningClassName\n         * @type {String}\n         * @readOnly\n         * @private\n         */\n        _errorTypeWarningClassName: 'warning',\n\n        /**\n         * @property _errorTypeErrorClassName\n         * @type {String}\n         * @readOnly\n         * @private\n         */\n        _errorTypeErrorClassName: 'error',\n\n        /**\n         * Checks if a form is valid\n         * \n         * @method validate\n         * @param {DOMElement|String}   elm                     DOM form element or form id\n         * @param {Object}              options                 Configuration options\n         * @param {Function}            [options.onSuccess]     Callback to run when form is valid\n         * @param {Function}            [options.onError]       Callback to run when form is not valid\n         * @param {Array}               [options.customFlag]    Custom flags to use to validate form fields\n         * @public\n         * @return {Boolean} Whether the form is deemed valid or not.\n         *\n         * @sample Ink_UI_FormValidator_1.html\n         */\n        validate: function(elm, options) {\n            this._free();\n\n            options = Ink.extendObj({\n                onSuccess: false,\n                onError: false,\n                customFlag: false,\n                confirmGroup: []\n            }, options || {});\n\n            if(typeof(elm) === 'string') {\n                elm = document.getElementById(elm);\n            }\n            if(elm === null){\n                return false;\n            }\n            this.element = elm;\n\n            if(typeof(this.element.id) === 'undefined' || this.element.id === null || this.element.id === '') {\n                // generate a random ID\n                // TODO ugly and potentially problematic, and you know Murphy's law.\n                this.element.id = 'ink-fv_randomid_'+(Math.round(Math.random() * 99999));\n            }\n\n            this.custom = options.customFlag;\n\n            this.confirmGroup = options.confirmGroup;\n\n            var fail = this._validateElements();\n\n            if(fail.length > 0) {\n                if(options.onError) {\n                    options.onError(fail);\n                } else {\n                    this._showError(elm, fail);\n                }\n                return false;\n            } else {\n                if(!options.onError) {\n                    this._clearError(elm);\n                }\n                this._clearCache();\n                if(options.onSuccess) {\n                    options.onSuccess();\n                }\n                return true;\n            }\n\n        },\n\n        /**\n         * Resets previously generated validation errors\n         * \n         * @method reset\n         * @public\n         */\n        reset: function()\n        {\n            this._clearError();\n            this._clearCache();\n        },\n\n        /**\n         * Cleans the object\n         * \n         * @method _free\n         * @private\n         */\n        _free: function()\n        {\n            this.element = null;\n            //this.elements = [];\n            this.custom = false;\n            this.confirmGroup = false;\n        },\n\n        /**\n         * Cleans the properties responsible for caching\n         * \n         * @method _clearCache\n         * @private\n         */\n        _clearCache: function()\n        {\n            this.element = null;\n            this.elements = [];\n            this.custom = false;\n            this.confirmGroup = false;\n        },\n\n        /**\n         * Gets the form elements and stores them in the caching properties\n         * \n         * @method _getElements\n         * @private\n         */\n        _getElements: function()\n        {\n            //this.elements = [];\n            // if(typeof(this.elements[this.element.id]) !== 'undefined') {\n            //     return;\n            // }\n\n            var elements = this.elements[this.element.id] = [];\n            this.confirmElms[this.element.id] = [];\n            //console.log(this.element);\n            //console.log(this.element.elements);\n            var formElms = Selector.select(':input', this.element);\n            var curElm = false;\n            for(var i=0, totalElm = formElms.length; i < totalElm; i++) {\n                curElm = formElms[i];\n                var type = (curElm.getAttribute('type') + '').toLowerCase();\n\n                if (type === 'radio' || type === 'checkbox') {\n                    if(elements.length === 0 ||\n                            (\n                             curElm.getAttribute('type') !== elements[elements.length - 1].getAttribute('type') &&\n                            curElm.getAttribute('name') !== elements[elements.length - 1].getAttribute('name')\n                            )) {\n                        for(var flag in this._flagMap) {\n                            if(Css.hasClassName(curElm, flag)) {\n                                elements.push(curElm);\n                                break;\n                            }\n                        }\n                    }\n                } else {\n                    for(var flag2 in this._flagMap) {\n                        if(Css.hasClassName(curElm, flag2) && flag2 !== 'ink-fv-confirm') {\n                            /*if(flag2 == 'ink-fv-confirm') {\n                                this.confirmElms[this.element.id].push(curElm);\n                                this.hasConfirm[this.element.id] = true;\n                            }*/\n                            elements.push(curElm);\n                            break;\n                        }\n                    }\n\n                    if(Css.hasClassName(curElm, 'ink-fv-confirm')) {\n                        this.confirmElms[this.element.id].push(curElm);\n                        this.hasConfirm[this.element.id] = true;\n                    }\n\n                }\n            }\n        },\n\n        /**\n         * Runs the validation for each element\n         * \n         * @method _validateElements\n         * @private\n         */\n        _validateElements: function() {\n            var oGroups;\n            this._getElements();\n            if(this.hasConfirm[this.element.id] === true) {\n                oGroups = this._makeConfirmGroups();\n            }\n\n            var errors = [];\n\n            var curElm = false;\n            var customErrors = false;\n            var inArray;\n            for(var i=0, totalElm = this.elements[this.element.id].length; i < totalElm; i++) {\n                inArray = false;\n                curElm = this.elements[this.element.id][i];\n\n                if(!curElm.disabled) {\n                    for(var flag in this._flagMap) {\n                        if(Css.hasClassName(curElm, flag)) {\n                            if(flag !== 'ink-fv-custom' && flag !== 'ink-fv-confirm') {\n                                if(!this._isValid(curElm, flag)) {\n                                    if(!inArray) {\n                                        errors.push({elm: curElm, errors:[flag]});\n                                        inArray = true;\n                                    } else {\n                                        errors[(errors.length - 1)].errors.push(flag);\n                                    }\n                                }\n                            } else if(flag !== 'ink-fv-confirm'){\n                                customErrors = this._isCustomValid(curElm);\n                                if(customErrors.length > 0) {\n                                    errors.push({elm: curElm, errors:[flag], custom: customErrors});\n                                }\n                            } else if(flag === 'ink-fv-confirm'){\n                                continue;\n                            }\n                        }\n                    }\n                }\n            }\n            errors = this._validateConfirmGroups(oGroups, errors);\n            //console.log(InkDumper.returnDump(errors));\n            return errors;\n        },\n\n        /**\n         * Runs the 'confirm' validation for each group of elements\n         * \n         * @method _validateConfirmGroups\n         * @param {Array} oGroups Array/Object that contains the group of confirm objects\n         * @param {Array} errors Array that will store the errors\n         * @private\n         * @return {Array} Array of errors that was passed as 2nd parameter (either changed, or not, depending if errors were found).\n         */\n        _validateConfirmGroups: function(oGroups, errors) {\n            //console.log(oGroups);\n            var curGroup = false;\n            for(var i in oGroups) if (oGroups.hasOwnProperty(i)) {\n                curGroup = oGroups[i];\n                if(curGroup.length === 2) {\n                    if(curGroup[0].value !== curGroup[1].value) {\n                        errors.push({elm:curGroup[1], errors:['ink-fv-confirm']});\n                    }\n                }\n            }\n            return errors;\n        },\n\n        /**\n         * Creates the groups of 'confirm' objects\n         * \n         * @method _makeConfirmGroups\n         * @private\n         * @return {Array|Boolean} Returns the array of confirm elements or false on error.\n         */\n        _makeConfirmGroups: function()\n        {\n            var oGroups;\n            if(this.confirmGroup && this.confirmGroup.length > 0) {\n                oGroups = {};\n                var curElm = false;\n                var curGroup = false;\n                //this.confirmElms[this.element.id];\n                for(var i=0, total=this.confirmElms[this.element.id].length; i < total; i++) {\n                    curElm = this.confirmElms[this.element.id][i];\n                    for(var j=0, totalG=this.confirmGroup.length; j < totalG; j++) {\n                        curGroup =  this.confirmGroup[j];\n                        if(Css.hasClassName(curElm, curGroup)) {\n                            if(typeof(oGroups[curGroup]) === 'undefined') {\n                                oGroups[curGroup] = [curElm];\n                            } else {\n                                oGroups[curGroup].push(curElm);\n                            }\n                        }\n                    }\n                }\n                return oGroups;\n            } else {\n                if(this.confirmElms[this.element.id].length === 2) {\n                    oGroups = {\n                        \"ink-fv-confirm\": [\n                            this.confirmElms[this.element.id][0],\n                            this.confirmElms[this.element.id][1]\n                        ]\n                    };\n                }\n                return oGroups;\n            }\n            return false;\n        },\n\n        /**\n         * Validates an element with a custom validation\n         * \n         * @method _isCustomValid\n         * @param {DOMElemenmt} elm Element to be validated\n         * @private\n         * @return {Array} Array of errors. If no errors are found, results in an empty array.\n         */\n        _isCustomValid: function(elm)\n        {\n            var customErrors = [];\n            var curFlag = false;\n            for(var i=0, tCustom = this.custom.length; i < tCustom; i++) {\n                curFlag = this.custom[i];\n                if(Css.hasClassName(elm, curFlag.flag)) {\n                    if(!curFlag.callback(elm, curFlag.msg)) {\n                        customErrors.push({flag: curFlag.flag, msg: curFlag.msg});\n                    }\n                }\n            }\n            return customErrors;\n        },\n\n        /**\n         * Runs the normal validation functions for a specific element\n         * \n         * @method _isValid\n         * @param {DOMElement} elm DOMElement that will be validated\n         * @param {String} fieldType Rule to be validated. This must be one of the keys present in the _flagMap property.\n         * @private\n         * @return {Boolean} The result of the validation.\n         */\n        _isValid: function(elm, fieldType) {\n            var nodeName = elm.nodeName.toLowerCase();\n            var inputType = (elm.getAttribute('type') || '').toLowerCase();\n            var value = this._trim(elm.value);\n\n            // When we're analyzing emails, telephones, etc, and the field is\n            // empty, we check if it is required. If not required, it's valid.\n            if (fieldType !== 'ink-fv-required' &&\n                    inputType !== 'checkbox' && inputType !== 'radio' &&\n                    value === '') {\n                return !Css.hasClassName(elm, 'ink-fv-required');\n            }\n\n            switch(fieldType) {\n                case 'ink-fv-required':\n                    if(nodeName === 'select') {\n                        if(elm.selectedIndex > 0) {\n                            return true;\n                        } else {\n                            return false;\n                        }\n                    }\n                    if(inputType !== 'checkbox' && inputType !== 'radio' &&\n                            value !== '') {\n                        return true;  // A input type=text,email,etc.\n                    } else if(inputType === 'checkbox' || inputType === 'radio') {\n                        var aFormRadios = elementsWithSameName(elm);\n                        var isChecked = false;\n                        // check if any input of the radio is checked\n                        for(var i=0, totalRadio = aFormRadios.length; i < totalRadio; i++) {\n                            if(aFormRadios[i].checked === true) {\n                                isChecked = true;\n                                break;\n                            }\n                        }\n                        return isChecked;\n                    }\n                    return false;\n\n                case 'ink-fv-email':\n                    return InkValidator.mail(elm.value);\n\n                case 'ink-fv-url':\n                    return InkValidator.url(elm.value);\n\n                case 'ink-fv-number':\n                    return !isNaN(Number(elm.value)) && isFinite(Number(elm.value));\n\n                case 'ink-fv-phone_pt':\n                    return InkValidator.isPTPhone(elm.value);\n\n                case 'ink-fv-phone_cv':\n                    return InkValidator.isCVPhone(elm.value);\n\n                case 'ink-fv-phone_ao':\n                    return InkValidator.isAOPhone(elm.value);\n\n                case 'ink-fv-phone_mz':\n                    return InkValidator.isMZPhone(elm.value);\n\n                case 'ink-fv-date':\n                    var Element = Ink.getModule('Ink.Dom.Element',1);\n                    var dataset = Element.data( elm );\n                    var validFormat = 'yyyy-mm-dd';\n\n                    if( Css.hasClassName(elm, 'ink-datepicker') && ('format' in dataset) ){\n                        validFormat = dataset.format;\n                    } else if( ('validFormat' in dataset) ){\n                        validFormat = dataset.validFormat;\n                    }\n\n                    if( !(validFormat in InkValidator._dateParsers ) ){\n                        var validValues = [];\n                        for( var val in InkValidator._dateParsers ){\n                            if (InkValidator._dateParsers.hasOwnProperty(val)) {\n                                validValues.push(val);\n                            }\n                        }\n                        throw new Error(\n                            'The attribute data-valid-format must be one of ' +\n                            'the following values: ' + validValues.join(', '));\n                    }\n                    \n                    return InkValidator.isDate( validFormat, elm.value );\n                case 'ink-fv-custom':\n                    break;\n            }\n\n            return false;\n        },\n\n        /**\n         * Makes the necessary changes to the markup to show the errors of a given element\n         * \n         * @method _showError\n         * @param {DOMElement} formElm The form element to be changed to show the errors\n         * @param {Array} aFail An array with the errors found.\n         * @private\n         */\n        _showError: function(formElm, aFail) {\n            this._clearError(formElm);\n\n            //ink-warning-field\n\n            //console.log(aFail);\n            var curElm = false;\n            for(var i=0, tFail = aFail.length; i < tFail; i++) {\n                curElm = aFail[i].elm;\n                if (curElm) {\n                    this._showAnErrorOnElement(curElm, aFail[i]);\n                }\n            }\n        },\n\n        _showAnErrorOnElement: function (curElm, error) {\n            /* jshint noempty:false */\n\n            var controlGroupElm = InkElement.findUpwardsByClass(\n                    curElm, 'control-group');\n            var controlElm = InkElement.findUpwardsByClass(\n                    curElm, 'control');\n\n            var errorClasses = [\n                this._errorClassName,\n                this._errorTypeClassName].join(' ');\n\n            var errorMsg = InkElement.create('p', {\n                className: errorClasses\n            });\n\n            if(error.errors[0] !== 'ink-fv-custom') {\n                errorMsg.innerHTML = this._flagMap[error.errors[0]].msg;\n            } else {\n                errorMsg.innerHTML = error.custom[0].msg;\n            }\n\n            var target = (controlElm || controlGroupElm);\n            if (target) {\n                target.appendChild(errorMsg);\n            } else {\n                InkElement.insertAfter(errorMsg, curElm);\n            }\n\n            if (controlElm) {\n                if(error.errors[0] === 'ink-fv-required') {\n                    Css.addClassName(controlGroupElm, 'validation error');\n                } else {\n                    Css.addClassName(controlGroupElm, 'validation warning');\n                }\n            }\n        },\n\n        /**\n         * Clears the error of a given element. Normally executed before any validation, for all elements, as a reset.\n         * \n         * @method _clearErrors\n         * @param {DOMElement} formElm Form element to be cleared.\n         * @private\n         */\n        _clearError: function(formElm) {\n            //return;\n            var aErrorLabel = formElm.getElementsByTagName('p');\n\n            var curElm;\n            var control;\n\n            for(var i = (aErrorLabel.length - 1); i >= 0; i--) {\n                curElm = aErrorLabel[i];\n                if(Css.hasClassName(curElm, this._errorClassName)) {\n                    control = InkElement.findUpwardsBySelector(curElm, '.control-group');\n                    if (control) {\n                        Css.removeClassName(control, ['validation', 'error', 'warning']);\n                    }\n\n                    if(Css.hasClassName(curElm, this._errorClassName, true /*both*/)) {\n                        InkElement.remove(curElm);\n                    }\n                }\n            }\n\n            var aErrorLabel2 = formElm.getElementsByTagName('ul');\n            for(i = (aErrorLabel2.length - 1); i >= 0; i--) {\n                curElm = aErrorLabel2[i];\n                if(Css.hasClassName(curElm, 'control-group')) {\n                    Css.removeClassName(curElm, 'validation error');\n                }\n            }\n        },\n\n        /**\n         * Removes unnecessary spaces to the left or right of a string\n         * \n         * @method _trim\n         * @param {String} stri String to be trimmed\n         * @private\n         * @return {String|undefined} String trimmed.\n         */\n        _trim: function(str)\n        {\n            if(typeof(str) === 'string')\n            {\n                return str.replace(/^\\s+|\\s+$|\\n+$/g, '');\n            }\n        }\n    };\n\n    return FormValidator;\n\n});","/**\n * Form Validation\n * @module Ink.UI.FormValidator_2\n * @version 2\n */\n\nInk.createModule('Ink.UI.FormValidator', '2', [ 'Ink.UI.Common_1','Ink.Dom.Element_1','Ink.Dom.Event_1','Ink.Dom.Selector_1','Ink.Dom.Css_1','Ink.Util.Array_1','Ink.Util.I18n_1','Ink.Util.Validator_1'], function( Common, Element, Event, Selector, Css, InkArray, I18n, InkValidator ) {\n    'use strict';\n\n    /**\n     * Validation Functions to be used\n     *\n     * Some functions are a port from PHP, others are the 'best' solutions available\n     *\n     * @class FormValidator.validationFunctions\n     * @static\n     */\n    var validationFunctions = {\n\n        /**\n         * Checks if a value is defined and not empty\n         * @method required\n         * @return {Boolean}       True case is defined, false if it's empty or not defined.\n         */\n        'required': function( value ){\n            return ( (typeof value !== 'undefined') && ( !(/^\\s*$/).test(value) ) );\n        },\n\n        /**\n         * Checks if a value has a minimum length\n         *\n         * @method min_length\n         * @param  {String|Number}  minSize Minimum number of characters.\n         * @return {Boolean}                True if the length of value is equal or bigger than the minimum chars defined. False if not.\n         */\n        'min_length': function( value, minSize ){\n            return ( (typeof value === 'string') && ( value.length >= parseInt(minSize,10) ) );\n        },\n\n        /**\n         * Checks if a value has a maximum length\n         *\n         * @method max_length\n         * @param  {String|Number}  maxSize Maximum number of characters.\n         * @return {Boolean}         True if the length of value is equal or smaller than the maximum chars defined. False if not.\n         */\n        'max_length': function( value, maxSize ){\n            return ( (typeof value === 'string') && ( value.length <= parseInt(maxSize,10) ) );\n        },\n\n        /**\n         * Checks if a value has an exact length\n         *\n         * @method exact_length\n         * @param  {String|Number}  exactSize   Exact number of characters.\n         * @return {Boolean}                    True if the length of value is equal to the size defined. False if not.\n         */\n        'exact_length': function( value, exactSize ){\n            return ( (typeof value === 'string') && ( value.length === parseInt(exactSize,10) ) );\n        },\n\n        /**\n         * Checks if a value is a valid email address\n         *\n         * @method email\n         * @return {Boolean}         True if the value is a valid email address. False if not.\n         */\n        'email': function( value ){\n            return ( ( typeof value === 'string' ) && InkValidator.mail( value ) );\n        },\n\n        /**\n         * Checks if a value has a valid URL\n         *\n         * @method url\n         * @param  {Boolean} fullCheck  Flag to validate a full url (with the protocol).\n         * @return {Boolean}            True if the URL is considered valid. False if not.\n         */\n        'url': function( value, fullCheck ){\n            fullCheck = fullCheck || false;\n            return ( (typeof value === 'string') && InkValidator.url( value, fullCheck ) );\n        },\n\n        /**\n         * Checks if a value is a valid IP. Supports ipv4 and ipv6\n         *\n         * @method ip\n         * @param  {String} ipType Type of IP to be validated. The values are: ipv4, ipv6. By default is ipv4.\n         * @return {Boolean}         True if the value is a valid IP address. False if not.\n         */\n        'ip': function( value, ipType ){\n            if( typeof value !== 'string' ){\n                return false;\n            }\n\n            return InkValidator.isIP(value, ipType);\n        },\n\n        /**\n         * Checks if a value is a valid phone number.\n         * Supports several countries, based in the Ink.Util.Validator class.\n         *\n         * @method phone\n         * @param  {String} phoneType Country's initials to specify the type of phone number to be validated. Ex: 'AO'.\n         * @return {Boolean}         True if it's a valid phone number. False if not.\n         */\n        'phone': function( value, phoneType ){\n            if( typeof value !== 'string' ){\n                return false;\n            }\n\n            var countryCode = phoneType ? phoneType.toUpperCase() : '';\n\n            return InkValidator['is' + countryCode + 'Phone'](value);\n        },\n\n        /**\n         * Checks if a value is a valid credit card.\n         *\n         * @method credit_card\n         * @param  {String} cardType Type of credit card to be validated. The card types available are in the Ink.Util.Validator class.\n         * @return {Boolean}         True if the value is a valid credit card number. False if not.\n         */\n        'credit_card': function( value, cardType ){\n            if( typeof value !== 'string' ){\n                return false;\n            }\n\n            return InkValidator.isCreditCard( value, cardType || 'default' );\n        },\n\n        /**\n         * Checks if a value is a valid date.\n         *\n         * @method date\n         * @param  {String} format Specific format of the date.\n         * @return {Boolean}         True if the value is a valid date. False if not.\n         */\n        'date': function( value, format ){\n            return ( (typeof value === 'string' ) && InkValidator.isDate(format, value) );\n        },\n\n        /**\n         * Checks if a value only contains alphabetical values.\n         *\n         * @method alpha\n         * @param  {Boolean} supportSpaces  Allow whitespace\n         * @return {Boolean}                True if the value is alphabetical-only. False if not.\n         */\n        'alpha': function( value, supportSpaces ){\n            return InkValidator.ascii(value, {singleLineWhitespace: supportSpaces});\n        },\n\n        /*\n         * Checks if a value contains only printable BMP unicode characters\n         * Optionally allow punctuation and whitespace\n         *\n         * @method text\n         * @return {Boolean}        Whether the value only contains printable text characters\n         **/\n        'text': function (value, whitespace, punctuation) {\n            return InkValidator.unicode(value, {\n                singleLineWhitespace: whitespace,\n                unicodePunctuation: punctuation});\n        },\n\n        /*\n         * Checks if a value contains only printable latin-1 text characters.\n         * Optionally allow punctuation and whitespace.\n         *\n         * @method text\n         * @return {Boolean}        Whether the value only contains printable text characters\n         **/\n        'latin': function (value, punctuation, whitespace) {\n            if ( typeof value !== 'string') { return false; }\n            return InkValidator.latin1(value, {latin1Punctuation: punctuation, singleLineWhitespace: whitespace});\n        },\n\n        /**\n         * Checks if a value contains only alphabetical or numerical characters.\n         *\n         * @method alpha_numeric\n         * @return {Boolean}         True if the value is a valid alphanumerical. False if not.\n         */\n        'alpha_numeric': function( value ){\n            return InkValidator.ascii(value, {numbers: true});\n        },\n\n        /**\n         * Checks if a value contains only alphabetical, dash or underscore characteres.\n         *\n         * @method alpha_dash\n         * @return {Boolean}         True if the value is a valid. False if not.\n         */\n        'alpha_dash': function( value ){\n            return InkValidator.ascii(value, {dash: true, underscore: true});\n        },\n\n        /**\n         * Checks if a value is a single digit.\n         *\n         * @method digit\n         * @return {Boolean}         True if the value is a valid digit. False if not.\n         */\n        'digit': function( value ){\n            return ((typeof value === 'string') && /^[0-9]{1}$/.test(value));\n        },\n\n        /**\n         * Checks if a value is a valid integer.\n         *\n         * @method integer\n         * @param  {String} positive Flag that specifies if the integer is must be positive (unsigned).\n         * @return {Boolean}         True if the value is a valid integer. False if not.\n         */\n        'integer': function( value, positive ){\n            return InkValidator.number(value, {\n                negative: !positive,\n                decimalPlaces: 0\n            });\n        },\n\n        /**\n         * Checks if a value is a valid decimal number.\n         *\n         * @method decimal\n         * @param  {String} decimalSeparator Character that splits the integer part from the decimal one. By default is '.'.\n         * @param  {String} [decimalPlaces] Maximum number of digits that the decimal part must have.\n         * @param  {String} [leftDigits] Maximum number of digits that the integer part must have, when provided.\n         * @return {Boolean}         True if the value is a valid decimal number. False if not.\n         */\n        'decimal': function( value, decimalSeparator, decimalPlaces, leftDigits ){\n            return InkValidator.number(value, {\n                decimalSep: decimalSeparator || '.',\n                decimalPlaces: +decimalPlaces || null,\n                maxDigits: +leftDigits\n            });\n        },\n\n        /**\n         * Checks if a value is a numeric value.\n         *\n         * @method numeric\n         * @param  {String} decimalSeparator    Checks if it's a valid decimal. Otherwise checks if it's a valid integer.\n         * @param  {String} [decimalPlaces]     Maximum number of digits the decimal part must have.\n         * @param  {String} [leftDigits]        Maximum number of digits the integer part must have, when provided.\n         * @return {Boolean}         True if the value is numeric. False if not.\n         */\n        'numeric': function( value, decimalSeparator, decimalPlaces, leftDigits ){\n            decimalSeparator = decimalSeparator || '.';\n            if( value.indexOf(decimalSeparator) !== -1  ){\n                return validationFunctions.decimal( value, decimalSeparator, decimalPlaces, leftDigits );\n            } else {\n                return validationFunctions.integer( value );\n            }\n        },\n\n        /**\n         * Checks if a value is in a specific range of values.\n         * The parameters after the first one are used to specify the range, and are similar in function to python's range() function.\n         *\n         * @method range\n         * @param  {String} minValue        Left limit of the range.\n         * @param  {String} maxValue        Right limit of the range.\n         * @param  {String} [multipleOf]    In case you want numbers that are only multiples of another number.\n         * @return {Boolean}                True if the value is within the range. False if not.\n         */\n        'range': function( value, minValue, maxValue, multipleOf ){\n            value = +value;\n            minValue = +minValue;\n            maxValue = +maxValue;\n\n            if (isNaN(value) || isNaN(minValue) || isNaN(maxValue)) {\n                return false;\n            }\n\n            if( value < minValue || value > maxValue ){\n                return false;\n            }\n\n            if (multipleOf) {\n                return (value - minValue) % multipleOf === 0;\n            } else {\n                return true;\n            }\n        },\n\n        /**\n         * Checks if a value is a valid color.\n         *\n         * @method color\n         * @return {Boolean}         True if the value is a valid color. False if not.\n         */\n        'color': function( value ){\n            return InkValidator.isColor(value);\n        },\n\n        /**\n         * Checks if a value matches the value of a different field.\n         *\n         * @method matches\n         * @param  {String} fieldToCompare  Name or ID of the field to compare.\n         * @return {Boolean}         True if the values match. False if not.\n         */\n        'matches': function( value, fieldToCompare ){\n            return ( value === this.getFormElements()[fieldToCompare][0].getValue() );\n        }\n\n    };\n\n    /**\n     * Error messages for the validation functions above\n     * @private\n     * @static\n     */\n    var validationMessages = new I18n({\n        en_US: {\n            'formvalidator.required' : 'The {field} filling is mandatory',\n            'formvalidator.min_length': 'The {field} must have a minimum size of {param1} characters',\n            'formvalidator.max_length': 'The {field} must have a maximum size of {param1} characters',\n            'formvalidator.exact_length': 'The {field} must have an exact size of {param1} characters',\n            'formvalidator.email': 'The {field} must have a valid e-mail address',\n            'formvalidator.url': 'The {field} must have a valid URL',\n            'formvalidator.ip': 'The {field} does not contain a valid {param1} IP address',\n            'formvalidator.phone': 'The {field} does not contain a valid {param1} phone number',\n            'formvalidator.credit_card': 'The {field} does not contain a valid {param1} credit card',\n            'formvalidator.date': 'The {field} should contain a date in the {param1} format',\n            'formvalidator.alpha': 'The {field} should only contain letters',\n            'formvalidator.text': 'The {field} should only contain alphabetic characters',\n            'formvalidator.latin': 'The {field} should only contain alphabetic characters',\n            'formvalidator.alpha_numeric': 'The {field} should only contain letters or numbers',\n            'formvalidator.alpha_dash': 'The {field} should only contain letters or dashes',\n            'formvalidator.digit': 'The {field} should only contain a digit',\n            'formvalidator.integer': 'The {field} should only contain an integer',\n            'formvalidator.decimal': 'The {field} should contain a valid decimal number',\n            'formvalidator.numeric': 'The {field} should contain a number',\n            'formvalidator.range': 'The {field} should contain a number between {param1} and {param2}',\n            'formvalidator.color': 'The {field} should contain a valid color',\n            'formvalidator.matches': 'The {field} should match the field {param1}',\n            'formvalidator.validation_function_not_found': 'The rule {rule} has not been defined'\n        },\n        pt_PT: {\n            'formvalidator.required' : 'Preencher {field} é obrigatório',\n            'formvalidator.min_length': '{field} deve ter no mínimo {param1} caracteres',\n            'formvalidator.max_length': '{field} tem um tamanho máximo de {param1} caracteres',\n            'formvalidator.exact_length': '{field} devia ter exactamente {param1} caracteres',\n            'formvalidator.email': '{field} deve ser um e-mail válido',\n            'formvalidator.url': 'O {field} deve ser um URL válido',\n            'formvalidator.ip': '{field} não tem um endereço IP {param1} válido',\n            'formvalidator.phone': '{field} deve ser preenchido com um número de telefone {param1} válido.',\n            'formvalidator.credit_card': '{field} não tem um cartão de crédito {param1} válido',\n            'formvalidator.date': '{field} deve conter uma data no formato {param1}',\n            'formvalidator.alpha': 'O campo {field} deve conter apenas caracteres alfabéticos',\n            'formvalidator.text': 'O campo {field} deve conter apenas caracteres alfabéticos',\n            'formvalidator.latin': 'O campo {field} deve conter apenas caracteres alfabéticos',\n            'formvalidator.alpha_numeric': '{field} deve conter apenas letras e números',\n            'formvalidator.alpha_dash': '{field} deve conter apenas letras e traços',\n            'formvalidator.digit': '{field} destina-se a ser preenchido com apenas um dígito',\n            'formvalidator.integer': '{field} deve conter um número inteiro',\n            'formvalidator.decimal': '{field} deve conter um número válido',\n            'formvalidator.numeric': '{field} deve conter um número válido',\n            'formvalidator.range': '{field} deve conter um número entre {param1} e {param2}',\n            'formvalidator.color': '{field} deve conter uma cor válida',\n            'formvalidator.matches': '{field} deve corresponder ao campo {param1}',\n            'formvalidator.validation_function_not_found': '[A regra {rule} não foi definida]'\n        }\n    }, 'en_US');\n\n    /**\n     * A FormElement represents a single form element to be validated.\n     *\n     * It is constructed with a DOM form element, and options.\n     *\n     * This class contains methods to parse rules and apply them to its element,\n     * and also formats the error messages to be displayed in case of an error.\n     *\n     * You don't normally call \"new FormElement\" yourself. This is done\n     * internally.\n     *\n     * @class FormValidator.FormElement\n     * @constructor\n     * @param  {DOMElement} element DOM Element\n     * @param  {Object} options Object with configuration options\n     * @param  {String} [options.label] Label for this element. It is used in the error message. If not specified, the text in the `label` tag in the control-group is used.\n     * @param  {String} [options.rules] Rules string to be parsed.\n     * @param  {FormValidator} options.form FormValidator instance.\n     */\n    function FormElement(){\n        Common.BaseUIComponent.apply(this, arguments);\n    }\n\n    FormElement._name = 'FormElement_1';\n\n    FormElement._optionDefinition = {\n        label: ['String', null],\n        rules: ['String', null], // The rules to apply\n        form: ['Object']\n    };\n\n    /**\n     * FormElement's prototype\n     */\n    FormElement.prototype = {\n        _init: function () {\n            this._errors = {};\n            this._rules = {};\n            this._value = null;\n\n            if (this._options.label === null) {\n                this._options.label = this._getLabel();\n            }\n        },\n\n        /**\n         * Function to get the label that identifies the field.\n         * If it can't find one, it will use the name or the id\n         * (depending on what is defined)\n         *\n         * @method _getLabel\n         * @return {String} Label to be used in the error messages\n         * @private\n         */\n        _getLabel: function(){\n            var label = Element.findUpwardsBySelector(this._element,'.control-group label');\n\n            if( label ){\n                return Element.textContent(label);\n            } else {\n                return this._element.name || this._element.id || '';\n            }\n        },\n\n        /**\n         * Function to parse a rules' string.\n         * Ex: required|number|max_length[30]\n         *\n         * @method _parseRules\n         * @param  {String} rules String with the rules\n         * @private\n         */\n        _parseRules: function( rules ){\n            this._rules = {};\n            rules = rules.split(\"|\");\n            var i, rulesLength = rules.length, rule, params, paramStartPos ;\n            if( rulesLength > 0 ){\n                for( i = 0; i < rulesLength; i++ ){\n                    rule = rules[i];\n                    if( !rule ){\n                        continue;\n                    }\n\n                    if( ( paramStartPos = rule.indexOf('[') ) !== -1 ){\n                        params = rule.substr( paramStartPos+1 );\n                        params = params.split(']');\n                        params = params[0];\n                        params = params.split(',');\n                        for (var p = 0, len = params.length; p < len; p++) {\n                            params[p] =\n                                params[p] === 'true' ? true :\n                                params[p] === 'false' ? false :\n                                params[p];\n                        }\n                        params.splice(0,0,this.getValue());\n\n                        rule = rule.substr(0,paramStartPos);\n\n                        this._rules[rule] = params;\n                    } else {\n                        this._rules[rule] = [this.getValue()];\n                    }\n                }\n            }\n        },\n\n        /**\n         * Function to add an error to the FormElement's 'errors' object.\n         * It basically receives the rule where the error occurred, the parameters passed to it (if any)\n         * and the error message.\n         * Then it replaces some tokens in the message for a more 'custom' reading\n         *\n         * @method _addError\n         * @param  {String|null} rule    Rule that failed, or null if no rule was found.\n         * @private\n         * @static\n         */\n        _addError: function(rule){\n            var params = this._rules[rule] || [];\n\n            var paramObj = {\n                field: this._options.label,\n                value: this.getValue()\n            };\n\n            for( var i = 1; i < params.length; i++ ){\n                paramObj['param' + i] = params[i];\n            }\n\n            var i18nKey = 'formvalidator.' + rule;\n\n            this._errors[rule] = validationMessages.text(i18nKey, paramObj);\n\n            if (this._errors[rule] === i18nKey) {\n                this._errors[rule] = 'Validation message not found';\n            }\n        },\n\n        /**\n         * Gets an element's value\n         *\n         * @method getValue\n         * @return {mixed} The DOM Element's value\n         * @public\n         */\n        getValue: function(){\n            // TODO this is already implemented in FormSerialize.\n\n            switch(this._element.nodeName.toLowerCase()){\n                case 'select':\n                    return Ink.s('option:selected',this._element).value;\n                case 'textarea':\n                    return this._element.value;\n                case 'input':\n                    if( \"type\" in this._element ){\n                        if( (this._element.type === 'radio') || (this._element.type === 'checkbox') ){\n                            if( this._element.checked ){\n                                return this._element.value;\n                            }\n                        } else if( this._element.type !== 'file' ){\n                            return this._element.value;\n                        }\n                    } else {\n                        return this._element.value;\n                    }\n                    return;\n                default:\n                    return this._element.innerHTML;\n            }\n        },\n\n        /**\n         * Gets the constructed errors' object.\n         *\n         * @method getErrors\n         * @return {Object} Errors' object\n         * @public\n         */\n        getErrors: function(){\n            return this._errors;\n        },\n\n        /**\n         * Gets the DOM element related to the instance.\n         *\n         * @method getElement\n         * @return {Object} DOM Element\n         * @public\n         */\n        getElement: function(){\n            return this._element;\n        },\n\n        /**\n         * Gets other elements in the same form.\n         *\n         * @method getFormElements\n         * @return {Object} A mapping of keys to other elements in this form.\n         * @public\n         */\n        getFormElements: function () {\n            return this._options.form._formElements;\n        },\n\n        /**\n         * Validates the element based on the rules defined.\n         * It parses the rules defined in the _options.rules property.\n         *\n         * @method validate\n         * @return {Boolean} True if every rule was valid. False if one fails.\n         * @public\n         */\n        validate: function(){\n            this._errors = {};\n\n            if( \"rules\" in this._options || 1){\n                this._parseRules( this._options.rules );\n            }\n            \n            if( (\"required\" in this._rules) || (this.getValue() !== '') ){\n                for(var rule in this._rules) {\n                    if (this._rules.hasOwnProperty(rule)) {\n                        if( (typeof validationFunctions[rule] === 'function') ){\n                            if( validationFunctions[rule].apply(this, this._rules[rule] ) === false ){\n\n                                this._addError( rule );\n                                return false;\n\n                            }\n\n                        } else {\n                            Ink.warn('Rule \"' + rule + '\" not found. Used in element:', this._element);\n                            this._addError( null );\n                            return false;\n                        }\n                    }\n                }\n            }\n\n            return true;\n\n        }\n    };\n\n    Common.createUIComponent(FormElement);\n\n\n    /**\n     * @class FormValidator_2\n     * @constructor\n     * @param {String|DOMElement}   selector                        Either a CSS Selector string, or the form's DOMElement\n     * @param {Object}              [options]                       Options object, containing the following options:\n     * @param {String}              [options.eventTrigger]          Event that will trigger the validation. Defaults to 'submit'.\n     * @param {Boolean}             [options.neverSubmit]           Flag to cancel the submit event. Use this to avoid submitting the form.\n     * @param {Selector}            [options.searchFor]             Selector containing the validation data-attributes. Defaults to 'input, select, textarea, .control-group'.\n     * @param {Function}            [options.beforeValidation]      CallationOptions: ['Object', null]\n    };\n\n    Table.prototype = {\n        _validate: function () {\n            if( this._element.nodeName.toLowerCase() !== 'table' ){\n                throw new Error('[Ink.UI.Table] :: The element is not a table');\n            }\n        },\n        /**\n         * Init function called by the constructor\n         * \n         * @method _init\n         * @private\n         */\n        _init: function(){\n            /**\n             * Checking if it's in markup mode or endpoint mode\n             */\n            this._markupMode = !this._options.endpoint;\n\n            if( this._options.visibleFields ){\n                this._options.visibleFields = this._options.visibleFields.toString().split(/[, ]+/g);\n            }\n\n            this._thead = this._element.tHead || this._element.createTHead();\n            this._headers = Selector.select('th', this._thead);\n\n            /**\n             * Initializing variables\n             */\n            this._handlers = {\n                thClick: null\n            };\n            this._originalFields = [\n                // field headers from the DOM\n            ];\n            this._sortableFields = {\n                // Identifies which columns are sorted and how.\n                // columnIndex: 'none'|'asc'|'desc'\n            };\n            this._originalData = this._data = [];\n            this._pagination = null;\n            this._totalRows = 0;\n\n            this._handlers.thClick = Event.observeDelegated(this._element, 'click',\n                    'thead th[data-sortable=\"true\"]',\n                    Ink.bindMethod(this, '_onThClick'));\n\n            /**\n             * If not is in markup mode, we have to do the initial request\n             * to get the first data and the headers\n             */\n            if( !this._markupMode ) {\n                /* Endpoint mode */\n                this._getData(  );\n            } else /* Markup mode */ {\n                this._resetSortOrder();\n                this._addHeadersClasses();\n\n                /**\n                 * Getting the table's data\n                 */\n                this._data = Selector.select('tbody tr', this._element);\n                this._originalData = this._data.slice(0);\n\n                this._totalRows = this._data.length;\n\n                /**\n                 * Set pagination if options tell us to\n                 */\n                this._setPagination();\n            }\n        },\n\n        /**\n         * Add the classes in this._options.tdClassNames to our table headers.\n         * @method _addHeadersClasses\n         * @private\n         */\n        _addHeadersClasses: function () {\n            var headerLabel;\n            var classNames;\n            for (var i = 0, len = this._headers.length; i < len; i++) {\n                headerLabel = Element.textContent(this._headers[i]);\n                classNames = this._options.tdClassNames[headerLabel];\n                // TODO do not find header labels this way. But how?\n                if (classNames) {\n                    Css.addClassName(this._headers[i], classNames);\n                }\n            }\n        },\n\n        /**\n         * Click handler. This will mainly handle the sorting (when you click in the headers)\n         * \n         * @method _onThClick\n         * @param {Event} event Event obj\n         * @private\n         */\n        _onThClick: function( event ){\n            var tgtEl = Event.element(event),\n                paginated = this._options.pageSize !== undefined;\n\n            Event.stop(event);\n\n            var index = InkArray.keyValue(tgtEl, this._headers, true);\n            var sortable = index !== false && this._sortableFields[index] !== undefined;\n\n            if( !sortable ){\n                return;\n            }\n\n            if( !this._markupMode && paginated ){\n                this._invertSortOrder(index, false);\n            } else {\n                if ( (this._sortableFields[index] === 'desc') && this._options.allowResetSorting ) {\n                    this._setSortOrderOfColumn(index, null);\n                    this._data = this._originalData.slice(0);\n                } else {\n                    this._invertSortOrder(index, true);\n                }\n\n                var tbody = Selector.select('tbody',this._element)[0];\n                Common.cleanChildren(tbody);\n                InkArray.each(this._data, Ink.bindMethod(tbody, 'appendChild'));\n\n                if (this._pagination) {\n                    this._pagination.setCurrent(0);\n                    this._paginate(1);\n                }\n            }\n        },\n\n        _invertSortOrder: function (index, sortAndReverse) {\n            var isAscending = this._sortableFields[index] === 'asc';\n\n            for (var i = 0, len = this._headers.length; i < len; i++) {\n                this._setSortOrderOfColumn(i, null);\n            }\n\n            if (sortAndReverse) {\n                this._sort(index);\n                if (isAscending) {\n                    this._data.reverse();\n                }\n            }\n\n            this._setSortOrderOfColumn(index, !isAscending);\n        },\n\n        _setSortOrderOfColumn: function(index, up) {\n            var header = this._headers[index];\n            var caretHtml = [''];\n            var order = 'none';\n\n            if (up === true) {\n                caretHtml = ['<i class=\"', this._options.caretUpClass, '\"></i>'];\n                order = 'asc';\n            } else if (up === false) {\n                caretHtml = ['<i class=\"', this._options.caretDownClass, '\"></i>'];\n                order = 'desc';\n            }\n\n            this._sortableFields[index] = order;\n            header.innerHTML = Element.textContent(header) + caretHtml.join('');\n        },\n\n        /**\n         * Applies and/or changes the CSS classes in order to show the right columns\n         * \n         * @method _paginate\n         * @param {Number} page Current page\n         * @private\n         */\n        _paginate: function( page ){\n            if (!this._pagination) { return; }\n\n            var pageSize = this._options.pageSize;\n\n            // Hide everything except the items between these indices\n            var firstIndex = (page - 1) * pageSize;\n            var lastIndex = firstIndex + pageSize;\n\n            InkArray.each(this._data, function(item, index){\n                if (index >= firstIndex && index < lastIndex) {\n                    Css.removeClassName(item,'hide-all');\n                } else {\n                    Css.addClassName(item,'hide-all');\n                }\n            });\n\n        },\n\n        /* register fields into this._originalFields, whether they come from JSON or a table.\n         * @method _registerFieldNames\n         * @private\n         * @param [names] The field names in an array\n         **/\n        _registerFieldNames: function (names) {\n            this._originalFields = [];\n\n            InkArray.forEach(names, Ink.bind(function (field) {\n                if( !this._fieldIsVisible(field) ){\n                    return;  // The user deems this not to be necessary to see.\n                }\n                this._originalFields.push(field);\n            }, this));\n        },\n\n        _fieldIsVisible: function (field) {\n            return !this._options.visibleFields ||\n                (this._options.visibleFields.indexOf(field) !== -1);\n        },\n\n        /**\n         * Sorts by a specific column.\n         * \n         * @method _sort\n         * @param {Number} index Column number (starting at 0)\n         * @private\n         */\n        _sort: function( index ){\n            // TODO this is THE worst way to declare field names. Incompatible with i18n and a lot of other things.\n            var fieldName = Element.textContent(this._headers[index]);\n            var keyFunction = this._options.getSortKey;\n\n            if (keyFunction) {\n                keyFunction =\n                    typeof keyFunction[fieldName] === 'function' ?\n                        keyFunction[fieldName] :\n                    typeof keyFunction === 'function' ?\n                        keyFunction :\n                        null;\n            }\n\n            var self = this;\n\n            this._data.sort(function (trA, trB) {\n                var elementA = Ink.ss('td', trA)[index];\n                var elementB = Ink.ss('td', trB)[index];\n                if (keyFunction) {\n                    return cmp(userKey(elementA), userKey(elementB));\n                } else {\n                    return numberishEnabledCmp(elementA, elementB, index);\n                }\n            });\n\n            function userKey(element) {\n                return keyFunction.call(self, {\n                    columnIndex: index,\n                    columnName: fieldName,\n                    data: Element.textContent(element),\n                    element: element\n                });\n            }\n        },\n\n        /**\n         * Assembles the headers markup\n         *\n         * @method _createHeadersFromJson\n         * @param  {Object} headers Key-value object that contains the fields as keys, their configuration (label and sorting ability) as value\n         * @private\n         */\n        _createHeadersFromJson: function( headers ){\n            this._registerFieldNames(keys(headers));\n\n            if (this._thead.children.length) { return; }\n\n            var tr = this._thead.insertRow(0);\n            var th;\n\n            for (var i = 0, len = headers.length; i < len; i++) {\n                if (this._fieldIsVisible(headers[i])) {\n                    th = Element.create('th');\n                    th = this._createSingleHeaderFromJson(headers[i], th);\n                    tr.appendChild(th);\n                    this._headers.push(th);\n                }\n            }\n        },\n\n        _createSingleHeaderFromJson: function (header, th) {\n            if (header.sortable) {\n                th.setAttribute('data-sortable','true');\n            }\n\n            if (header.label){\n                Element.setTextContent(th, header.label);\n            }\n\n            return th;\n        },\n\n        /**\n         * Reset the sort order as marked on the table headers to \"none\"\n         *\n         * @method _resetSortOrder\n         * @private\n         */\n        _resetSortOrder: function(){\n            /**\n             * Setting the sortable columns and its event listeners\n             */\n            for (var i = 0, len = this._headers.length; i < len; i++) {\n                var dataset = Element.data( this._headers[i] );\n                if (dataset.sortable && dataset.sortable.toString() === 'true') {\n                    this._sortableFields[i] = 'none';\n                }\n            }\n        },\n\n        /**\n         * This method gets the rows from AJAX and places them as <tr> and <td>\n         *\n         * @method _createRowsFromJSON\n         * @param  {Object} rows Array of objects with the data to be showed\n         * @private\n         */\n        _createRowsFromJSON: function( rows ){\n            var tbody = Selector.select('tbody',this._element)[0];\n\n            if( !tbody ){\n                tbody = document.createElement('tbody');\n                this._element.appendChild( tbody );\n            } else {\n                Element.setHTML(tbody, '');\n            }\n\n            this._data = [];\n            var row;\n\n            for (var trIndex in rows) {\n                if (rows.hasOwnProperty(trIndex)) {\n                    row = this._options.processJSONRow(rows[trIndex]);\n                    this._createSingleRowFromJson(tbody, row, trIndex);\n                }\n            }\n\n            this._originalData = this._data.slice(0);\n        },\n\n        _createSingleRowFromJson: function (tbody, row, rowIndex) {\n            var tr = document.createElement('tr');\n            tbody.appendChild( tr );\n            for( var field in row ){\n                if (row.hasOwnProperty(field)) {\n                    this._createFieldFromJson(tr, row[field], field, rowIndex);\n                }\n            }\n            this._data.push(tr);\n        },\n\n        _createFieldFromJson: function (tr, fieldData, fieldName, rowIndex) {\n            if (!this._fieldIsVisible(fieldName)) { return; }\n\n            var processor =\n                this._options.processJSONField[fieldName] ||  // per-field callback\n                this._options.processJSONField;  // generic callback\n\n            var result;\n            if (typeof processor === 'function') {\n                result = processor(fieldData, fieldName, rowIndex);\n            } else {\n                result = fieldData;\n            }\n            var elm = this._elOrFieldData(result);\n\n            var className = this._options.tdClassNames[fieldName];\n            if (className) {\n                Css.addClassName(elm, className);\n            }\n\n            tr.appendChild(elm);\n        },\n\n        _elOrFieldData: function (processed) {\n            if (Common.isDOMElement(processed)) {\n                return processed;\n            }\n\n            var isString = typeof processed === 'string';\n            var isNumber = typeof processed === 'number';\n            var elm = Element.create('td');\n\n            if (isString && /^\\s*?</.test(processed)) {\n                Element.setHTML(elm, processed);\n            } else if (isString || isNumber) {\n                Element.setTextContent(elm, processed);\n            } else {\n                throw new Error('Ink.UI.Table Unknown result from processJSONField: ' + processed);\n            }\n\n            return elm;\n        },\n\n        /**\n         * Sets the AJAX endpoint.\n         * Useful to change the endpoint in runtime.\n         *\n         * @method setEndpoint\n         * @public\n         * @param {String} endpoint New endpoint\n         */\n        setEndpoint: function( endpoint, currentPage ){\n            if( !this._markupMode ){\n                this._options.endpoint = endpoint;\n                if (this._pagination) {\n                    this._pagination.setCurrent((!!currentPage) ? parseInt(currentPage,10) : 0 );\n                }\n            }\n        },\n\n        /**\n         * Sets the instance's pagination, if necessary.\n         *\n         * Precondition: this._totalRows needs to be known.\n         *\n         * @method _setPagination\n         * @private\n         */\n        _setPagination: function(){\n            /* If user doesn't say they want pagination, bail. */\n            if( this._options.pageSize == null ){ return; }\n\n            /**\n             * Fetch pagination from options. Can be a selector string, an element or a Pagination instance.\n             */\n            var paginationEl = this._options.pagination;\n\n            if ( paginationEl instanceof Pagination ) {\n                this._pagination = paginationEl;\n                return;\n            }\n\n            if (!paginationEl) {\n                paginationEl = Element.create('nav', {\n                    className: 'ink-navigation',\n                    insertAfter: this._element\n                });\n                Element.create('ul', {\n                    className: 'pagination',\n                    insertBottom: paginationEl\n                });\n            }\n\n            var paginationOptions = Ink.extendObj({\n                totalItemCount: this._totalRows,\n                itemsPerPage: this._options.pageSize,\n                onChange: Ink.bind(function (_, pageNo) {\n                    this._paginate(pageNo + 1);\n                }, this)\n            }, this._options.paginationOptions || {});\n\n            this._pagination = new Pagination(paginationEl, paginationOptions);\n\n            this._paginate(1);\n        },\n\n        /**\n         * Method to choose which is the best way to get the data based on the endpoint:\n         *     - AJAX\n         *     - JSONP\n         *\n         * @method _getData\n         * @private\n         */\n        _getData: function( ){\n            var sortOrder = this._getSortOrder() || null;\n            var page = null;\n\n            if (this._pagination) {\n                page = {\n                    size: this._options.pageSize,\n                    page: this._pagination.getCurrent() + 1\n                };\n            }\n\n            this._getDataViaAjax( this._getUrl( sortOrder, page) );\n        },\n\n        /**\n         * Return an object describing sort order { field: [field name] ,\n         * order: [\"asc\" or \"desc\"] }, or null if there is no sorting\n         * going on.\n         * @method _getSortOrder\n         * @private\n         */\n        _getSortOrder: function () {\n            var index;\n            for (index in this._sortableFields) if (this._sortableFields.hasOwnProperty(index)) {\n                if( this._sortableFields[index] !== 'none' ){\n                    break;\n                }\n            }\n            if (!index) {\n                return null; // no sorting going on\n            }\n            return {\n                field: this._originalFields[index],\n                order: this._sortableFields[index]\n            };\n        },\n\n        _getUrl: function (sort, page) {\n            var urlCreator = this._options.createEndpointUrl ||\n                function (endpoint, sort, page\n                        /* TODO implement filters too */) {\n                    endpoint = InkUrl.parseUrl(endpoint);\n                    endpoint.query = endpoint.query || {};\n\n                    if (sort) {\n                        endpoint.query.sortOrder = sort.order;\n                        endpoint.query.sortField = sort.field;\n                    }\n\n                    if (page) {\n                        endpoint.query['rows_per_page'] = page.size;\n                        endpoint.query['page'] = page.page;\n                    }\n\n                    return InkUrl.format(endpoint);\n                };\n\n            var ret = urlCreator(this._options.endpoint, sort, page);\n\n            if (typeof ret !== 'string') {\n                throw new TypeError('Ink.UI.Table_1: ' +\n                    'createEndpointUrl did not return a string!');\n            }\n\n            return ret;\n        },\n\n        /**\n         * Gets the data via AJAX and calls this._onAjaxSuccess with the response.\n         * \n         * Will call options.getDataFromEndpoint( Uri, callback ) if available.\n         *\n         * @param  endpointUri Endpoint to get data from, after processing.\n         */\n        _getDataViaAjax: function( endpointUri ){\n            var success = Ink.bind(function( JSONData ){\n                this._onAjaxSuccess( JSONData );\n            }, this);\n\n            if (!this._options.getDataFromEndpoint) {\n                new Ajax( endpointUri, {\n                    method: 'GET',\n                    contentType: 'application/json',\n                    sanitizeJSON: true,\n                    onSuccess: Ink.bind(function( response ){\n                        if( response.status === 200 ){\n                            success(Json.parse(response.responseText));\n                        }\n                    }, this)\n                });\n            } else {\n                this._options.getDataFromEndpoint( endpointUri, success );\n            }\n        },\n\n        _onAjaxSuccess: function (jsonResponse) {\n            var paginated = this._options.pageSize != null;\n            var rows = this._options.processJSONRows(jsonResponse);\n            this._headers = Selector.select('th', this._thead);\n\n            // If headers not in DOM, get from JSON\n            if( this._headers.length === 0 ) {\n                var headers = this._options.processJSONHeaders(\n                    jsonResponse);\n                if (!headers || !headers.length || !headers[0]) {\n                    throw new Error('Ink.UI.Table: processJSONHeaders option must return an array of objects!');\n                }\n                this._createHeadersFromJson( headers );\n                this._resetSortOrder();\n                this._addHeadersClasses();\n            }\n\n            this._createRowsFromJSON( rows );\n\n            this._totalRows = this._rowLength = rows.length;\n\n            if( paginated ){\n                this._totalRows = this._options.processJSONTotalRows(jsonResponse);\n                this._setPagination( );\n            }\n        }\n    };\n\n    Common.createUIComponent(Table);\n\n    return Table;\n\n});\n","/**\n * Display tabbed content\n * @module Ink.UI.Tabs_1\n * @version 1\n */\nInk.createModule('Ink.UI.Tabs', '1', ['Ink.UI.Common_1','Ink.Dom.Event_1','Ink.Dom.Css_1','Ink.Dom.Element_1','Ink.Dom.Selector_1'], function(Common, Event, Css, Element, Selector) {\n    'use strict';\n\n    /**\n     * The Tabs Component offers a simple way to build a tab-separated layout, allowing you to offer multiple content in the same space with intuitive navigation.\n     * This component requires your markup to have:\n     * - A container element (this is what you call the Ink.UI.Tabs constructor on), containing everything.\n     * - An element with the `tabs-nav` class, to contain links.\n     * - Your links with `href=\"#ID_OF_SECTION\"`\n     * - Your sections with the corresponding `id` attributes and the `tabs-content` class.\n     * - The content for each section.\n     *\n     * When the user clicks in the links inside `tabs-nav`, the tab with the corresponding ID is then activated. The active tab when the tab component is initialized has its hash in the browser URL. If there is no hash, then the `active` option kicks in. Otherwise, Tabs will fall back to showing the tab corresponding to the first link.\n     * You can disable some (or all) tabs by passing an array for the `disabled` option.\n     *\n     * @class Ink.UI.Tabs\n     * @constructor\n     * @version 1\n     * @param {String|DOMElement}   selector\n     * @param {Object}              [options]                       Options\n     * @param {Boolean}             [options.preventUrlChange]      Flag that determines if follows the link on click or stops the event\n     * @param {String}              [options.active]                ID of the tab to activate on creation\n     * @param {Array}               [options.disabled]              IDs of the tabs that will be disabled on creation\n     * @param {Function}            [options.onBeforeChange]        Callback to be executed before changing tabs\n     * @param {Function}            [options.onChange]              Callback to be executed after changing tabs\n     * \n     * @param {String}              [options.menuSelector='.tabs-nav'] Selector to find the menu element\n     * @param {String}              [options.contentSelector='.tabs-content'] Selector to find the menu element\n     * @param {String}              [options.tabSelector='.tabs-tab'] Selector to find the menu element\n     *\n     * @param {Boolean}             [options.triggerEventsOnLoad]   Trigger the above events when the page is loaded.\n     *\n     * @sample Ink_UI_Tabs_1.html\n     */\n    function Tabs() {\n        Common.BaseUIComponent.apply(this, arguments);\n    }\n\n    Tabs._name = 'Tabs_1';\n\n    Tabs._optionDefinition = {\n        preventUrlChange:   ['Boolean', false],\n        active:             ['String', undefined],\n        disabled:           ['Object', []],\n        onBeforeChange:     ['Function', undefined],\n        onChange:           ['Function', undefined],\n        menuSelector:       ['String', '.tabs-nav'],\n        contentSelector:    ['String', '.tabs-content'],\n        tabSelector:        ['String', '.tabs-tab'],\n        triggerEventsOnLoad:['Boolean', true]\n    };\n\n    Tabs.prototype = {\n\n        /**\n         * Init function called by the constructor\n         * \n         * @method _init\n         * @private\n         */\n        _init: function() {\n            this._handlers = {\n                resize: Ink.bindEvent(Event.throttle(this._onResize, 100),this)\n            };\n\n            this._menu = Selector.select(this._options.menuSelector, this._element)[0];\n\n            if (!this._menu) {\n                Ink.warn('Ink.UI.Tabs: An element selected by \".tabs-nav\" needs to exist inside the element!');\n                return;\n            }\n\n            //initialization of the tabs, hides all content before setting the active tab\n            this._initializeDom();\n\n            // subscribe events\n            this._observe();\n\n            //sets the first active tab\n            this._setFirstActive();\n\n            this._handlers.resize();\n        },\n\n        /**\n         * Initialization of the tabs, hides all content before setting the active tab\n         * \n         * @method _initializeDom\n         * @private\n         */\n        _initializeDom: function(){\n            var contentTabs = Selector.select(this._options.contentSelector, this._element);\n\n            for(var i = 0; i < contentTabs.length; i++){\n                Css.addClassName(contentTabs[i], 'hide-all');\n            }\n        },\n\n        /**\n         * Subscribe events\n         * \n         * @method _observe\n         * @private\n         */\n        _observe: function() {\n            Event.on(this._menu, 'click', 'a', Ink.bindMethod(this, '_onTabClickedGeneric'));\n            Event.observe(window, 'resize', this._handlers.resize);\n        },\n\n        /**\n         * Run at instantiation, to determine which is the first active tab\n         * fallsback from window.location.href to options.active to the first not disabled tab\n         * \n         * @method _setFirstActive\n         * @private\n         */\n        _setFirstActive: function() {\n            var hash = window.location.hash;\n\n            var activeMenuLink = this._findLinkByHref(hash) ||\n                                 (this._options.active && this._findLinkByHref(this._options.active)) ||\n                                 Selector.select('.active a', this._menu)[0] ||\n                                 Selector.select('a', this._menu)[0];\n\n            if (activeMenuLink) {\n                this._changeTab(activeMenuLink, this._options.triggerEventsOnLoad);\n            }\n        },\n\n        /**\n         * Changes to the desired tab\n         * \n         * @method _changeTab\n         * @param {DOMElement} link             anchor linking to the content container\n         * @param {boolean}    runCallbacks     defines if the callbacks should be run or not\n         * @private\n         */\n        _changeTab: function(link, runCallbacks){\n            if(runCallbacks && typeof this._options.onBeforeChange !== 'undefined'){\n                this._options.onBeforeChange(this);\n            }\n\n            var selector = link.getAttribute('href');\n\n            var activeTabs = Selector.select('> li.active', this._menu);\n\n            for (var i = 0, len = activeTabs.length; i < len; i++) {\n                if (activeTabs[i] !== link) {\n                    Css.removeClassName(activeTabs[i], 'active');\n                }\n            }\n\n            if (this._activeMenuTab) {\n                Css.removeClassName(this._activeMenuTab, 'active');\n                Css.removeClassName(this._activeSection, 'active');\n                Css.addClassName(this._activeSection, 'hide-all');\n            }\n\n            this._activeMenuLink = link;\n            this._activeMenuTab = this._activeMenuLink.parentNode;\n            this._activeSection = Selector.select(selector.substr(selector.indexOf('#')), this._element)[0];\n\n            if (!this._activeSection) {\n                this._activeMenuLink = this._activeMenuTab = this._activeSection = null;\n                return;\n            }\n\n            Css.addClassName(this._activeMenuTab, 'active');\n            Css.addClassName(this._activeSection, 'active');\n            Css.removeClassName(this._activeSection, 'hide-all');\n\n            if(runCallbacks && typeof(this._options.onChange) !== 'undefined'){\n                this._options.onChange(this);\n            }\n        },\n\n        /**\n         * Generic Tab clicked handler.\n         * Just calls _onTabClicked or _onDisabledTabClicked\n         *\n         * @private\n         **/\n        _onTabClickedGeneric: function (event) {\n            event.preventDefault();\n            if (!Css.hasClassName(event.currentTarget, 'ink-disabled')) {\n                this._onTabClicked(event.currentTarget);\n            }\n        },\n\n        /**\n         * Tab clicked handler\n         * \n         * @method _onTabClicked\n         * @param {Event} ev\n         * @private\n         */\n        _onTabClicked: function(tabElm) {\n            var href = tabElm.getAttribute('href');\n            href = href.substr(href.indexOf('#'));\n\n            if (!href || Ink.i(this._dehashify(href)) === null) {\n                return;\n            }\n\n            if (!this._options.preventUrlChange) {\n                window.location.hash = href;\n            }\n\n            if (tabElm === this._activeMenuLink) {\n                return;\n            }\n            this.changeTab(tabElm);\n        },\n\n        /**\n         * Resize handler\n         * \n         * @method _onResize\n         * @private\n         */\n        _onResize: function(){\n            var currentLayout = Common.currentLayout();\n            if(currentLayout === this._lastLayout){\n                return;\n            }\n\n            // wtf\n            var smallLayout =\n                currentLayout === Common.Layouts.TINY ||\n                currentLayout === Common.Layouts.SMALL ||\n                currentLayout === Common.Layouts.MEDIUM;\n\n            if(smallLayout){\n                Css.removeClassName(this._menu, 'menu');\n                Css.removeClassName(this._menu, 'horizontal');\n                // Css.addClassName(this._menu, 'pills');\n            } else {\n                Css.addClassName(this._menu, 'menu');\n                Css.addClassName(this._menu, 'horizontal');\n                // Css.removeClassName(this._menu, 'pills');\n            }\n            this._lastLayout = currentLayout;\n        },\n\n        /*****************\n         * Aux Functions *\n         *****************/\n\n        /**\n         * Allows the hash to be passed with or without the cardinal sign\n         * \n         * @method _hashify\n         * @param {String} hash     the string to be hashified\n         * @return {String} Resulting hash\n         * @private\n         */\n        _hashify: function(hash){\n            if(!hash){\n                return \"\";\n            }\n            return hash.indexOf('#') === 0? hash : '#' + hash;\n        },\n\n        /**\n         * Removes the cardinal sign from the beginning of a string\n         **/\n        _dehashify: function(hash) {\n            if (!hash) { return ''; }\n            return ('' + hash).replace(/^#/, '');\n        },\n\n        /**\n         * Returns the anchor with the desired href\n         * \n         * @method _findLinkBuHref\n         * @param {String} href     the href to be found on the returned link\n         * @return {String|undefined} [description]\n         * @private\n         */\n        _findLinkByHref: function(href){\n            // If it's null or undefined, the following checks fail.\n            if (!href) { return null; }\n\n            // If it's a node, it could be a link or a section.\n            if (href.nodeType === 1) {\n                if (Element.isAncestorOf(href, this._element)) { return null; }  // Element is outside the tabs element.\n\n                var links = Selector.select('a', this._menu);\n                var id = href.getAttribute('id');\n\n                for (var i = 0, len = links.length; i < len; i++) {\n                    if (links[i] === href || Element.isAncestorOf(href, links[i])) {\n                        return links[i];  // We got a link\n                    } else if (id && id === this._dehashify(links[i].getAttribute('href'))) {\n                        return links[i];  // We got a section\n                    }\n                }\n\n                return null;\n            }\n\n            // Else, it's a string. It could start with \"#\" or without it.\n            href = this._hashify(href);\n            // Find a link which has a href ending with...\n            return Selector.select('a[href$=\"' + href + '\"]', this._menu)[0] || null;\n        },\n\n        /**************\n         * PUBLIC API *\n         **************/\n\n        /**\n         * Changes the active tab\n         *\n         * Pass a selector/element identifying what tab you want\n         * \n         * @method changeTab\n         * @param {String|DOMElement} selector      Selector of the desired tab or the link that links to it\n         * @public\n         */\n        changeTab: function(selector) {\n            selector = this._findLinkByHref(selector);\n\n            if(!selector || Css.hasClassName(selector, 'ink-disabled')){\n                return;\n            }\n\n            this._changeTab(selector, true);\n        },\n\n        /**\n         * Disables the desired tag\n         * \n         * @method disable\n         * @param {String|DOMElement} selector      the id of the desired tab or the link that links to it\n         * @public\n         */\n        disable: function(selector){\n            Css.addClassName(this._findLinkByHref(selector), 'ink-disabled');\n        },\n\n        /**\n         * Enables the desired tag\n         * \n         * @method enable\n         * @param {String|DOMElement} selector      The id of the desired tab or the link that links to it\n         * @public\n         */\n        enable: function(selector){\n            Css.removeClassName(this._findLinkByHref(selector), 'ink-disabled');\n        },\n\n        /***********\n         * Getters *\n         ***********/\n\n        /**\n         * Returns the active tab id\n         * \n         * @method activeTab\n         * @return {String} ID of the active section (use activeSection() instead to get the element).\n         * @public\n         */\n        activeTab: function(){\n            return this._activeSection.getAttribute('id');\n        },\n\n        /**\n         *\n         * Returns the parent of the currently active menu link.\n         *\n         * This is useful if you want to have `li` elements wrapping your links\n         * and want to access the currently visible one.\n         *\n         * (This method is deprecated)\n         * @method activeMenuTab\n         * @deprecated\n         * @return {DOMElement|null} Active menu LI, or `null` if there is none.\n         * @public\n         */\n        activeMenuTab: function(){\n            // [3.1.0] remove this\n            Ink.warn('Ink.UI.Tabs.activeMenuTab() is deprecated');\n            return this._activeMenuTab;\n        },\n\n        /**\n         * Gets the currently active Menu link (the links which the user clicks on to change tabs)\n         * \n         * @method activeMenuLink\n         * @return {DOMElement|null} Active menu link, or `null` if there is none.\n         * @public\n         */\n        activeMenuLink: function(){\n            return this._activeMenuLink;\n        },\n\n        /**\n         * Gets the currently active section\n         *\n         * (Each section contains content for a tab, and must have an `id` attribute)\n         * \n         * @method activeContentTab\n         * @return {DOMElement|null} Active section, or `null` if there is none.\n         * @public\n         */\n        activeSection: function(){\n            return this._activeSection;\n        },\n\n        activeContentTab: function () {\n            // [3.1.0] remove this\n            Ink.warn('Ink.UI.Tabs.activeContentTab() is deprecated. Use activeSection instead.');\n            return this._activeSection();\n        },\n\n        /**\n         * Unregisters the component and removes its markup\n         * \n         * @method destroy\n         * @public\n         */\n        destroy: Common.destroyComponent\n    };\n\n    Common.createUIComponent(Tabs);\n\n    return Tabs;\n\n});\n","/*\n * Tagging input element\n * @module Ink.UI.TagField_1\n * @version 1\n */\nInk.createModule(\"Ink.UI.TagField\",\"1\",[\"Ink.Dom.Element_1\", \"Ink.Dom.Event_1\", \"Ink.Dom.Css_1\", \"Ink.Dom.Browser_1\", \"Ink.UI.Droppable_1\", \"Ink.Util.Array_1\", \"Ink.Dom.Selector_1\", \"Ink.UI.Common_1\"],function( InkElement, InkEvent, Css, Browser, Droppable, InkArray, Selector, Common) {\n    'use strict';\n\n    var enterKey = 13;\n    var backspaceKey = 8;\n    var isTruthy = function (val) {return !!val;};\n\n    /**\n     * Use this class to have a field where a user can input several tags into a single text field. A good example is allowing the user to describe a blog post or a picture through tags, for later searching.\n     *\n     * The markup is as follows:\n     *\n     *           <input class=\"ink-tagfield\" type=\"text\" value=\"initial,value\">\n     *\n     * By applying this UI class to the above input, you get a tag field with the tags \"initial\" and \"value\". The class preserves the original input element. It remains hidden and is updated with new tag information dynamically, so regular HTML form logic still applies.\n     *\n     * Below \"input\" refers to the current value of the input tag (updated as the user enters text, of course), and \"output\" refers to the value which this class writes back to said input tag.\n     *\n     * @class Ink.UI.TagField\n     * @version 1\n     * @constructor\n     * @param {String|DOMElement}   element                         Selector or DOM Input Element.\n     * @param {Object}              [options]                       Options object\n     * @param {String|Array}        [options.tags]                  Initial tags in the input\n     * @param {Boolean}             [options.allowRepeated]         Flag to allow user to input several tags. Defaults to true.\n     * @param {RegExp}              [options.separator]             Split the input by this RegExp. Defaults to /[,;(space)]+/g (spaces, commas and semicolons)\n     * @param {String}              [options.outSeparator]          Use this string to separate each tag from the next in the output. Defaults to ','.\n     * @param {Boolean}             [options.autoSplit]             Flag to activate tag creation when the user types a separator. Defaults to true.\n     * @param {Integer}             [options.maxTags]               Maximum number of tags allowed. Set to -1 for no limit. Defaults to -1.\n     * @example\n     */\n    function TagField() {\n        Common.BaseUIComponent.apply(this, arguments);\n    }\n\n    TagField._name = 'TagField_1';\n\n    TagField._optionDefinition = {\n        tags: ['String', []],\n        tagQuery: ['Object', null],\n        tagQueryAsync: ['Object', null],\n        allowRepeated: ['Boolean', false],\n        maxTags: ['Integer', -1],\n        outSeparator: ['String', ','],\n        separator: ['String', /[,; ]+/g],\n        autoSplit: ['Boolean', true]\n    };\n\n    TagField.prototype = {\n        /**\n         * Init function called by the constructor\n         * \n         * @method _init\n         * @private\n         */\n        _init: function() {\n            var o = this._options;\n            if (typeof o.separator === 'string') {\n                o.separator = new RegExp(o.separator, 'g');\n            }\n\n            if (typeof o.tags === 'string') {\n                // coerce to array using the separator\n                o.tags = this._readInput(o.tags);\n            }\n\n            Css.addClassName(this._element, 'hide-all');\n\n            this._viewElm = InkElement.create('div', {\n                className: 'ink-tagfield',\n                insertAfter: this._element\n            });\n\n            this._input = InkElement.create('input', {\n                type: 'text',\n                className: 'new-tag-input',\n                insertBottom: this._viewElm\n            });\n\n            var tags = [].concat(o.tags, this._tagsFromMarkup(this._element));\n\n            this._tags = [];\n\n            InkArray.each(tags, Ink.bindMethod(this, '_addTag'));\n\n            InkEvent.observe(this._input, 'keyup', Ink.bindEvent(this._onKeyUp, this));\n            InkEvent.observe(this._input, 'change', Ink.bindEvent(this._onKeyUp, this));\n            InkEvent.observe(this._input, 'keydown', Ink.bindEvent(this._onKeyDown, this));\n            InkEvent.observe(this._input, 'blur', Ink.bindEvent(this._onBlur, this));\n            InkEvent.observe(this._viewElm, 'click', Ink.bindEvent(this._refocus, this));\n        },\n\n        destroy: function () {\n            InkElement.remove(this._viewElm);\n            Css.removeClassName(this._element, 'hide-all');\n        },\n\n        _tagsFromMarkup: function (element) {\n            var tagname = element.tagName.toLowerCase();\n            if (tagname === 'input') {\n                return this._readInput(element.value);\n            } else if (tagname === 'select') {\n                return InkArray.map(element.getElementsByTagName('option'), function (option) {\n                    return InkElement.textContent(option);\n                });\n            } else {\n                throw new Error('Cannot read tags from a ' + tagname + ' tag. Unknown tag');\n            }\n        },\n\n        _tagsToMarkup: function (tags, element) {\n            var tagname = element.tagName.toLowerCase();\n            if (tagname === 'input') {\n                if (this._options.separator) {\n                    element.value = tags.join(this._options.outSeparator);\n                }\n            } else if (tagname === 'select') {\n                element.innerHTML = '';\n                InkArray.each(tags, function (tag) {\n                    var opt = InkElement.create('option', {selected: 'selected'});\n                    InkElement.setTextContent(opt, tag);\n                    element.appendChild(opt);\n                });\n            } else {\n                throw new Error('TagField: Cannot read tags from a ' + tagname + ' tag. Unknown tag');\n            }\n        },\n\n        _addTag: function (tag) {\n            if (this._options.maxTags !== -1 &&\n                    this._tags.length >= this._options.maxTags) {\n                return;\n            }\n            if ((!this._options.allowRepeated &&\n                    InkArray.inArray(tag, this._tags, tag)) || !tag) {\n                return false;\n            }\n            var elm = InkElement.create('span', {\n                className: 'ink-tag',\n                setTextContent: tag + ' '\n            });\n\n            var remove = InkElement.create('span', {\n                className: 'remove fa fa-times',\n                insertBottom: elm\n            });\n            InkEvent.observe(remove, 'click', Ink.bindEvent(this._removeTag, this, null));\n\n            var spc = document.createTextNode(' ');\n\n            this._tags.push(tag);\n            this._viewElm.insertBefore(elm, this._input);\n            this._viewElm.insertBefore(spc, this._input);\n            this._tagsToMarkup(this._tags, this._element);\n        },\n\n        _readInput: function (text) {\n            if (this._options.separator) {\n                return InkArray.filter(text.split(this._options.separator), isTruthy);\n            } else {\n                return [text];\n            }\n        },\n\n        _onKeyUp: function () {  // TODO control input box size\n            if (!this._options.autoSplit) {\n                return;\n            }\n            var split = this._input.value.split(this._options.separator);\n            if (split.length <= 1) {\n                return;\n            }\n            var last = split[split.length - 1];\n            split = split.splice(0, split.length - 1);\n            split = InkArray.filter(split, isTruthy);\n            \n            InkArray.each(split, Ink.bind(this._addTag, this));\n            this._input.value = last;\n        },\n\n        _onKeyDown: function (event) {\n            if (event.which === enterKey) {\n                return this._onEnterKeyDown(event);\n            } else if (event.which === backspaceKey) {\n                return this._onBackspaceKeyDown();\n            } else if (this._removeConfirm) {\n                // user pressed another key, cancel removal from a backspace key\n                this._unsetRemovingVisual(this._tags.length - 1);\n            }\n        },\n\n        /**\n         * When the user presses backspace twice on the empty input, we delete the last tag on the field.\n         * @method onBackspaceKeyDown\n         * @private\n         */\n        _onBackspaceKeyDown: function () {\n            if (this._input.value) { return; }\n\n            if (this._removeConfirm) {\n                this._unsetRemovingVisual(this._tags.length - 1);\n                this._removeTag(this._tags.length - 1);\n                this._removeConfirm = null;\n            } else {\n                this._setRemovingVisual(this._tags.length - 1);\n            }\n        },\n\n        _onEnterKeyDown: function (event) {\n            var tag = this._input.value;\n            if (tag) {\n                this._addTag(tag);\n                this._input.value = '';\n            }\n            InkEvent.stopDefault(event);\n        },\n\n        _onBlur: function () {\n            this._addTag(this._input.value);\n            this._input.value = '';\n        },\n\n        /* For when the user presses backspace.\n         * Set the style of the tag so that it seems like it's going to be removed\n         * if they press backspace again. */\n        _setRemovingVisual: function (tagIndex) {\n            var elm = this._viewElm.children[tagIndex];\n            if (!elm) { return; }\n\n            Css.addClassName(elm, 'tag-deleting');\n\n            this._removeRemovingVisualTimeout = setTimeout(Ink.bindMethod(this, '_unsetRemovingVisual', tagIndex), 4000);\n            InkEvent.observe(this._input, 'blur', Ink.bindMethod(this, '_unsetRemovingVisual', tagIndex));\n            this._removeConfirm = true;\n        },\n        _unsetRemovingVisual: function (tagIndex) {\n            var elm = this._viewElm.children[tagIndex];\n            if (elm) {\n                Css.removeClassName(elm, 'tag-deleting');\n                clearTimeout(this._removeRemovingVisualTimeout);\n            }\n            this._removeConfirm = null;\n        },\n\n        _removeTag: function (event) {\n            var index;\n            if (typeof event === 'object') {  // click event on close button\n                var elm = InkEvent.element(event).parentNode;\n                index = InkElement.parentIndexOf(this._viewElm, elm);\n            } else if (typeof event === 'number') {  // manual removal\n                index = event;\n            }\n            this._tags = InkArray.remove(this._tags, index, 1);\n            InkElement.remove(this._viewElm.children[index]);\n            this._tagsToMarkup(this._tags, this._element);\n        },\n\n        _refocus: function (event) {\n            this._input.focus();\n            InkEvent.stop(event);\n            return false;\n        }\n    };\n\n    Common.createUIComponent(TagField);\n\n    return TagField;\n});\n","/**\n * Toggle the visibility of elements.\n * @module Ink.UI.Toggle_1\n * @version 1\n */\n\n Ink.createModule('Ink.UI.Toggle', '1', ['Ink.UI.Common_1','Ink.Dom.Event_1','Ink.Dom.Css_1','Ink.Dom.Element_1','Ink.Dom.Selector_1','Ink.Util.Array_1'], function(Common, InkEvent, Css, InkElement, Selector, InkArray ) {\n    'use strict';\n\n    /**\n     *\n     * You need two elements to use Toggle: the `trigger` element, and the `target` element (or elements). The default behaviour is to toggle the `target`(s) when you click the `trigger`.\n     *\n     * The toggle has a state. It is either \"on\" or \"off\". It works by switching between the CSS classes in `classNameOn` and `classNameOff` according to the current state.\n     *\n     * When you initialize the Toggle, it will check if the targets are visible to figure out what the initial state is. You can force the toggle to consider itself turned \"on\" or \"off\" by setting the `initialState` option to `true` or `false`, respectively.\n     *\n     * You can get the current state of the Toggle by calling `getState`, or by checking if your `trigger` element has the \"active\" class.\n     * The state can be changed through JavaScript. Just call  `setState(true)` \n     * to turn the Toggle on (or `setState(false)` to turn it off).\n     *\n     * @class Ink.UI.Toggle\n     * @constructor\n     * @version 1\n     * @param {String|DOMElement} selector  Trigger element. By clicking this, the target (or targets) are triggered.\n     * @param {Object} [options] Options object, containing:\n     *\n     * @param {String}              options.target                  CSS Selector that specifies the elements that this component will toggle\n     * @param {String}              [options.classNameOn]           CSS class to toggle when on. Defaults to 'show-all'.\n     * @param {String}              [options.classNameOff]          CSS class to toggle when off. Defaults to 'hide-all'.\n     * @param {String}              [options.triggerEvent]          Event that will trigger the toggling. Defaults to 'click'.\n     * @param {Boolean}             [options.closeOnClick]          Flag to toggle the targe off when clicking outside the toggled content. Defaults to true.\n     * @param {String}              [options.closeOnInsideClick]    Toggle off when a child element matching this selector is clicked. Set to null to deactivate the check. Defaults to 'a[href]'.\n     * @param {Boolean}             [options.initialState]          Flag to define initial state. false: off, true: on, null: markup. Defaults to null.\n     * @param {Function}            [options.onChangeState]         Callback when the toggle state changes. Return `false` to cancel the event.\n     *\n     * @sample Ink_UI_Toggle_1_constructor.html\n     */\n    function Toggle(){\n        Common.BaseUIComponent.apply(this, arguments);\n    }\n\n    Toggle._name = 'Toggle_1';\n\n    Toggle._optionDefinition = {\n        target:         ['Elements'],\n        triggerEvent:   ['String', 'click'],\n        closeOnClick:   ['Boolean', true],\n        isAccordion:    ['Boolean', false],\n        initialState:   ['Boolean', null],  // May be true, false, or null to be what it is right now\n        classNameOn:    ['String', 'show-all'],\n        classNameOff:   ['String', 'hide-all'],\n        closeOnInsideClick: ['String', 'a[href]'],  // closes the toggle when a target is clicked and it is a link\n        onChangeState:  ['Function', null]\n    };\n\n    Toggle.prototype = {\n\n        /**\n         * Init function called by the constructor\n         * \n         * @method _init\n         * @private\n         */\n        _init: function(){\n            var i, len;\n\n            this._targets = Common.elsOrSelector(this._options.target);\n\n            // Boolean option handling\n            this._options.closeOnClick = this._options.closeOnClick.toString() === 'true';\n            // Actually a throolean\n            if (this._options.initialState !== null){\n                this._options.initialState = this._options.initialState.toString() === 'true';\n            } else {\n                this._options.initialState = Css.getStyle(this._targets[0], 'display') !== 'none';\n            }\n\n            if (this._options.classNameOn !== 'show-all' || this._options.classNameOff !== 'hide-all') {\n                for (i = 0, len = this._targets.length; i < len; i++) {\n                    Css.removeClassName(this._targets[i], 'show-all');\n                    Css.removeClassName(this._targets[i], 'hide-all');\n                }\n            }\n\n            this._accordion = ( Css.hasClassName(this._element.parentNode,'accordion') || Css.hasClassName(this._targets[0].parentNode,'accordion') );\n\n            this._firstTime = true;\n\n            this._bindEvents();\n\n            if (this._options.initialState !== null) {\n                this.setState(this._options.initialState, true);\n            } else {\n                // Add initial classes matching the current \"display\" of the object.\n                var state = Css.getStyle(this._targets[0], 'display') !== 'none';\n                this.setState(state, true);\n            }\n            // Aditionally, remove any inline \"display\" style.\n            for (i = 0, len = this._targets.length; i < len; i++) {\n                if (this._targets[i].style.display) {\n                    this._targets[i].style.display = '';  // becomes default\n                }\n            }\n\n            this._element.setAttribute('data-is-toggle-trigger', 'true');\n        },\n\n        /**\n         * @method _bindEvents\n         * @private\n         */\n        _bindEvents: function () {\n            if ( this._options.triggerEvent ) {\n                InkEvent.observe(\n                    this._element,\n                    this._options.triggerEvent,\n                    Ink.bind(this._onTriggerEvent, this));\n            }\n            if( this._options.closeOnClick ){\n                InkEvent.observe( document, 'click', Ink.bind(this._onOutsideClick, this));\n            }\n            if( this._options.closeOnInsideClick && this._options.closeOnInsideClick !== 'false') {\n                var sel = this._options.closeOnInsideClick;\n                if (sel.toString() === 'true') {\n                    sel = '*';\n                }\n                InkEvent.observeMulti(this._targets, 'click', Ink.bind(function (e) {\n                    if ( InkElement.findUpwardsBySelector(InkEvent.element(e), sel) ) {\n                        this.setState(false, true);\n                    }\n                }, this));\n            }\n        },\n\n        /**\n         * Event handler. It's responsible for handling the `triggerEvent` as defined in the options.\n         *\n         * This will trigger the toggle.\n         * \n         * @method _onTriggerEvent\n         * @param {Event} event\n         * @private\n         */\n        _onTriggerEvent: function( event ){\n            // When the togglee is a child of the toggler, we get the togglee's events here. We have to check that this event is for us.\n            var target = InkEvent.element(event);\n\n            var isAncestorOfClickedElement = InkArray.some(this._targets, function (thisOne) {\n                return thisOne === target || InkElement.isAncestorOf(thisOne, target);\n            });\n\n            if (isAncestorOfClickedElement) {\n                return;\n            }\n\n            if (this._accordion) {\n                this._updateAccordion();\n            }\n\n            var has = this.getState();\n            this.setState(!has, true);\n            if (!has && this._firstTime) {\n                this._firstTime = false;\n            }\n\n            InkEvent.stopDefault(event);\n        },\n\n        /**\n         * Be compatible with accordions\n         *\n         * @method _updateAccordion\n         **/\n        _updateAccordion: function () {\n            var elms, accordionElement;\n            if( Css.hasClassName(this._targets[0].parentNode,'accordion') ){\n                accordionElement = this._targets[0].parentNode;\n            } else {\n                accordionElement = this._targets[0].parentNode.parentNode;\n            }\n            elms = Selector.select('.toggle, .ink-toggle',accordionElement);\n            for(var i=0; i<elms.length; i+=1 ){\n                var dataset = InkElement.data( elms[i] ),\n                    targetElm = Selector.select( dataset.target,accordionElement );\n\n                if( (targetElm.length > 0) && (targetElm[0] !== this._targets[0]) ){\n                    targetElm[0].style.display = 'none';\n                }\n            }\n        },\n\n        /**\n         * Click handler. Will handle clicks outside the toggle component.\n         * \n         * @method _onOutsideClick\n         * @param {Event} event\n         * @private\n         */\n        _onOutsideClick: function( event ){\n            var tgtEl = InkEvent.element(event),\n                shades;\n\n            if (InkElement.findUpwardsBySelector(tgtEl, '[data-is-toggle-trigger=\"true\"]')) return;\n\n            var ancestorOfTargets = InkArray.some(this._targets, function (target) {\n                return InkElement.isAncestorOf(target, tgtEl) || target === tgtEl;\n            });\n\n            if( (this._element === tgtEl) || InkElement.isAncestorOf(this._element, tgtEl) || ancestorOfTargets) {\n                return;\n            } else if( (shades = Ink.ss('.ink-shade')).length ) {\n                var shadesLength = shades.length;\n\n                for( var i = 0; i < shadesLength; i++ ){\n                    if( InkElement.isAncestorOf(shades[i],tgtEl) && InkElement.isAncestorOf(shades[i],this._element) ){\n                        return;\n                    }\n                }\n            }\n\n            this.setState(false, true);  // dismiss\n        },\n\n        /**\n         * Sets the state of the toggle. (on/off)\n         *\n         * @method setState\n         * @param newState {Boolean} New state (on/off)\n         */\n        setState: function (on, callHandler) {\n            if (on === this.getState()) { return; }\n            if (callHandler && typeof this._options.onChangeState === 'function') {\n                var ret = this._options.onChangeState(on);\n                if (ret === false) { return false; } //  Canceled by the event handler\n            }\n            for (var i = 0, len = this._targets.length; i < len; i++) {\n                Css.addRemoveClassName(this._targets[i], this._options.classNameOn, on);\n                Css.addRemoveClassName(this._targets[i], this._options.classNameOff, !on);\n            }\n            Css.addRemoveClassName(this._element, 'active', on);\n        },\n\n        /**\n         * Gets the state of the toggle. (on/off)\n         *\n         * @method getState\n         *\n         * @return {Boolean} whether the toggle is toggled on.\n         */\n        getState: function () {\n            return Css.hasClassName(this._element, 'active');\n        }\n    };\n\n    Common.createUIComponent(Toggle);\n\n    return Toggle;\n});\n","/**\n * Content Tooltips\n * @module Ink.UI.Tooltip_1\n * @version 1\n */\nInk.createModule('Ink.UI.Tooltip', '1', ['Ink.UI.Common_1', 'Ink.Dom.Event_1', 'Ink.Dom.Element_1', 'Ink.Dom.Selector_1', 'Ink.Util.Array_1', 'Ink.Dom.Css_1', 'Ink.Dom.Browser_1'], function (Common, InkEvent, InkElement, Selector, InkArray, Css) {\n    'use strict';\n\n    /**\n     * Tooltips are useful as a means to display information about functionality while avoiding clutter.\n     *\n     * Tooltips show up when you hover elements which \"have\" tooltips.\n     *\n     * This class will \"give\" a tooltip to many elements, selected by its first argument (`target`). This is contrary to the other UI modules in Ink, which are created once per element.\n     *\n     * You can define options either through the second argument of the Tooltip constructor, or as data-attributes in each `target` element. Options set through data-attributes all start with \"data-tip\", and override options passed into the Tooltip constructor.\n     *\n     * @class Ink.UI.Tooltip\n     * @constructor\n     *\n     * @param {DOMElement|String}   target                  Target element or selector of elements, to display the tooltips on.\n     * @param {Object}              [options]               Options object\n     * @param {String}              [options.text]          Text content for the tooltip.\n     * @param {String}              [options.html]          HTML for the tooltip. Same as above, but won't escape HTML.\n     * @param {String}              [options.where]         Positioning for the tooltip. Options are 'up', 'down', 'left', 'right', 'mousemove' (follows the cursor), and 'mousefix' (stays fixed). Defaults to 'up'.\n     *     \n     * @param {String}              [options.color]         Color of the tooltip. Options are red, orange, blue, green and black. Default is white.\n     * @param {Number}              [options.fade]          Number of seconds to fade in/out. Defaults to 0.3.\n     * @param {Boolean}             [options.forever]       Flag to prevent the tooltip from being erased when the mouse hovers away from the target.\n     * @param {Number}              [options.timeout]       Number of seconds the tooltip will stay open. Useful together with options.forever. Defaults to 0.\n     * @param {Number}              [options.delay]         Time the tooltip waits until it is displayed. Useful to avoid getting the attention of the user unnecessarily\n     * @param {DOMElement|Selector} [options.template]      Element or selector containing HTML to be cloned into the tooltips. Can be a hidden element, because CSS `display` is set to `block`.\n     * @param {String}              [options.templatefield] Selector within the template element to choose where the text is inserted into the tooltip. Useful when a wrapper DIV is required.\n     * @param {Number}              [options.left]          Spacing from the target to the tooltip, when `where` is `mousemove` or `mousefix`. Defaults to 10.\n     * @param {Number}              [options.top]           Spacing from the target to the tooltip, when `where` is `mousemove` or `mousefix`. Defaults to 10.\n     * @param {Number}              [options.spacing]       Spacing between the tooltip and the target element, when `where` is not `mousemove` or `mousefix`. Defaults to 8.\n     * \n     * @sample Ink_UI_Tooltip_1.html\n     */\n    function Tooltip(element, options) {\n        this._init(element, options || {});\n    }\n\n    function EachTooltip(root, elm) {\n        this._init(root, elm);\n    }\n\n    var transitionDurationName,\n        transitionPropertyName,\n        transitionTimingFunctionName;\n    (function () {  // Feature detection\n        var test = document.createElement('DIV');\n        var names = ['transition', 'oTransition', 'msTransition', 'mozTransition',\n            'webkitTransition'];\n        for (var i = 0; i < names.length; i++) {\n            if (typeof test.style[names[i] + 'Duration'] !== 'undefined') {\n                transitionDurationName = names[i] + 'Duration';\n                transitionPropertyName = names[i] + 'Property';\n                transitionTimingFunctionName = names[i] + 'TimingFunction';\n                break;\n            }\n        }\n    }());\n\n    // Body or documentElement\n    var bodies = document.getElementsByTagName('body');\n    var body = bodies.length ? bodies[0] : document.documentElement;\n\n    Tooltip.prototype = {\n        _init: function(element, options) {\n            var elements;\n\n            this.options = Ink.extendObj({\n                    where: 'up',\n                    zIndex: 10000,\n                    left: 10,\n                    top: 10,\n                    spacing: 8,\n                    forever: 0,\n                    color: '',\n                    timeout: 0,\n                    delay: 0,\n                    template: null,\n                    templatefield: null,\n                    fade: 0.3,\n                    text: ''\n                }, options || {});\n\n            if (typeof element === 'string') {\n                elements = Selector.select(element);\n            } else if (typeof element === 'object') {\n                elements = [element];\n            } else {\n                throw 'Element expected';\n            }\n\n            this.tooltips = [];\n\n            for (var i = 0, len = elements.length; i < len; i++) {\n                this.tooltips[i] = new EachTooltip(this, elements[i]);\n            }\n        },\n        /**\n         * Destroys the tooltips created by this instance\n         *\n         * @method destroy\n         */\n        destroy: function () {\n            InkArray.each(this.tooltips, function (tooltip) {\n                tooltip._destroy();\n            });\n            this.tooltips = null;\n            this.options = null;\n        }\n    };\n\n    EachTooltip.prototype = {\n        _oppositeDirections: {\n            left: 'right',\n            right: 'left',\n            up: 'down',\n            down: 'up'\n        },\n        _init: function(root, elm) {\n            InkEvent.observe(elm, 'mouseover', Ink.bindEvent(this._onMouseOver, this));\n            InkEvent.observe(elm, 'mouseout', Ink.bindEvent(this._onMouseOut, this));\n            InkEvent.observe(elm, 'mousemove', Ink.bindEvent(this._onMouseMove, this));\n\n            this.root = root;\n            this.element = elm;\n            this._delayTimeout = null;\n            this.tooltip = null;\n\n            Common.registerInstance(this, this.element);\n        },\n        _makeTooltip: function (mousePosition) {\n            if (!this._getOpt('text') &&\n                    !this._getOpt('html') &&\n                    !InkElement.hasAttribute(this.element, 'title')) {\n                return false;\n            }\n\n            var tooltip = this._createTooltipElement();\n\n            if (this.tooltip) {\n                this._removeTooltip();\n            }\n\n            this.tooltip = tooltip;\n\n            this._fadeInTooltipElement(tooltip);\n            this._placeTooltipElement(tooltip, mousePosition);\n\n            InkEvent.observe(tooltip, 'mouseover', Ink.bindEvent(this._onTooltipMouseOver, this));\n\n            var timeout = this._getFloatOpt('timeout');\n            if (timeout) {\n                setTimeout(Ink.bind(function () {\n                    if (this.tooltip === tooltip) {\n                        this._removeTooltip();\n                    }\n                }, this), timeout * 1000);\n            }\n        },\n        _createTooltipElement: function () {\n            var template = this._getOpt('template'),  // User template instead of our HTML\n                templatefield = this._getOpt('templatefield'),\n                \n                tooltip,  // The element we float\n                field;  // Element where we write our message. Child or same as the above\n\n            if (template) {  // The user told us of a template to use. We copy it.\n                var temp = document.createElement('DIV');\n                temp.innerHTML = Common.elOrSelector(template, 'options.template').outerHTML;\n                tooltip = temp.firstChild;\n                \n                if (templatefield) {\n                    field = Selector.select(templatefield, tooltip);\n                    if (field) {\n                        field = field[0];\n                    } else {\n                        throw 'options.templatefield must be a valid selector within options.template';\n                    }\n                } else {\n                    field = tooltip;  // Assume same element if user did not specify a field\n                }\n            } else {  // We create the default structure\n                tooltip = document.createElement('DIV');\n                Css.addClassName(tooltip, 'ink-tooltip');\n                Css.addClassName(tooltip, this._getOpt('color'));\n\n                field = document.createElement('DIV');\n                Css.addClassName(field, 'content');\n\n                tooltip.appendChild(field);\n            }\n            \n            if (this._getOpt('html')) {\n                field.innerHTML = this._getOpt('html');\n            } else if (this._getOpt('text')) {\n                InkElement.setTextContent(field, this._getOpt('text'));\n            } else {\n                InkElement.setTextContent(field, this.element.getAttribute('title'));\n            }\n            tooltip.style.display = 'block';\n            tooltip.style.position = 'absolute';\n            tooltip.style.zIndex = this._getIntOpt('zIndex');\n\n            return tooltip;\n        },\n        _fadeInTooltipElement: function (tooltip) {\n            var fadeTime = this._getFloatOpt('fade');\n            if (transitionDurationName && fadeTime) {\n                tooltip.style.opacity = '0';\n                tooltip.style[transitionDurationName] = fadeTime + 's';\n                tooltip.style[transitionPropertyName] = 'opacity';\n                tooltip.style[transitionTimingFunctionName] = 'ease-in-out';\n                setTimeout(function () {\n                    tooltip.style.opacity = '1';\n                }, 0); // Wait a tick\n            }\n        },\n        _placeTooltipElement: function (tooltip, mousePosition) {\n            var where = this._getOpt('where');\n\n            if (where === 'mousemove' || where === 'mousefix') {\n                var mPos = mousePosition;\n                this._setPos(mPos[0], mPos[1]);\n                body.appendChild(tooltip);\n            } else if (where.match(/(up|down|left|right)/)) {\n                body.appendChild(tooltip);\n                var targetElementPos = InkElement.offset(this.element);\n                var tleft = targetElementPos[0],\n                    ttop = targetElementPos[1];\n\n                var centerh = (InkElement.elementWidth(this.element) / 2) - (InkElement.elementWidth(tooltip) / 2),\n                    centerv = (InkElement.elementHeight(this.element) / 2) - (InkElement.elementHeight(tooltip) / 2);\n                var spacing = this._getIntOpt('spacing');\n\n                var tooltipDims = InkElement.elementDimensions(tooltip);\n                var elementDims = InkElement.elementDimensions(this.element);\n\n                var maxX = InkElement.scrollWidth() + InkElement.viewportWidth();\n                var maxY = InkElement.scrollHeight() + InkElement.viewportHeight();\n                \n                where = this._getWhereValueInsideViewport(where, {\n                    left: tleft - tooltipDims[0],\n                    right: tleft + tooltipDims[0],\n                    top: ttop + tooltipDims[1],\n                    bottom: ttop + tooltipDims[1]\n                }, {\n                    right: maxX,\n                    bottom: maxY\n                });\n                \n                if (where === 'up') {\n                    ttop -= tooltipDims[1];\n                    ttop -= spacing;\n                    tleft += centerh;\n                } else if (where === 'down') {\n                    ttop += elementDims[1];\n                    ttop += spacing;\n                    tleft += centerh;\n                } else if (where === 'left') {\n                    tleft -= tooltipDims[0];\n                    tleft -= spacing;\n                    ttop += centerv;\n                } else if (where === 'right') {\n                    tleft += elementDims[0];\n                    tleft += spacing;\n                    ttop += centerv;\n                }\n                \n                var arrow = null;\n                if (where.match(/(up|down|left|right)/)) {\n                    arrow = document.createElement('SPAN');\n                    Css.addClassName(arrow, 'arrow');\n                    Css.addClassName(arrow, this._oppositeDirections[where]);\n                    tooltip.appendChild(arrow);\n                }\n\n                var tooltipLeft = tleft;\n                var tooltipTop = ttop;\n\n                var toBottom = (tooltipTop + tooltipDims[1]) - maxY;\n                var toRight = (tooltipLeft + tooltipDims[0]) - maxX;\n                var toLeft = 0 - tooltipLeft;\n                var toTop = 0 - tooltipTop;\n\n                if (toBottom > 0) {\n                    if (arrow) { arrow.style.top = (tooltipDims[1] / 2) + toBottom + 'px'; }\n                    tooltipTop -= toBottom;\n                } else if (toTop > 0) {\n                    if (arrow) { arrow.style.top = (tooltipDims[1] / 2) - toTop + 'px'; }\n                    tooltipTop += toTop;\n                } else if (toRight > 0) {\n                    if (arrow) { arrow.style.left = (tooltipDims[0] / 2) + toRight + 'px'; }\n                    tooltipLeft -= toRight;\n                } else if (toLeft > 0) {\n                    if (arrow) { arrow.style.left = (tooltipDims[0] / 2) - toLeft + 'px'; }\n                    tooltipLeft += toLeft;\n                }\n\n                tooltip.style.left = tooltipLeft + 'px';\n                tooltip.style.top = tooltipTop + 'px';\n            }\n        },\n\n        /**\n         * Get a value for \"where\" (left/right/up/down) which doesn't put the\n         * tooltip off the screen\n         *\n         * @method _getWhereValueInsideViewport\n         * @param where {String} \"where\" value which was given by the user and we might change\n         * @param bbox {BoundingBox} A bounding box like what you get from getBoundingClientRect ({top, bottom, left, right}) with pixel positions from the top left corner of the viewport.\n         * @param viewport {BoundingBox} Bounding box for the viewport. \"top\" and \"left\" are omitted because these coordinates are relative to the top-left corner of the viewport so they are zero.\n         *\n         * @TODO: we can't use getBoundingClientRect in this case because it returns {0,0,0,0} on our uncreated tooltip.\n         */\n        _getWhereValueInsideViewport: function (where, bbox, viewport) {\n            if (where === 'left' && bbox.left < 0) {\n                return 'right';\n            } else if (where === 'right' && bbox.right > viewport.right) {\n                return 'left';\n            } else if (where === 'up' && bbox.top < 0) {\n                return 'down';\n            } else if (where === 'down' && bbox.bottom > viewport.bottom) {\n                return 'up';\n            }\n\n            return where;\n        },\n        _removeTooltip: function() {\n            var tooltip = this.tooltip;\n            if (!tooltip) {return;}\n\n            var remove = Ink.bind(InkElement.remove, {}, tooltip);\n\n            if (this._getOpt('where') !== 'mousemove' && transitionDurationName) {\n                tooltip.style.opacity = 0;\n                // remove() will operate on correct tooltip, although this.tooltip === null then\n                setTimeout(remove, this._getFloatOpt('fade') * 1000);\n            } else {\n                remove();\n            }\n            this.tooltip = null;\n        },\n        _getOpt: function (option) {\n            var dataAttrVal = InkElement.data(this.element)[InkElement._camelCase('tip-' + option)];\n            if (dataAttrVal /* either null or \"\" may signify the absense of this attribute*/) {\n                return dataAttrVal;\n            }\n            var instanceOption = this.root.options[option];\n            if (typeof instanceOption !== 'undefined') {\n                return instanceOption;\n            }\n        },\n        _getIntOpt: function (option) {\n            return parseInt(this._getOpt(option), 10);\n        },\n        _getFloatOpt: function (option) {\n            return parseFloat(this._getOpt(option), 10);\n        },\n        _destroy: function () {\n            if (this.tooltip) {\n                InkElement.remove(this.tooltip);\n            }\n            this.root = null;  // Cyclic reference = memory leaks\n            this.element = null;\n            this.tooltip = null;\n        },\n        _onMouseOver: function(e) {\n            // on IE < 10 you can't access the mouse event not even a tick after it fired\n            var mousePosition = this._getMousePosition(e);\n            var delay = this._getFloatOpt('delay');\n            if (delay) {\n                this._delayTimeout = setTimeout(Ink.bind(function () {\n                    if (!this.tooltip) {\n                        this._makeTooltip(mousePosition);\n                    }\n                    this._delayTimeout = null;\n                }, this), delay * 1000);\n            } else {\n                this._makeTooltip(mousePosition);\n            }\n        },\n        _onMouseMove: function(e) {\n            if (this._getOpt('where') === 'mousemove' && this.tooltip) {\n                var mPos = this._getMousePosition(e);\n                this._setPos(mPos[0], mPos[1]);\n            }\n        },\n        _onMouseOut: function () {\n            if (!this._getIntOpt('forever')) {\n                this._removeTooltip();\n            }\n            if (this._delayTimeout) {\n                clearTimeout(this._delayTimeout);\n                this._delayTimeout = null;\n            }\n        },\n        _onTooltipMouseOver: function () {\n            if (this.tooltip) {  // If tooltip is already being removed, this has no effect\n                this._removeTooltip();\n            }\n        },\n        _setPos: function(left, top) {\n            left += this._getIntOpt('left');\n            top += this._getIntOpt('top');\n            var pageDims = this._getPageXY();\n            if (this.tooltip) {\n                var elmDims = [InkElement.elementWidth(this.tooltip), InkElement.elementHeight(this.tooltip)];\n                var scrollDim = this._getScroll();\n\n                if((elmDims[0] + left - scrollDim[0]) >= (pageDims[0] - 20)) {\n                    left = (left - elmDims[0] - this._getIntOpt('left') - 10);\n                }\n                if((elmDims[1] + top - scrollDim[1]) >= (pageDims[1] - 20)) {\n                    top = (top - elmDims[1] - this._getIntOpt('top') - 10);\n                }\n\n                this.tooltip.style.left = left + 'px';\n                this.tooltip.style.top = top + 'px';\n            }\n        },\n        _getPageXY: function() {\n            var cWidth = 0;\n            var cHeight = 0;\n            if( typeof( window.innerWidth ) === 'number' ) {\n                cWidth = window.innerWidth;\n                cHeight = window.innerHeight;\n            } else if( document.documentElement && ( document.documentElement.clientWidth || document.documentElement.clientHeight ) ) {\n                cWidth = document.documentElement.clientWidth;\n                cHeight = document.documentElement.clientHeight;\n            } else if( document.body && ( document.body.clientWidth || document.body.clientHeight ) ) {\n                cWidth = document.body.clientWidth;\n                cHeight = document.body.clientHeight;\n            }\n            return [parseInt(cWidth, 10), parseInt(cHeight, 10)];\n        },\n        _getScroll: function() {\n            var dd = document.documentElement, db = document.body;\n            if (dd && (dd.scrollLeft || dd.scrollTop)) {\n                return [dd.scrollLeft, dd.scrollTop];\n            } else if (db) {\n                return [db.scrollLeft, db.scrollTop];\n            } else {\n                return [0, 0];\n            }\n        },\n        _getMousePosition: function(e) {\n            return [parseInt(InkEvent.pointerX(e), 10), parseInt(InkEvent.pointerY(e), 10)];\n        }\n    };\n\n    return Tooltip;\n});\n","/**\n * Elements in a tree structure\n * @module Ink.UI.TreeView_1\n * @version 1\n */\nInk.createModule('Ink.UI.TreeView', '1', ['Ink.UI.Common_1','Ink.Dom.Event_1','Ink.Dom.Css_1','Ink.Dom.Element_1','Ink.Dom.Selector_1','Ink.Util.Array_1'], function(Common, Event, Css, Element, Selector, InkArray ) {\n    'use strict';\n\n\n    /**\n     * Shows elements in a tree structure which can be expanded and contracted.\n     * A TreeView is built with \"node\"s and \"children\". \"node\"s are `li` tags, and \"children\" are `ul` tags.\n     * You can build your TreeView out of a regular UL and  LI element structure which you already use to display lists with several levels.\n     * If you want a node to be open when the TreeView is built, just add the data-open=\"true\" attribute to it.\n     * \n     * @class Ink.UI.TreeView\n     * @constructor\n     * @version 1\n     * @param {String|DOMElement}   selector                    Element or selector.\n     * @param {String}              [options]                   Options object, containing:\n     * @param {String}              [options.node]              Selector for the nodes. Defaults to 'li'.\n     * @param {String}              [options.children]          Selector for the children. Defaults to 'ul'.\n     * @param {String}              [options.parentClass]       CSS classes to be added to parent nodes. Defaults to 'parent'.\n     * @param {String}              [options.openClass]         CSS classes to be added to the icon when a parent is open. Defaults to 'fa fa-minus-circle'.\n     * @param {String}              [options.closedClass]       CSS classes to be added to the icon when a parent is closed. Defaults to 'fa fa-plus-circle'.\n     * @param {String}              [options.hideClass]         CSS Class to toggle visibility of the children. Defaults to 'hide-all'.\n     * @param {String}              [options.iconTag]           The name of icon tag. The component tries to find a tag with that name as a direct child of the node. If it doesn't find it, it creates it. Defaults to 'i'.\n     * @param {Boolean}             [options.stopDefault]       Flag to stops the default behavior of the click handler. Defaults to true.\n     * @example\n     *      <ul class=\"ink-tree-view\">\n     *        <li data-open=\"true\"><a href=\"#\">root</a>\n     *          <ul>\n     *            <li><a href=\"#\">child 1</a></li>\n     *            <li><a href=\"#\">child 2</a>\n     *              <ul>\n     *                <li><a href=\"#\">grandchild 2a</a></li>\n     *                <li><a href=\"#\">grandchild 2b</a>\n     *                  <ul>\n     *                    <li><a href=\"#\">grandgrandchild 1bA</a></li>\n     *                    <li><a href=\"#\">grandgrandchild 1bB</a></li>\n     *                  </ul>\n     *                </li>\n     *              </ul>\n     *            </li>\n     *            <li><a href=\"#\">child 3</a></li>\n     *          </ul>\n     *        </li>\n     *      </ul>\n     *      <script>\n     *          Ink.requireModules( ['Ink.Dom.Selector_1','Ink.UI.TreeView_1'], function( Selector, TreeView ){\n     *              var treeViewElement = Ink.s('.ink-tree-view');\n     *              var treeViewObj = new TreeView( treeViewElement );\n     *          });\n     *      </script>\n     * \n     * @sample Ink_UI_TreeView_1.html\n     */\n    function TreeView() {\n        Common.BaseUIComponent.apply(this, arguments);\n    }\n\n    TreeView._name = 'TreeView_1';\n\n    TreeView._optionDefinition = {\n        'node':   ['String', 'li'],\n        // [3.0.1] Deprecate this terrible, terrible name\n        'child':  ['String',null],\n        'children':  ['String','ul'],\n        'parentClass': ['String','parent'],\n        'openNodeClass': ['String', 'open'],\n        'openClass': ['String','fa fa-minus-circle'],\n        'closedClass': ['String','fa fa-plus-circle'],\n        'hideClass': ['String','hide-all'],\n        'iconTag': ['String', 'i'],\n        'stopDefault' : ['Boolean', true]\n    };\n\n    TreeView.prototype = {\n        /**\n         * Init function called by the constructor. Sets the necessary event handlers.\n         * \n         * @method _init\n         * @private\n         */\n        _init: function(){\n            if (this._options.child) {\n                Ink.warn('Ink.UI.TreeView: options.child is being renamed to options.children.');\n                this._options.children = this._options.child;\n            }\n\n            this._handlers = {\n                click: Ink.bindEvent(this._onClick,this)\n            };\n\n            Event.on(this._element, 'click', this._options.node, this._handlers.click);\n\n            InkArray.each(Ink.ss(this._options.node, this._element), Ink.bind(function(item){\n                if( this.isParent(item) ) {\n                    Css.addClassName(item, this._options.parentClass);\n\n                    var isOpen = this.isOpen(item);\n                    if( !this._getIcon(item) ){\n                        Element.create(this._options.iconTag, { insertTop: item });\n                    }\n\n                    this._setNodeOpen(item, isOpen);\n                }\n            },this));\n        },\n\n        _getIcon: function (node) {\n            return Ink.s('> ' + this._options.iconTag, node);\n        },\n\n        /**\n         * Checks if a node is open.\n         *\n         * @method isOpen\n         * @param {DOMElement} node  The tree node to check\n         **/\n        isOpen: function (node) {\n            if (!this._getChild(node)) {\n                throw new Error('not a node!');\n            }\n\n            return Element.data(node).open === 'true' ||\n                Css.hasClassName(node, this._options.openNodeClass);\n        },\n\n        /**\n         * Checks if a node is a parent.\n         *\n         * @method isParent\n         * @param {DOMElement} node     Node to check\n         **/\n        isParent: function (node) {\n            return Css.hasClassName(node, this._options.parentClass) ||\n                this._getChild(node) != null;\n        },\n\n        _setNodeOpen: function (node, beOpen) {\n            var child = this._getChild(node);\n            if (child) {\n                Css.setClassName(child, this._options.hideClass, !beOpen);\n                var icon = this._getIcon(node);\n\n                node.setAttribute('data-open', beOpen);\n\n                /*\n                 * Don't refactor this to\n                 *\n                 * setClassName(el, className, status); setClassName(el, className, !status);\n                 *\n                 * because it won't work with multiple classes.\n                 *\n                 * Doing:\n                 * setClassName(el, 'fa fa-whatever', true);setClassName(el, 'fa fa-whatever-else', false);\n                 *\n                 * will remove 'fa' although it is a class we want.\n                 */\n\n                var toAdd = beOpen ? this._options.openClass : this._options.closedClass;\n                var toRemove = beOpen ? this._options.closedClass : this._options.openClass;\n                Css.removeClassName(icon, toRemove);\n                Css.addClassName(icon, toAdd);\n\n                Css.setClassName(node, this._options.openNodeClass, beOpen);\n            } else {\n                Ink.error('Ink.UI.TreeView: node', node, 'is not a node!');\n            }\n        },\n\n        /**\n         * Opens one of the tree nodes\n         *\n         * Make sure you pass the node's DOMElement\n         * @method open\n         * @param {DOMElement} node     The node you wish to open.\n         **/\n        open: function (node) {\n            this._setNodeOpen(node, true);\n        },\n\n        /**\n         * Closes one of the tree nodes\n         *\n         * Make sure you pass the node's DOMElement\n         * @method close\n         * @param {DOMElement} node     The node you wish to close.\n         **/\n        close: function (node) {\n            this._setNodeOpen(node, false);\n        },\n\n        /**\n         * Toggles a node state\n         *\n         * @method toggle\n         * @param {DOMElement} node     The node to toggle.\n         **/\n        toggle: function (node) {\n            if (this.isOpen(node)) {\n                this.close(node);\n            } else {\n                this.open(node);\n            }\n        },\n\n        _getChild: function (node) {\n            return Selector.select(this._options.children, node)[0] || null;\n        },\n\n        /**\n         * Handles the click event (as specified in the _init function).\n         * \n         * @method _onClick\n         * @param {Event} event\n         * @private\n         */\n        _onClick: function(ev){\n            /**\n             * Summary:\n             * If the clicked element is a \"node\" as defined in the options, will check if it has any \"child\".\n             * If so, will toggle its state and stop the event's default behavior if the stopDefault option is true.\n             **/\n\n            if (!this.isParent(ev.currentTarget) ||\n                    Selector.matchesSelector(ev.target, this._options.node) ||\n                    Selector.matchesSelector(ev.target, this._options.children)) {\n                return;\n            }\n\n            if (this._options.stopDefault){\n                ev.preventDefault();\n            }\n\n            this.toggle(ev.currentTarget);\n        }\n    };\n\n    Common.createUIComponent(TreeView);\n\n    return TreeView;\n});\n","Ink.createModule('Ink.UI.Upload', '1', [\n    'Ink.Dom.Event_1',\n    'Ink.Dom.Element_1',\n    'Ink.Dom.Browser_1',\n    'Ink.UI.Common_1'\n], function(Event, Element, Browser, Common) {\n    'use strict';\n\n    var DirectoryReader = function(options) {\n        this.init(options);\n    };\n\n    DirectoryReader.prototype = {\n        init: function(options) {\n            this._options = Ink.extendObj({\n                entry:      undefined,\n                maxDepth:   10\n            }, options || {});\n\n            try {\n                this._read();\n            } catch(e) {\n                Ink.error(e);\n            }\n        },\n\n\n        _read: function() {\n            if(!this._options.entry) {\n                Ink.error('You must specify the entry!');\n                return;\n            }\n\n            try {\n                this._readDirectories();\n            } catch(e) {\n                Ink.error(e);\n            }\n        },\n\n\n        _readDirectories: function() {\n            var entries         = [],\n                running         = false,\n                maxDepth        = 0;\n\n            /* TODO return as tree because much better well */\n            var _readEntries = Ink.bind(function(currentEntry) {\n                var dir     = currentEntry.createReader();\n                    running = true;\n\n                dir.readEntries(Ink.bind(function(res) {\n                    if(res.length > 0) {\n                        for(var i = 0, len = res.length; i<len; i++) {\n                            entries.push(res[i]);\n                            if(!res[i].isDirectory) {\n                                continue;\n                            }\n                            maxDepth = this.clearArray(res[i].fullPath.split('/'));\n                            maxDepth.shift();\n                            maxDepth = maxDepth.length;\n                            if(maxDepth <= this._options.maxDepth) {\n                                _readEntries(res[i]);\n                            }\n                        }\n                        if(this._stopActivityTimeout) {\n                            clearTimeout(this._stopActivityTimeout);\n                        }\n                        this._stopActivityTimeout = setTimeout(function() {\n                            running = false;\n                        }, 250);\n                    }\n                    if(!res.length) {\n                        running = false;\n                    }\n                }, this), Ink.bind(function(err) {\n                    this._options.readError(err, currentEntry);\n                }, this));\n            }, this);\n\n            _readEntries(this._options.entry);\n\n            var activity;\n            var checkActivity = function() {\n                if(running) {\n                    return false;\n                }\n                clearInterval(activity);\n                if(this._options.readComplete && typeof this._options.readComplete === 'function') {\n                    this._options.readComplete(entries);\n                }\n                return true;\n            };\n\n            activity = setInterval(Ink.bind(checkActivity, this), 250);\n        },\n\n\n        clearArray: function(arr) {\n            for(var i = arr.length - 1; i>=0; i--) {\n                if(typeof(arr[i]) === 'undefined' || arr[i] === null || arr[i] === '') {\n                    arr.splice(i, 1);\n                }\n            }\n            return arr;\n        }\n    };\n\n    var Queue = {\n        lists:  [],\n        items:  [],\n\n\n        /**\n         * Create new queue list\n         * @function create\n         * @public\n         * @param {String} list name\n         * @param {Function} function to iterate on items\n         * @return {Object} list id\n        */\n        create: function(name) {\n            var id;\n                name = String(name);\n            this.lists.push({name: name});\n            id = this.lists.length - 1;\n            return id;\n        },\n\n\n        getItems: function(parentId) {\n            if(!parentId) {\n                return this.items;\n            }\n            var items = [];\n            for(var i = 0, len = this.items.length; i<len; i++) {\n                if(this.items[i].parentId === parentId) {\n                    items.push(this.items[i]);\n                }\n            }\n\n            return items;\n        },\n\n\n        /**\n         * Delete list\n         * @function purge\n         * @public\n         * @param {String} List name\n         * @return {Object} removed list\n        */\n        purge: function(id, keepList) {\n            if(typeof(id) !== 'number' || isNaN(Number(id))) {\n                return false;\n            }\n            try {\n                for(var i = this.items.length; i>=0; i--) {\n                    if(this.items[i] && id === this.items[i].parentId) {\n                        this.remove(this.items[i].parentId, this.items[i].pid);\n                    }\n                }\n                if(!keepList) {\n                    this.lists.splice(id, 1);\n                }\n                return true;\n            } catch(e) {\n                Ink.error('Purge: invalid id');\n                return false;\n            }\n        },\n\n\n        /**\n         * add an item to a list\n         * @function add\n         * @public\n         * @param {String} name\n         * @param {Object} item\n         * @return {Number} pid\n        */\n        add: function(parentId, item, priority) {\n            if(!this.lists[parentId]) {\n                return false;\n            }\n            if(typeof(item) !== 'object') {\n                item = String(item);\n            }\n\n            var pid = parseInt(Math.round(Math.random() * 100000) + \"\" + Math.round(Math.random() * 100000), 10);\n            priority    = priority || 0;\n\n            this.items.push({parentId: parentId, item: item, priority: priority || 0, pid: pid});\n            return pid;\n        },\n\n\n        /**\n         * View list\n         * @function view\n         * @public\n         * @param {Number} list id\n         * @param {Number} process id\n         * @return {Object} item\n        */\n        view: function(parentId, pid) {\n            var id = this._searchByPid(parentId, pid);\n            if(id === false) {\n                return false;\n            }\n            return this.items[id];\n        },\n\n\n        /**\n         * Remove an item\n         * @function remove\n         * @public\n         * @param {Object} item\n         * @return {Object|Boolean} removed item or false if not found\n        */\n        remove: function(parentId, pid) {\n            try {\n                var id = this._searchByPid(parentId, pid);\n                if(id === false) {\n                    return false;\n                }\n                this.items.splice(id, 1);\n                return true;\n            } catch(e) {\n                Ink.error('Remove: invalid id');\n                return false;\n            }\n        },\n\n        _searchByPid: function(parentId, pid) {\n            if(!parentId && typeof(parentId) === 'boolean' || !pid) {\n                return false;\n            }\n\n            parentId    = parseInt(parentId, 10);\n            pid         = parseInt(pid, 10);\n\n            if(isNaN(parentId) || isNaN(pid)) {\n                return false;\n            }\n\n            for(var i = 0, len = this.items.length; i<len; i++) {\n                if(this.items[i].parentId === parentId && this.items[i].pid === pid) {\n                    return i;\n                }\n            }\n            return false;\n        }\n    };\n\n    var UI = function(Upload) {\n        this.Upload = Upload;\n        this.init();\n    };\n\n    UI.prototype = {\n        init: function() {\n            this._fileButton = this.Upload._options.fileButton;\n            this._dropzone = this.Upload._options.dropzone;\n            this._setDropEvent();\n            this._setFileButton();\n        },\n\n\n        _setDropEvent: function() {\n            var dropzones = this._dropzone;\n            if (!dropzones) { return; }\n\n            for(var i = 0, len = dropzones.length; i<len; i++) {\n                dropzones[i].ondrop        = Ink.bindEvent(this.Upload._dropEventHandler, this.Upload);\n                dropzones[i].ondragleave   = Ink.bindEvent(this._onDragLeave, this);\n                dropzones[i].ondragend     = Ink.bindEvent(this._onDragEndEventHandler, this);\n                dropzones[i].ondragdrop    = Ink.bindEvent(this._onDragEndEventHandler, this);\n                dropzones[i].ondragenter   = Ink.bindEvent(this._onDragEnterHandler, this);\n                dropzones[i].ondragover    = Ink.bindEvent(this._onDragOverHandler, this);\n            }\n        },\n\n\n        _onDragEnterHandler: function(ev) {\n            if(ev && ev.stopPropagation) {\n                ev.stopPropagation();\n            }\n            if(ev && ev.preventDefault) {\n                ev.preventDefault();\n            }\n            if(ev) {\n                ev.returnValue = false;\n            }\n\n            this.Upload.publish('DragEnter', ev);\n            return false;\n        },\n\n\n        _onDragOverHandler: function(ev) {\n            if(!ev) {\n                return false;\n            }\n            ev.preventDefault();\n            ev.stopPropagation();\n            ev.returnValue = false;\n            return true;\n        },\n\n\n        _onDragLeave: function(ev) {\n            return this.Upload.publish('DragLeave', ev);\n        },\n\n\n        _onDragEndEventHandler: function(ev) {\n            return this.Upload.publish('DragEnd', ev);\n        },\n\n\n        _setFileButton: function() {\n            var btns = this._fileButton;\n            if (!btns) { return; }\n            Event.observeMulti(btns, 'change', Ink.bindEvent(this._fileChangeHandler, this));\n        },\n\n\n        _fileChangeHandler: function(ev) {\n            var btn = Event.element(ev);\n            var files = btn.files;\n            var form = Element.findUpwardsByTag(btn, 'form');\n\n            if(!files || !window.FormData || !('withCredentials' in new XMLHttpRequest())) {\n                form.parentNode.submit();\n                return false;\n            }\n            this.Upload._addFilesToQueue(files);\n            btn.value = \"\";\n        }\n    };\n\n\n\n\n\n\n    var Upload = function(options) {\n        this.Queue = Queue;\n        this.init(options);\n        this._events = {};\n    };\n\n    Upload.prototype = {\n        //_events: {},\n        \n        /**\n         * This component is used to enable HTML5 upload on forms easily. It\n         * evens out differences between browsers which support HTML5 upload,\n         * and supports chunked uploads and directory tree uploads.\n         *\n         * Choose a drop zone and/or a file input. When the user drops the file\n         * on the drop zone element, or chooses it using the file input,\n         * Ink.UI.Upload takes care of uploading it through AJAX POST.\n         *\n         * The name given to the file in the POST request's data is chosen\n         * through the `fileFormName` option.\n         *\n         * On the server side, you will receive a POST with a Content-type of\n         * `multipart/form-data` or `x-www-form/urlencoded` if `useChunks`\n         * is `true`.\n         *\n         * @class Ink.UI.Upload_1\n         * @constructor\n         *\n         * @param options {Object} Options hash, containing:\n         * @param [options.dropzone] {Element} Element where the user can drop files onto.\n         * @param [options.fileButton] {Element} An `input[type=\"file\"]` for the user to choose a file using a native dialog.\n         * @param [options.fileFormName='Ink_Filelist'] The name of the file in the POST request.\n         * @param [options.endpoint=window.location] The URL where we're POSTing the files to. Defaults to the current location, like a HTML form.\n         * @param [options.maxFileSize] Maximum file size in bytes. Defaults to 300mb.\n         * @param [INVALID_FILE_NAME] A regular expression to invalidate file names. For example, set this to `/\\.png$/` if you don't want files with the \".png\" extension. Remember that file extensions are just hints!\n         * @param [options.extraData] Add more data to your POST request. Each key in this hash gets added to the form data sent to the server.\n         * TODO chunk options, also write a bit above about chunking and the serverside of chunking.\n         * TODO directory options, also write a bit above about directories and the server end of directories.\n         */\n        init: function(options) {\n            if (typeof options === 'string') {\n                options = Element.data(Common.elOrSelector(options, '1st argument'));\n            }\n            this._options = Ink.extendObj({\n                dropzone:           undefined,\n                fileButton:         undefined,\n                fileFormName:       'Ink_Filelist',  // TODO default to fileButton's [name] if available.\n                endpoint:           '',\n                maxFilesize:        300 << 20, //300mb\n                INVALID_FILE_NAME:  undefined,\n                extraData:          {},\n                // Chunks\n                useChunks:          false,\n                chunkSize:          4194304,  // 4MB\n                minSizeToUseChunks: 20971520, // 20mb\n                endpointChunk:      '',  // Where to send chunk data.\n                endpointChunkCommit:'',  // Where to send the \"chunk transaction\" commit.\n                // Directory trees\n                foldersEnabled:     false,\n                directoryMaxDepth:  10\n            }, options || {});\n\n            this._queueId           = Queue.create('Ink_UPLOAD');\n            this._queueRunning      = false;\n            this._folders           = {};\n\n\n            if(this._options.dropzone) {\n                this._options.dropzone =\n                    Common.elsOrSelector(this._options.dropzone, 'Ink.UI.Upload - dropzone');\n            }\n\n            if(this._options.fileButton) {\n                this._options.fileButton =\n                    Common.elsOrSelector(this._options.fileButton, 'Ink.UI.Upload - fileButton');\n            }\n\n            if(!this._options.dropzone && !this._options.fileButton) {\n                throw new TypeError(\n                    'Ink.UI.Upload: Specify a fileButton or a Dropzone!');\n            }\n\n            new UI(this);\n        },\n\n\n        _supportChunks: function(size) {\n            return this._options.useChunks &&\n                    'Blob' in window &&\n                    (new Blob()).slice &&\n                    size > this._options.minSizeToUseChunks;\n        },\n\n\n        _dropEventHandler: function(ev) {\n            Event.stop(ev);\n\n            this.publish('DropComplete', ev.dataTransfer);\n\n            var data = ev.dataTransfer;\n\n            if(!data || !data.files || !data.files.length) {\n                return false;\n            }\n\n            this._files = data.files;\n            this._files = Array.prototype.slice.call(this._files || [], 0);\n\n            // check if webkitGetAsEntry exists on first item\n            if(data.items && data.items[0] && data.items[0].webkitGetAsEntry) {\n                if(!this._options.foldersEnabled) {\n                    return setTimeout(Ink.bind(this._addFilesToQueue, this, this._files), 0);\n                }\n                var entry, folders = [];\n                for(var i = ev.dataTransfer.items.length-1; i>=0; i--) {\n                    entry = ev.dataTransfer.items[i].webkitGetAsEntry();\n                    if(entry && entry.isDirectory) {\n                        folders.push(entry);\n                        this._files[i].isDirectory = true;\n                        this._files.splice(i, 1);\n                    }\n                }\n                // starting callback hell\n                this._addFolderToQueue(folders, Ink.bind(function() {\n                    setTimeout(Ink.bind(this._addFilesToQueue, this, this._files), 0);\n                }, this));\n            } else {\n                setTimeout(Ink.bind(this._addFilesToQueue, this, this._files), 0);\n            }\n\n            return true;\n        },\n\n\n        _addFolderToQueue: function(folders, cb) {\n            var files = [], invalidFolders = {};\n\n            if(!folders || !folders.length) {\n                cb();\n                return files;\n            }\n\n            var getFiles = function(entries) {\n                var files = [];\n                for(var i = 0, len = entries.length; i<len; i++) {\n                    if(entries[i].isFile) {\n                        files.push(entries[i]);\n                    }\n                }\n                return files;\n            };\n\n            var convertToFile = function(cb, index) {\n                var fullPath;\n                index = index || 0;\n                if(!this._files[index]) {\n                    cb();\n                    return files;\n                }\n                if(this._files[index].constructor.name.toLowerCase() !== 'fileentry') {\n                    return convertToFile.apply(this, [cb, ++index]);\n                }\n                this._files[index].file(Ink.bind(function(res) {\n                    fullPath = this._files[index].fullPath; // bug\n                    this._files[index]              = res;\n                    this._files[index].hasParent    = true;\n\n                    // if browser don't have it natively, set it\n                    if(!this._files[index].fullPath) {\n                        this._files[index].fullPath = fullPath;\n                    }\n                    convertToFile.apply(this, [cb, ++index]);\n                }, this), Ink.bind(function() {\n                    this._files.splice(index, 1);\n                    convertToFile.apply(this, [cb, index]);\n                }, this));\n            };\n\n            var getSubDirs = Ink.bind(function(index) {\n                if(!folders[index]) {\n                    this._files = this._files.concat(files);\n                    convertToFile.call(this, cb);\n                    return false;\n                }\n\n                new DirectoryReader({\n                    entry:      folders[index],\n                    maxDepth:   this._options.directoryMaxDepth,\n                    readComplete: Ink.bind(function(entries) {\n                        files = files.concat(getFiles(entries));\n                        // adding root dirs\n                        if(!folders[index] || folders[index].fullPath in this._folders) {\n                            return;\n                        }\n\n                        this._folders[folders[index].fullPath] = {\n                            items:      entries,\n                            files:      files,\n                            length:     entries.length,\n                            created:    false,\n                            root:       true\n                        };\n\n                        // adding sub dirs\n                        for(var i = 0, len = entries.length; i<len; i++) {\n                            if(entries[i].isFile) {\n                                continue;\n                            }\n                            if(entries[i].fullPath in invalidFolders) {\n                                delete invalidFolders[entries[i].fullPath];\n                                continue;\n                            }\n                            this._folders[entries[i].fullPath] = {\n                                created:    false,\n                                root:       false\n                            };\n                        }\n                        getSubDirs(++index);\n                    }, this),\n                    readError: Ink.bind(function(err, dir) {\n                        invalidFolders[dir.fullPath] = {};\n                        invalidFolders[dir.fullPath].error = err;\n                    }, this)\n                });\n            }, this);\n\n            getSubDirs(0);\n            return files;\n        },\n\n\n        _addFilesToQueue: function(files) {\n            var file, fileID, o;\n            for(var i = 0, len = files.length; i<len; i++) {\n                file = files[i];\n\n                if(!file.isDirectory) {\n                    // dirty hack to allow 0B files avoiding folders on GECKO\n                    if(file === null || (!file.type && file.size % 4096 === 0 && (!Browser.CHROME || !this._options.foldersEnabled))) {\n                        this.publish('InvalidFile', file, 'size');\n                        continue;\n                    }\n                }\n\n                if(file.size > this._options.maxFilesize) {\n                    this.publish('MaxSizeFailure', file, this._options.maxFilesize);\n                    continue;\n                }\n\n                fileID = parseInt(Math.round(Math.random() * 100000) + \"\" + Math.round(Math.random() * 100000), 10);\n                o = { id: i, data: file, fileID: fileID, directory: file.isDirectory };\n                Queue.add(this._queueId, o);\n\n                this.publish('FileAddedToQueue', o);\n            }\n            this._processQueue(true);\n            this._files = [];\n        },\n\n\n        _processQueue: function(internalUpload) {\n            if(this._queueRunning) {\n                return false;\n            }\n\n            this.running = 0;\n            var max = 1, i = 0, items,\n                queueLen = Queue.items.length;\n            this._queueRunning = true;\n\n            this.interval = setInterval(Ink.bind(function() {\n                if(Queue.items.length === i && this.running === 0) {\n                    Queue.purge(this._queueId, true);\n                    this._queueRunning = false;\n                    clearInterval(this.interval);\n                    this.publish('QueueEnd', this._queueId, queueLen);\n                }\n\n                items = Queue.getItems(this._queueId);\n\n                if(this.running < max && items[i]) {\n                    if(!items[i].canceled) {\n                        _doRequest.call(this, items[i].pid, items[i].item.data, items[i].item.fileID, items[i].item.directory, internalUpload);\n                        this.running++;\n                        i++;\n                    } else {\n                        var j = i;\n                        while(items[j] && items[j].canceled) {\n                            i++;\n                            j++;\n                        }\n                    }\n                    return true;\n                }\n                return false;\n            }, this), 100);\n\n\n            var _doRequest = function(pid, data, fileID, directory, internalUpload) {\n                var o = {\n                    file:   data,\n                    fileID: fileID,\n                    cb: Ink.bind(function() {\n                        this.running--;\n                    }, this)\n                };\n                if(internalUpload) {\n                    if(directory) {\n                        // do magic\n                        o.cb();\n                    } else {\n                        this._upload(o);\n                    }\n                }\n            };\n\n            return true;\n        },\n\n\n        _upload: function(o) {\n            var file = o.file,\n                xhr = new XMLHttpRequest(),\n                fileID = o.fileID;\n\n            this.publish('BeforeUpload', file, this._options.extraData, fileID, xhr, this._supportChunks(file.size));\n\n            var forceAbort = function(showError) {\n                if(o.cb && typeof(o.cb === 'function')) {\n                    o.cb();\n                }\n\n                this.publish('OnProgress', {\n                    length: file.size,\n                    lengthComputable: true,\n                    loaded: file.size,\n                    total: file.size\n                }, file, fileID);\n                this.publish('EndUpload', file, fileID, (showError ? { error: true } : true));\n                this.publish('InvalidFile', file, 'name');\n                xhr.abort();\n            };\n\n            if(this._options.INVALID_FILE_NAME && this._options.INVALID_FILE_NAME instanceof RegExp) {\n                if(this._options.INVALID_FILE_NAME.test(o.file.name)) {\n                    forceAbort.call(this);\n                    return;\n                }\n            }\n\n            // If file was renamed, abort it\n            // FU OPERA: Opera always return lastModified date as null\n            if(!file.lastModifiedDate && !Ink.Dom.Browser.OPERA) {\n                forceAbort.call(this, true);\n                return;\n            }\n\n            xhr.upload.onprogress = Ink.bind(this.publish, this, 'OnProgress', file, fileID);\n\n            var endpoint, method;\n            if(this._supportChunks(file.size)) {\n                if(file.size <= file.chunk_offset) {\n                    endpoint = this._options.endpointChunkCommit;\n                    method = 'POST';\n                } else {\n                    endpoint = this._options.endpointChunk;\n                    if(file.chunk_upload_id) {\n                        endpoint += '?upload_id=' + file.chunk_upload_id;\n                    }\n                    if(file.chunk_offset) {\n                        endpoint += '&offset=' + file.chunk_offset;\n                    }\n                    method = 'PUT';\n                }\n            } else {\n                endpoint = this._options.endpoint;\n                method = 'POST';\n            }\n\n            xhr.open(method, endpoint, true);\n            xhr.withCredentials = true;\n            xhr.setRequestHeader(\"x-requested-with\", \"XMLHttpRequest\");\n            if(this._supportChunks(file.size)) {\n                xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');\n            }\n\n            var fd = new FormData(),\n                blob;\n\n            if(\"Blob\" in window && typeof Blob === 'function') {\n                blob = new Blob([file], { type: file.type });\n                if(this._supportChunks(file.size)) {\n                    file.chunk_offset = file.chunk_offset || 0;\n                    blob = blob.slice(file.chunk_offset, file.chunk_offset + this._options.chunkSize);\n                } else {\n                    fd.append(this._options.fileFormName, blob, file.name);\n                }\n            } else {\n                fd.append(this._options.fileFormName, file);\n            }\n\n            if(!this._supportChunks(file.size)) {\n                for(var k in this._options.extraData) {\n                    if(this._options.extraData.hasOwnProperty(k)) {\n                        fd.append(k, this._options.extraData[k]);\n                    }\n                }\n            } else {\n                fd.append('upload_id', file.chunk_upload_id);\n                fd.append('path', file.upload_path);\n            }\n\n            if(!file.hasParent) {\n                if(!this._supportChunks(file.size)) {\n                    xhr.send(fd);\n                } else {\n                    if(file.size <= file.chunk_offset) {\n                        xhr.send('upload_id=' + file.chunk_upload_id + '&path=' + file.upload_path + '/' + file.name);\n                    } else {\n                        xhr.send(blob);\n                    }\n                }\n            } else {\n                this.publish('cbCreateFolder', file.parentID, file.fullPath, this._options.extraData, this._folders, file.rootPath, Ink.bind(function() {\n                    if(!this._supportChunks(file.size)) {\n                        xhr.send(fd);\n                    } else {\n                        if(file.size <= file.chunk_offset) {\n                            xhr.send('upload_id=' + file.chunk_upload_id + '&path=' + file.upload_path + '/' + file.name);\n                        } else {\n                            xhr.send(blob);\n                        }\n                    }\n                }, this));\n            }\n\n\n            xhr.onload = Ink.bindEvent(function() {\n                /* jshint boss:true */\n                if(this._supportChunks(file.size) && file.size > file.chunk_offset) {\n                    if(xhr.response) {\n                        var response = JSON.parse(xhr.response);\n\n                        // check expected offset\n                        var invalidOffset = file.chunk_offset && response.offset !== (file.chunk_offset + this._options.chunkSize) && file.size !== response.offset;\n                        if(invalidOffset) {\n                            if(o.cb) {\n                                o.cb();\n                            }\n                            this.publish('ErrorUpload', file, fileID);\n                        } else {\n                            file.chunk_upload_id = response.upload_id;\n                            file.chunk_offset = response.offset;\n                            file.chunk_expires = response.expires;\n                            this._upload(o);\n                        }\n                    } else {\n                        if(o.cb) {\n                            o.cb();\n                        }\n                        this.publish('ErrorUpload', file, fileID);\n                    }\n                    return (xhr = null);\n                }\n\n                if(o.cb) {\n                    o.cb();\n                }\n\n                if(xhr.responseText && xhr['status'] < 400) {\n                    this.publish('EndUpload', file, fileID, xhr.responseText);\n                } else {\n                    this.publish('ErrorUpload', file, fileID);\n                }\n                return (xhr = null);\n            }, this);\n\n\n            xhr.onerror = Ink.bindEvent(function() {\n                if(o.cb) {\n                    o.cb();\n                }\n                this.publish('ErrorUpload', file, fileID);\n            }, this);\n\n            xhr.onabort = Ink.bindEvent(function() {\n                if(o.cb) {\n                    o.cb();\n                }\n                this.publish('AbortUpload', file, fileID, {\n                    abortAll: Ink.bind(this.abortAll, this),\n                    abortOne: Ink.bind(this.abortOne, this)\n                });\n            }, this);\n        },\n\n\n        abortAll: function() {\n            if(!this._queueRunning) {\n                return false;\n            }\n            clearInterval(this.interval);\n            this._queueRunning = false;\n            Queue.purge(this._queueId, true);\n            return true;\n        },\n\n        abortOne: function(id, cb) {\n            var items = Queue.getItems(0),\n                o;\n            for(var i = 0, len = items.length; i<len; i++) {\n                if(items[i].item.fileID === id) {\n                    o = {\n                        id:         items[i].item.fileID,\n                        name:       items[i].item.data.name,\n                        size:       items[i].item.data.size,\n                        hasParent:  items[i].item.data.hasParent\n                    };\n                    Queue.remove(0, items[i].pid);\n                    if(cb) {\n                        cb(o);\n                    }\n                    return true;\n                }\n            }\n            return false;\n        },\n\n\n        subscribe: function(eventName, fn) {\n            if(!this._events[eventName]) {\n                this._events[eventName] = [];\n            }\n            this._events[eventName].push(fn);\n            return this._events[eventName];\n        },\n\n\n        publish: function(eventName) {\n            var events = this._events[eventName],\n                args = Array.prototype.slice.call(arguments || [], 0);\n\n            if(!events) {\n                return;\n            }\n\n            for(var i = 0, len = events.length; i<len; i++) {\n                try {\n                    events[i].apply(this, args.splice(1, args.length));\n                } catch(err) {\n                    Ink.error(eventName + \": \" + err);\n                }\n            }\n        }\n    };\n\n    return Upload;\n});\n"]}